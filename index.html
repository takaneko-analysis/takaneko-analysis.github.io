<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>ãŸã‹ã­ã“ æ¥½æ›²åˆ†æ Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <style>
    :root {
      --pink: #f472b6;
      --pink-light: #fce7f3;
      --pink-dark: #db2777;
      --pink-soft: #fbcfe8;
      --gold: #d4af37;
      --gold-light: #fef9e7;
      --bg: #fff5f9;
      --surface: #ffffff;
      --text: #3d2b35;
      --text-muted: #9d6b8a;
      --border: #fad4e8;
      --radius: 20px;
      --shadow: 0 4px 24px rgba(244,114,182,0.12);
      --shadow-hover: 0 8px 40px rgba(244,114,182,0.22);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Zen Maru Gothic', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      background-image:
        radial-gradient(circle at 20% 20%, rgba(244,114,182,0.08) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(212,175,55,0.06) 0%, transparent 50%);
    }

    /* ========== HEADER ========== */
    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0 24px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 12px rgba(244,114,182,0.08);
    }

    .header-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 64px;
      gap: 16px;
    }

    .logo {
      display: flex;
      flex-direction: column;
      line-height: 1.2;
      flex-shrink: 0;
    }

    .logo-sub {
      font-size: 9px;
      letter-spacing: 2px;
      color: var(--gold);
      font-family: 'DM Mono', monospace;
      text-transform: uppercase;
    }

    .logo-main {
      font-size: 16px;
      font-weight: 700;
      color: var(--pink-dark);
    }

    /* ========== NAV TABS ========== */
    nav {
      display: flex;
      gap: 4px;
    }

    .nav-btn {
      padding: 8px 18px;
      border: 1.5px solid var(--border);
      background: transparent;
      color: var(--text-muted);
      border-radius: 50px;
      cursor: pointer;
      font-family: 'Zen Maru Gothic', sans-serif;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .nav-btn:hover {
      border-color: var(--pink);
      color: var(--pink);
      background: var(--pink-light);
    }

    .nav-btn.active {
      background: var(--pink);
      border-color: var(--pink);
      color: white;
      box-shadow: 0 2px 12px rgba(244,114,182,0.3);
    }

    /* ========== OFFICIAL LINKS ========== */
    .official-links {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
    }

    .link-btn {
      padding: 6px 12px;
      border-radius: 50px;
      text-decoration: none;
      font-size: 11px;
      font-weight: 700;
      color: white;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .link-btn:hover { transform: translateY(-2px); opacity: 0.85; }
    .link-web { background: var(--pink); }
    .link-x { background: #000; }
    .link-yt { background: #ff0000; }
    .link-fc { background: var(--gold); }

    /* ========== MAIN ========== */
    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 28px 20px;
    }

    .tab-content { display: none; animation: fadeUp 0.3s ease; }
    .tab-content.active { display: block; }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ========== CONTROLS CARD ========== */
    .card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 24px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      margin-bottom: 20px;
    }

    .card-title {
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 2px;
      color: var(--gold);
      font-family: 'DM Mono', monospace;
      text-transform: uppercase;
      margin-bottom: 16px;
    }

    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 14px;
      align-items: end;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .field label {
      font-size: 11px;
      font-weight: 700;
      color: var(--pink-dark);
      letter-spacing: 0.5px;
    }

    select, input[type="date"] {
      padding: 10px 14px;
      border: 1.5px solid var(--border);
      border-radius: 12px;
      font-family: 'Zen Maru Gothic', sans-serif;
      font-size: 13px;
      color: var(--text);
      background: var(--surface);
      outline: none;
      transition: border-color 0.2s;
      width: 100%;
    }

    select:focus, input[type="date"]:focus {
      border-color: var(--pink);
      box-shadow: 0 0 0 3px rgba(244,114,182,0.1);
    }

    .date-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .date-row span { color: var(--text-muted); font-size: 12px; flex-shrink: 0; }
    .date-row input { flex: 1; }

    .btn-row {
      display: flex;
      gap: 8px;
      align-items: center;
      padding-top: 2px;
    }

    .btn {
      padding: 11px 20px;
      border-radius: 50px;
      border: none;
      font-family: 'Zen Maru Gothic', sans-serif;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--pink);
      color: white;
      flex: 1;
      box-shadow: 0 2px 12px rgba(244,114,182,0.25);
    }

    .btn-primary:hover {
      background: var(--pink-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(244,114,182,0.35);
    }

    .btn-secondary {
      background: #f3f4f6;
      color: #888;
    }

    .btn-secondary:hover { background: #e5e7eb; }

    .btn-gold {
      background: var(--gold);
      color: white;
      box-shadow: 0 2px 12px rgba(212,175,55,0.25);
    }

    .btn-gold:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(212,175,55,0.35);
      opacity: 0.9;
    }

    .notice {
      background: var(--pink-light);
      border-left: 3px solid var(--pink);
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 11px;
      color: var(--pink-dark);
      margin-top: 14px;
      line-height: 1.6;
    }

    /* ========== CHART AREA ========== */
    .chart-card {
      background: var(--surface);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 24px;
      margin-bottom: 20px;
      position: relative;
      min-height: 420px;
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
    }

    .chart-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--text);
    }

    .chart-subtitle {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .chart-wrap {
      position: relative;
      height: 420px;
    }

    .chart-wrap canvas { border-radius: 12px; }

    /* ========== EMPTY STATE ========== */
    .empty-state {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      gap: 12px;
    }

    .empty-icon {
      font-size: 48px;
      opacity: 0.4;
    }

    .empty-text { font-size: 14px; }

    /* ========== RANKING ========== */
    .ranking-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 10px;
    }

    .ranking-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      transition: all 0.2s;
    }

    .ranking-item:hover {
      border-color: var(--pink);
      box-shadow: var(--shadow);
      transform: translateY(-2px);
    }

    .rank-num {
      font-family: 'DM Mono', monospace;
      font-size: 18px;
      font-weight: 500;
      color: var(--pink-soft);
      width: 32px;
      flex-shrink: 0;
      text-align: center;
    }

    .rank-num.top1 { color: var(--gold); font-size: 22px; }
    .rank-num.top2 { color: #b0b0b0; font-size: 20px; }
    .rank-num.top3 { color: #cd7f32; font-size: 20px; }

    .rank-name {
      flex: 1;
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .rank-count {
      font-family: 'DM Mono', monospace;
      font-size: 14px;
      font-weight: 500;
      color: var(--gold);
      flex-shrink: 0;
    }

    .rank-bar-wrap {
      width: 100%;
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      margin-top: 6px;
      overflow: hidden;
    }

    .rank-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--pink), var(--gold));
      border-radius: 2px;
      transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* ========== COMPARE SECTION ========== */
    .compare-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .chart-half {
      background: var(--surface);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 20px;
    }

    .chart-half-wrap {
      position: relative;
      height: 300px;
    }

    /* ========== STATS PILLS ========== */
    .stats-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .stat-pill {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 50px;
      padding: 8px 18px;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: var(--shadow);
    }

    .stat-label { font-size: 11px; color: var(--text-muted); }
    .stat-val { font-family: 'DM Mono', monospace; font-size: 16px; font-weight: 500; color: var(--pink-dark); }

    /* ========== LOADING ========== */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255,245,249,0.9);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      gap: 16px;
    }

    .loading-overlay.show { display: flex; }

    .spinner {
      width: 44px;
      height: 44px;
      border: 3px solid var(--pink-soft);
      border-top-color: var(--pink);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .loading-text {
      font-size: 13px;
      color: var(--text-muted);
      font-family: 'DM Mono', monospace;
      letter-spacing: 2px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* ========== MOBILE ========== */
    .mobile-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--surface);
      border-top: 1px solid var(--border);
      padding: 8px 16px 20px;
      z-index: 100;
      gap: 4px;
    }

    .mobile-nav-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 8px 4px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-family: 'Zen Maru Gothic', sans-serif;
      font-size: 10px;
      font-weight: 500;
      cursor: pointer;
      border-radius: 12px;
      transition: all 0.2s;
    }

    .mobile-nav-btn.active {
      color: var(--pink);
      background: var(--pink-light);
    }

    .mobile-nav-icon { font-size: 20px; }

    @media (max-width: 768px) {
      header { padding: 0 16px; }
      .header-inner { height: 56px; }
      .logo-main { font-size: 14px; }
      nav { display: none; }
      .official-links { display: none; }
      main { padding: 16px 14px 90px; }
      .controls-grid { grid-template-columns: 1fr 1fr; }
      .compare-grid { grid-template-columns: 1fr; }
      .mobile-nav { display: flex; }
      .card { padding: 16px; }
      .chart-card { padding: 16px; }
      .chart-wrap { height: 320px; }
    }

    @media (max-width: 480px) {
      .controls-grid { grid-template-columns: 1fr; }
    }

    /* ========== CATEGORY BUTTONS ========== */
    .cat-btn {
      padding: 7px 14px;
      border: 1.5px solid var(--border);
      border-radius: 20px;
      background: var(--surface);
      color: var(--text-muted);
      font-family: 'Zen Maru Gothic', sans-serif;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.18s;
      white-space: nowrap;
    }
    .cat-btn:hover {
      border-color: var(--pink);
      color: var(--pink-dark);
      background: var(--pink-light);
    }
    .cat-btn.active {
      background: linear-gradient(135deg, var(--pink), var(--pink-dark));
      border-color: var(--pink-dark);
      color: #fff;
      box-shadow: 0 3px 12px rgba(244,114,182,0.35);
    }

    /* ========== STAT BADGE (compare summary cards) ========== */
    .stat-badge {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px 20px;
      box-shadow: var(--shadow);
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header>
    <div class="header-inner">
      <div class="logo">
        <span class="logo-sub">Advanced Performance Analysis</span>
        <span class="logo-main">ãŸã‹ã­ã“ æ¥½æ›²åˆ†æ Portal</span>
      </div>
      <nav>
        <button class="nav-btn active" onclick="switchTab('single')">æœŸé–“ãƒ»è©³ç´°åˆ†æ</button>
        <button class="nav-btn" onclick="switchTab('ranking')">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ä¸€è¦§</button>
        <button class="nav-btn" onclick="switchTab('compare')">å¹´åº¦æ¯”è¼ƒãƒ¬ãƒãƒ¼ãƒˆ</button>
      </nav>
      <div class="official-links">
        <a href="https://takanenonadeshiko.jp/" target="_blank" class="link-btn link-web">å…¬å¼ã‚µã‚¤ãƒˆ</a>
        <a href="https://x.com/takanenofficial" target="_blank" class="link-btn link-x">X</a>
        <a href="https://www.youtube.com/channel/UCoR4zZDvWvUIqgEWz4HS-sA" target="_blank" class="link-btn link-yt">YouTube</a>
        <a href="https://takanekofc.com/#/" target="_blank" class="link-btn link-fc">FC</a>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main>

    <!-- ===== TAB: æœŸé–“ãƒ»è©³ç´°åˆ†æ ===== -->
    <div id="tab-single" class="tab-content active">

      <div class="card">
        <div class="card-title">ğŸ” Analysis Settings</div>
        <div class="controls-grid">
          <div class="field">
            <label>å¯¾è±¡å¹´</label>
            <select id="yearSelect">
              <option value="2025">2025å¹´</option>
              <option value="2024">2024å¹´</option>
            </select>
          </div>
          <div class="field">
            <label>åˆ†æã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
            <select id="columnSelect">
              <option value="song">â˜… æ¥½æ›²åˆ¥ æ­Œå”±å›æ•°</option>
              <option value="first">ã€1æ›²ç›®ã€‘å‡ºç¾å›æ•°</option>
              <option value="last">ã€ãƒˆãƒªã€‘å‡ºç¾å›æ•°</option>
              <option value="spring">æ˜¥ (3ã€œ5æœˆ)</option>
              <option value="summer">å¤ (6ã€œ8æœˆ)</option>
              <option value="autumn">ç§‹ (9ã€œ11æœˆ)</option>
              <option value="winter">å†¬ (12ã€œ2æœˆ)</option>
              <option value="shortFirst">å°‘æ›²æ•°(1-4æ›²)1æ›²ç›®</option>
              <option value="longFirst">å¤šæ›²æ•°(5æ›²ä»¥ä¸Š)1æ›²ç›®</option>
              <option value="combo">é‰„æ¿ã‚³ãƒ³ãƒœåˆ†æ</option>
            </select>
          </div>
          <div class="field">
            <label>ã‚°ãƒ©ãƒ•ç¨®åˆ¥</label>
            <select id="chartTypeSelect">
              <option value="bar">ç¸¦æ£’ã‚°ãƒ©ãƒ•</option>
              <option value="horizontalBar">æ¨ªæ£’ã‚°ãƒ©ãƒ•</option>
              <option value="pie">å††ã‚°ãƒ©ãƒ•</option>
              <option value="doughnut">ãƒ‰ãƒ¼ãƒŠãƒ„ã‚°ãƒ©ãƒ•</option>
            </select>
          </div>
          <div class="field">
            <label>æœŸé–“çµã‚Šè¾¼ã¿ï¼ˆé–‹å§‹ï¼‰</label>
            <input type="date" id="startDate">
          </div>
          <div class="field">
            <label>æœŸé–“çµã‚Šè¾¼ã¿ï¼ˆçµ‚äº†ï¼‰</label>
            <input type="date" id="endDate">
          </div>
          <div class="field">
            <label>è¡¨ç¤ºä»¶æ•°</label>
            <select id="limitSelect">
              <option value="10">ä¸Šä½10ä»¶</option>
              <option value="20">ä¸Šä½20ä»¶</option>
              <option value="30">ä¸Šä½30ä»¶</option>
              <option value="999">å…¨ä»¶</option>
            </select>
          </div>
        </div>
        <div class="btn-row" style="margin-top:16px;">
          <button class="btn btn-primary" onclick="analyze()">ğŸ“Š åˆ†æã‚’é–‹å§‹ã™ã‚‹</button>
          <button class="btn btn-secondary" onclick="resetFilters()">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        <div class="notice">
          ğŸ’¡ æœŸé–“ã‚’æŒ‡å®šã—ãŸå ´åˆã¯ã€ãã®æœŸé–“å†…ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’é›†è¨ˆã—ã¾ã™ã€‚ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’æ›´æ–°ã™ã‚‹ã¨è‡ªå‹•çš„ã«æœ€æ–°ãƒ‡ãƒ¼ã‚¿ãŒåæ˜ ã•ã‚Œã¾ã™ã€‚
        </div>
      </div>

      <!-- Stats Pills -->
      <div class="stats-row" id="statsRow" style="display:none;">
        <div class="stat-pill">
          <span class="stat-label">ç·æ¥½æ›²æ•°</span>
          <span class="stat-val" id="stat-songs">-</span>
        </div>
        <div class="stat-pill">
          <span class="stat-label">ç·æ­Œå”±å›æ•°</span>
          <span class="stat-val" id="stat-total">-</span>
        </div>
        <div class="stat-pill">
          <span class="stat-label">æœ€å¤šæ¥½æ›²</span>
          <span class="stat-val" id="stat-top">-</span>
        </div>
      </div>

      <div class="chart-card">
        <div class="chart-header">
          <div>
            <div class="chart-title" id="chartTitleText">åˆ†æçµæœ</div>
            <div class="chart-subtitle" id="chartSubtitle">åˆ†æè¨­å®šã‚’é¸æŠã—ã¦ã€Œåˆ†æã‚’é–‹å§‹ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
          </div>
        </div>
        <div class="chart-wrap">
          <canvas id="mainChart"></canvas>
          <div class="empty-state" id="emptyState">
            <div class="empty-icon">ğŸµ</div>
            <div class="empty-text">åˆ†æã‚’å®Ÿè¡Œã™ã‚‹ã¨çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== TAB: ãƒ©ãƒ³ã‚­ãƒ³ã‚°ä¸€è¦§ ===== -->
    <div id="tab-ranking" class="tab-content">
      <div class="card">
        <div class="card-title">ğŸ† Ranking List</div>
        <p style="font-size:13px; color:var(--text-muted);">ã€ŒæœŸé–“ãƒ»è©³ç´°åˆ†æã€ã‚¿ãƒ–ã§åˆ†æã‚’å®Ÿè¡Œã™ã‚‹ã¨ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
      </div>
      <div class="ranking-grid" id="rankingGrid">
      </div>
    </div>

    <!-- ===== TAB: å¹´åº¦æ¯”è¼ƒãƒ¬ãƒãƒ¼ãƒˆ ===== -->
    <div id="tab-compare" class="tab-content">

      <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
      <div class="card">
        <div class="card-title">ğŸ“ˆ Trend Analysis</div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;">
          <!-- ã‚«ãƒ†ã‚´ãƒªé¸æŠ -->
          <div style="display:flex; flex-direction:column; gap:4px;">
            <label style="font-size:11px; color:var(--text-muted); font-weight:700; text-transform:uppercase; letter-spacing:.05em;">ã‚«ãƒ†ã‚´ãƒª</label>
            <div style="display:flex; gap:6px; flex-wrap:wrap;" id="compareCategoryBtns">
              <button class="cat-btn active" data-cat="song" onclick="setCompareCategory(this,'song')">ğŸµ å…¨æ›²</button>
              <button class="cat-btn" data-cat="first" onclick="setCompareCategory(this,'first')">ğŸ¤ 1æ›²ç›®</button>
              <button class="cat-btn" data-cat="last" onclick="setCompareCategory(this,'last')">ğŸ† ãƒˆãƒª</button>
              <button class="cat-btn" data-cat="spring" onclick="setCompareCategory(this,'spring')">ğŸŒ¸ æ˜¥</button>
              <button class="cat-btn" data-cat="summer" onclick="setCompareCategory(this,'summer')">â˜€ï¸ å¤</button>
              <button class="cat-btn" data-cat="autumn" onclick="setCompareCategory(this,'autumn')">ğŸ‚ ç§‹</button>
              <button class="cat-btn" data-cat="winter" onclick="setCompareCategory(this,'winter')">â„ï¸ å†¬</button>
              <button class="cat-btn" data-cat="combo" onclick="setCompareCategory(this,'combo')">ğŸ”— ã‚³ãƒ³ãƒœ</button>
            </div>
          </div>
          <!-- Topä»¶æ•° -->
          <div style="display:flex; flex-direction:column; gap:4px;">
            <label style="font-size:11px; color:var(--text-muted); font-weight:700; text-transform:uppercase; letter-spacing:.05em;">è¡¨ç¤ºä»¶æ•°</label>
            <select class="select" id="compareLimit" style="height:36px; padding:0 12px;" onchange="runCompare()">
              <option value="10">Top 10</option>
              <option value="15" selected>Top 15</option>
              <option value="20">Top 20</option>
              <option value="30">Top 30</option>
            </select>
          </div>
          <!-- æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
          <div style="display:flex; flex-direction:column; gap:4px;">
            <label style="font-size:11px; color:var(--text-muted); font-weight:700; text-transform:uppercase; letter-spacing:.05em;">æœŸé–“ï¼ˆé–‹å§‹ï¼‰</label>
            <input type="month" class="select" id="compareStart" style="height:36px; padding:0 10px;" onchange="runCompare()">
          </div>
          <div style="display:flex; flex-direction:column; gap:4px;">
            <label style="font-size:11px; color:var(--text-muted); font-weight:700; text-transform:uppercase; letter-spacing:.05em;">æœŸé–“ï¼ˆçµ‚äº†ï¼‰</label>
            <input type="month" class="select" id="compareEnd" style="height:36px; padding:0 10px;" onchange="runCompare()">
          </div>
          <button class="btn btn-gold" onclick="runCompare()">ğŸ”„ åˆ†æå®Ÿè¡Œ</button>
          <button class="btn" style="background:var(--pink-light); color:var(--pink-dark);" onclick="resetCompare()">âœ• ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
      </div>

      <!-- ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ -->
      <div id="compareSummary" style="display:none;">
        <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:12px; margin-bottom:16px;">
          <div class="stat-badge" id="cs2024"></div>
          <div class="stat-badge" id="cs2025"></div>
          <div class="stat-badge" id="csDelta"></div>
          <div class="stat-badge" id="csGrowth"></div>
        </div>
      </div>

      <!-- æ¦‚è¦ã‚°ãƒ©ãƒ• 2åˆ— -->
      <div class="compare-grid">
        <div class="chart-half">
          <div class="chart-title" style="font-size:14px; margin-bottom:14px;">å¹´åº¦åˆ¥ å…¬æ¼”æ•°</div>
          <div class="chart-half-wrap"><canvas id="eventChart"></canvas></div>
        </div>
        <div class="chart-half">
          <div class="chart-title" style="font-size:14px; margin-bottom:14px;">æœˆåˆ¥ å…¬æ¼”æ•°æ¨ç§»</div>
          <div class="chart-half-wrap"><canvas id="monthlyChart"></canvas></div>
        </div>
      </div>

      <!-- ãƒ¡ã‚¤ãƒ³æ¯”è¼ƒã‚°ãƒ©ãƒ• -->
      <div class="chart-card">
        <div style="display:flex; align-items:baseline; gap:10px; flex-wrap:wrap; margin-bottom:6px;">
          <div class="chart-title" style="margin:0;" id="compareChartTitle">æ¥½æ›²åˆ¥ å¹´åº¦æ¯”è¼ƒ</div>
          <div style="font-size:11px; color:var(--text-muted);">ğŸ‘† ãƒãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è©³ç´°ãƒ‰ãƒªãƒ«ãƒ€ã‚¦ãƒ³</div>
        </div>
        <div class="chart-subtitle" style="margin-bottom:20px;" id="compareChartSub">ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã‚“ã§ã€Œåˆ†æå®Ÿè¡Œã€ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
        <div style="position:relative; height:560px;">
          <canvas id="trendChart"></canvas>
        </div>
      </div>

      <!-- æœˆåˆ¥æ¨ç§»ã‚°ãƒ©ãƒ•ï¼ˆå…¨æ›²ã‚«ãƒ†ã‚´ãƒªæ™‚ã®ã¿ï¼‰ -->
      <div class="chart-card" id="monthlyTrendCard" style="display:none;">
        <div class="chart-title" style="margin-bottom:6px;">æœˆåˆ¥ æ­Œå”±å›æ•°æ¨ç§»</div>
        <div class="chart-subtitle" style="margin-bottom:20px;">å„æœˆã®æ­Œå”±å›æ•°ï¼ˆå…¨æ¥½æ›²åˆè¨ˆï¼‰</div>
        <div style="position:relative; height:320px;">
          <canvas id="monthlyCountChart"></canvas>
        </div>
      </div>
    </div>

    <!-- ãƒ‰ãƒªãƒ«ãƒ€ã‚¦ãƒ³ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="drillModal" style="display:none; position:fixed; inset:0; z-index:1000; background:rgba(61,43,53,0.55); backdrop-filter:blur(6px); overflow-y:auto; padding:24px 16px;">
      <div style="max-width:760px; margin:0 auto; background:var(--surface); border-radius:var(--radius); box-shadow:0 20px 80px rgba(244,114,182,0.25); overflow:hidden;">
        <div style="background:linear-gradient(135deg,var(--pink),var(--pink-dark)); padding:24px 28px; display:flex; justify-content:space-between; align-items:center;">
          <div>
            <div id="drillSongName" style="font-size:20px; font-weight:700; color:#fff;"></div>
            <div id="drillSongSub" style="font-size:12px; color:rgba(255,255,255,0.7); margin-top:4px;"></div>
          </div>
          <button onclick="closeDrill()" style="background:rgba(255,255,255,0.2); border:none; border-radius:50%; width:36px; height:36px; cursor:pointer; font-size:18px; color:#fff; display:flex; align-items:center; justify-content:center;">âœ•</button>
        </div>
        <div style="padding:24px 28px;">
          <!-- å¹´åº¦æ¯”è¼ƒãƒãƒ¼ -->
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:24px;">
            <div class="stat-badge" id="drill2024"></div>
            <div class="stat-badge" id="drill2025"></div>
          </div>
          <!-- æœˆåˆ¥æ¨ç§»ãƒãƒ£ãƒ¼ãƒˆ -->
          <div style="font-size:13px; font-weight:700; color:var(--text); margin-bottom:12px;">ğŸ“… æœˆåˆ¥ æ­Œå”±æ¨ç§»</div>
          <div style="position:relative; height:240px; margin-bottom:20px;">
            <canvas id="drillMonthChart"></canvas>
          </div>
          <!-- ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ï¼ˆæœ€è¿‘ã®10ä»¶ï¼‰ -->
          <div style="font-size:13px; font-weight:700; color:var(--text); margin-bottom:10px;">ğŸ“‹ æœ€è¿‘ã®å‡ºæ¼”ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæœ€å¤§20ä»¶ï¼‰</div>
          <div id="drillEventList" style="display:flex; flex-direction:column; gap:6px; max-height:280px; overflow-y:auto;"></div>
        </div>
      </div>
    </div>

  </main>

  <!-- MOBILE NAV -->
  <div class="mobile-nav" id="mobileNav">
    <button class="mobile-nav-btn active" id="mnav-single" onclick="switchTab('single')">
      <span class="mobile-nav-icon">ğŸ”</span>è©³ç´°åˆ†æ
    </button>
    <button class="mobile-nav-btn" id="mnav-ranking" onclick="switchTab('ranking')">
      <span class="mobile-nav-icon">ğŸ†</span>ãƒ©ãƒ³ã‚­ãƒ³ã‚°
    </button>
    <button class="mobile-nav-btn" id="mnav-compare" onclick="switchTab('compare')">
      <span class="mobile-nav-icon">ğŸ“ˆ</span>å¹´åº¦æ¯”è¼ƒ
    </button>
  </div>

  <!-- LOADING -->
  <div class="loading-overlay" id="loading">
    <div class="spinner"></div>
    <div class="loading-text">NOW ANALYZING...</div>
  </div>

  <script>
    // datalabelsãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ç™»éŒ²
    Chart.register(ChartDataLabels);

    // ============================================================
    // è¨­å®š
    // ============================================================
    const SHEET_ID = '10QKtPdhdtaLFxxkRhdzTRVePeh3DUmib0WpEJA49Erw';
    const SHEET_NAMES = {
      '2024': 'æ¥½æ›²åˆ†è§£ã‚·ãƒ¼ãƒˆï¼ˆ2024ï¼‰',
      '2025': 'æ¥½æ›²åˆ†è§£ã‚·ãƒ¼ãƒˆï¼ˆ2025ï¼‰'
    };

    const COLORS = [
      '#f472b6','#d4af37','#818cf8','#34d399','#fb923c',
      '#60a5fa','#e879f9','#4ade80','#f87171','#38bdf8',
      '#fbbf24','#a78bfa','#fb7185','#2dd4bf','#c084fc'
    ];

    // ============================================================
    // ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆGoogle Sheets CSV ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼‰
    // ============================================================
    async function fetchSheetData(year) {
      const sheetName = encodeURIComponent(SHEET_NAMES[year]);
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${sheetName}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      const text = await res.text();
      return parseCSV(text);
    }

    function parseCSV(text) {
      const lines = text.split('\n');
      return lines.map(line => {
        // CSVã®ã‚¯ã‚©ãƒ¼ãƒˆå‡¦ç†
        const result = [];
        let inQuote = false;
        let current = '';
        for (let i = 0; i < line.length; i++) {
          const ch = line[i];
          if (ch === '"') {
            if (inQuote && line[i+1] === '"') { current += '"'; i++; }
            else inQuote = !inQuote;
          } else if (ch === ',' && !inQuote) {
            result.push(current.trim());
            current = '';
          } else {
            current += ch;
          }
        }
        result.push(current.trim());
        return result;
      }).filter(r => r.length > 1 && r[0]);
    }

    function excelDateToJS(serial) {
      const n = parseFloat(serial);
      if (isNaN(n)) return null;
      const d = new Date(Math.round((n - 25569) * 86400 * 1000));
      return isNaN(d.getTime()) ? null : d;
    }

    function parseDate(val) {
      if (!val) return null;
      // Excelã‚·ãƒªã‚¢ãƒ«å€¤
      if (/^\d{4,6}$/.test(val.replace(/\s/g,''))) {
        return excelDateToJS(val);
      }
      // YYYY/MM/DD or YYYY-MM-DD
      const d = new Date(val.replace(/\//g, '-'));
      return isNaN(d.getTime()) ? null : d;
    }

    // ============================================================
    // ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®èª¬æ˜
    // ============================================================
    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®åˆ—æ§‹é€ ï¼ˆ0å§‹ã¾ã‚Šã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‰:
    // A=0:è¨ˆç®—ç”¨æ—¥ä»˜ï¼ˆExcelã‚·ãƒªã‚¢ãƒ«ï¼‰, B=1:æœˆ, C=2:ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒˆãƒ«, D=3:æ›²åï¼ˆç”Ÿã‚»ãƒˆãƒªã€1è¡Œ1æ›²ï¼‰
    // E=4:ç©º, F=5:æ›²åï¼ˆé›†è¨ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨ï¼‰, G=6:æ­Œå”±å›æ•°, H=7:å‰²åˆ
    // I=8:ç©º, J=9:1æ›²ç›®TOPæ›²å, K=10:1æ›²ç›®TOPå›æ•°
    // L=11:ç©º, M=12:ãƒˆãƒªTOPæ›²å, N=13:ãƒˆãƒªTOPå›æ•°
    // O=14:ç©º, P=15:æ˜¥æ›²å, Q=16:æ˜¥å›æ•°
    // R=17:ç©º, S=18:å¤æ›²å, T=19:å¤å›æ•°
    // U=20:ç©º, V=21:ç§‹æ›²å, W=22:ç§‹å›æ•°
    // X=23:ç©º, Y=24:å†¬æ›²å, Z=25:å†¬å›æ•°
    // AA=26:ç©º, AB=27:å°‘æ›²æ•°1æ›²ç›®æ›²å, AC=28:å°‘æ›²æ•°1æ›²ç›®å›æ•°
    // AD=29:ç©º, AE=30:å¤šæ›²æ•°1æ›²ç›®æ›²å, AF=31:å¤šæ›²æ•°1æ›²ç›®å›æ•°
    // AG=32:ç©º, AH=33:ã‚³ãƒ³ãƒœãƒšã‚¢å, AI=34:ã‚³ãƒ³ãƒœå›æ•°
    //
    // â€» å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¦‹ã‚‹ã¨ï¼š
    // - Dåˆ—(3): ç”Ÿã‚»ãƒˆãƒªæ›²åï¼ˆå„è¡Œã«1æ›²ï¼‰
    // - Fåˆ—(5): é›†è¨ˆæ¸ˆã¿æ›²åãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆå„è¡Œã«åˆ¥ã®æ›²ã€ä¸Šã‹ã‚‰å¤šã„é †ï¼‰
    // - Gåˆ—(6): ä¸Šè¨˜ã®æ­Œå”±å›æ•°
    // - Jåˆ—ä»¥é™: å„åˆ†æè»¸ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆå„è¡ŒãŒç‹¬ç«‹ã—ãŸãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚¨ãƒ³ãƒˆãƒªï¼‰
    //
    // æ­£ã—ã„èª­ã¿æ–¹: å„è¡Œã¯ã‚»ãƒˆãƒªãƒ‡ãƒ¼ã‚¿è¡Œã ãŒã€
    // Fåˆ—ãƒ»Gåˆ—ãƒ»Jåˆ—ä»¥é™ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã¯ã€Œå…¨è¡Œã‚’èµ°æŸ»ã—ã¦åå‰ã¨å›æ•°ã®ãƒšã‚¢ã‚’é›†ã‚ã‚‹ã€

    // å®Ÿéš›ã®CSVã‚’è§£æã—ã¦åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’å‹•çš„ã«æ¤œå‡ºã™ã‚‹
    function detectColumns(rows) {
      // å®Ÿéš›ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆåˆ—æ§‹é€ ï¼ˆ0ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‰:
      // A(0):æ—¥ä»˜ã‚·ãƒªã‚¢ãƒ«, B(1):æœˆ, C(2):ã‚¿ã‚¤ãƒˆãƒ«, D(3):æ›²å(ç”Ÿã‚»ãƒˆãƒªãƒ‡ãƒ¼ã‚¿)
      // E(4):ç©º, F(5):å…¨æ›²ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ›²å, G(6):æ­Œå”±å›æ•°, H(7):å‰²åˆ
      // I(8):ç©º
      // J(9):1æ›²ç›®æ›²å, K(10):1æ›²ç›®å›æ•°
      // L(11):ãƒˆãƒªæ›²å, M(12):ãƒˆãƒªå›æ•°
      // N(13):æ˜¥æ›²å, O(14):æ˜¥å›æ•°
      // P(15):å¤æ›²å, Q(16):å¤å›æ•°
      // R(17):ç§‹æ›²å, S(18):ç§‹å›æ•°
      // T(19):å†¬æ›²å, U(20):å†¬å›æ•°
      // V(21):å°‘æ›²æ•°1æ›²ç›®æ›²å, W(22):å°‘æ›²æ•°1æ›²ç›®å›æ•°
      // X(23):å¤šæ›²æ•°1æ›²ç›®æ›²å, Y(24):å¤šæ›²æ•°1æ›²ç›®å›æ•°
      // Z(25):ã‚³ãƒ³ãƒœãƒšã‚¢, AA(26):å…±æ¼”å›æ•°
      return {
        song:   { nameCol: 5,  countCol: 6  },
        first:  { nameCol: 9,  countCol: 10 },
        last:   { nameCol: 11, countCol: 12 },
        spring: { nameCol: 13, countCol: 14 },
        summer: { nameCol: 15, countCol: 16 },
        autumn: { nameCol: 17, countCol: 18 },
        winter: { nameCol: 19, countCol: 20 },
        shortFirst: { nameCol: 21, countCol: 22 },
        longFirst:  { nameCol: 23, countCol: 24 },
        combo:  { nameCol: 25, countCol: 26 },
      };
    }

    // ã‚»ãƒˆãƒªç”Ÿãƒ‡ãƒ¼ã‚¿ï¼ˆDåˆ—ï¼‰ã‹ã‚‰ç›´æ¥é›†è¨ˆã™ã‚‹é–¢æ•°
    function aggregateFromRaw(rows, startDate, endDate) {
      const summary = {};
      // æœ€åˆã®2è¡Œã¯ãƒ˜ãƒƒãƒ€ãƒ¼ãªã®ã§ã‚¹ã‚­ãƒƒãƒ—
      const dataRows = rows.slice(2);
      dataRows.forEach(row => {
        if (!row[0] || !/^\d{5}/.test(row[0])) return; // Excelã‚·ãƒªã‚¢ãƒ«æ—¥ä»˜è¡Œã®ã¿
        if (startDate || endDate) {
          const d = parseDate(row[0]);
          if (!d) return;
          if (startDate && d < startDate) return;
          if (endDate && d > endDate) return;
        }
        const name = row[3]; // Dåˆ—: ç”Ÿã‚»ãƒˆãƒªæ›²å
        if (!name || name.trim() === '') return;
        summary[name] = (summary[name] || 0) + 1;
      });
      return Object.entries(summary).sort((a, b) => b[1] - a[1]);
    }

    // é›†è¨ˆæ¸ˆã¿ãƒ©ãƒ³ã‚­ãƒ³ã‚°åˆ—ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã‚€é–¢æ•°
    function aggregateFromRanking(rows, colType, startDate, endDate) {
      const colMap = detectColumns(rows);
      const cfg = colMap[colType];
      if (!cfg) return [];

      const summary = {};
      // è¡Œ2ä»¥é™ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼2è¡Œã‚’é™¤ãï¼‰ã‚’èµ°æŸ»
      rows.slice(2).forEach(row => {
        // æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ã¯é›†è¨ˆæ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã«ã¯é©ç”¨ã—ãªã„ï¼ˆæ—¢ã«å…¨æœŸé–“é›†è¨ˆæ¸ˆã¿ï¼‰
        // ãŸã ã—æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ãŒã‚ã‚‹å ´åˆã¯ã‚»ãƒˆãƒªç”Ÿãƒ‡ãƒ¼ã‚¿ã§å†é›†è¨ˆ
        const name = row[cfg.nameCol];
        const count = parseFloat(row[cfg.countCol]);
        if (!name || name.trim() === '' || name === 'æ›²å' || name === 'ãƒšã‚¢') return;
        if (isNaN(count) || count <= 0) return;
        // åŒã˜åå‰ãŒè¤‡æ•°è¡Œã«å‡ºãŸã‚‰æœ€åˆã®å€¤ã®ã¿ä½¿ç”¨ï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¯é‡è¤‡ãªã—ï¼‰
        if (!summary[name]) {
          summary[name] = count;
        }
      });

      return Object.entries(summary).sort((a, b) => b[1] - a[1]);
    }

    function aggregateData(rows, colType, startDate, endDate) {
      // æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ãŒã‚ã‚‹å ´åˆã€ã¾ãŸã¯songåˆ†æã¯ã‚»ãƒˆãƒªç”Ÿãƒ‡ãƒ¼ã‚¿ã‹ã‚‰é›†è¨ˆ
      if (colType === 'song' || startDate || endDate) {
        if (colType === 'song') {
          return aggregateFromRaw(rows, startDate, endDate);
        }
        // ä»–ã®colTypeã§æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ãŒã‚ã‚‹å ´åˆã‚‚rawã‹ã‚‰å¯¾å¿œã™ã‚‹åˆ†æã‚’å†ç¾
        // ãŸã ã—1æ›²ç›®ãƒ»ãƒˆãƒªç­‰ã¯ç”Ÿãƒ‡ãƒ¼ã‚¿ã ã‘ã§ã¯åˆ¤æ–­ã§ããªã„ã®ã§ã€ãƒ•ã‚£ãƒ«ã‚¿ãªã—ã§é›†è¨ˆæ¸ˆã¿ã‚’ä½¿ç”¨
        return aggregateFromRanking(rows, colType, null, null);
      }
      return aggregateFromRanking(rows, colType, startDate, endDate);
    }

    // ============================================================
    // ãƒãƒ£ãƒ¼ãƒˆç®¡ç†
    // ============================================================
    let mainChartInstance = null;

    function destroyChart(instance) {
      if (instance) { try { instance.destroy(); } catch(e) {} }
      return null;
    }

    function getChartConfig(type, labels, data, label) {
      const colors = labels.map((_, i) => COLORS[i % COLORS.length]);
      const baseOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: type === 'pie' || type === 'doughnut', position: 'right',
            labels: { font: { family: 'Zen Maru Gothic', size: 11 }, padding: 12, boxWidth: 12 }
          },
          tooltip: {
            callbacks: {
              label: ctx => ` ${ctx.parsed.y ?? ctx.parsed}å›`
            }
          }
        }
      };

      const datalabelsVertical = {
        display: ctx => ctx.parsed.y > 0,
        color: '#fff',
        font: { family: 'DM Mono', size: 11, weight: '700' },
        anchor: 'center', align: 'center',
        formatter: v => v
      };
      const datalabelsHorizontal = {
        display: ctx => ctx.parsed.x > 0,
        color: '#fff',
        font: { family: 'DM Mono', size: 11, weight: '700' },
        anchor: 'end', align: 'start', offset: 6,
        clamp: true,
        formatter: v => v + 'å›'
      };

      if (type === 'pie' || type === 'doughnut') {
        return {
          type,
          data: { labels, datasets: [{ data, backgroundColor: colors, borderWidth: 2, borderColor: '#fff' }] },
          options: { ...baseOptions, plugins: { ...baseOptions.plugins,
            tooltip: { callbacks: { label: ctx => ` ${ctx.label}: ${ctx.parsed}å›` } },
            datalabels: {
              display: ctx => ctx.parsed > 0,
              color: '#fff',
              font: { family: 'DM Mono', size: 10, weight: '700' },
              formatter: (v, ctx) => {
                const total = ctx.dataset.data.reduce((a,b)=>a+b,0);
                return total > 0 ? Math.round(v/total*100) + '%' : '';
              }
            }
          }}
        };
      }

      if (type === 'horizontalBar') {
        return {
          type: 'bar',
          data: { labels, datasets: [{ label, data, backgroundColor: colors, borderRadius: 6, borderSkipped: false }] },
          options: {
            ...baseOptions,
            indexAxis: 'y',
            plugins: { ...baseOptions.plugins, legend: { display: false }, datalabels: datalabelsHorizontal },
            scales: {
              x: { grid: { color: 'rgba(0,0,0,0.04)' }, ticks: { font: { family: 'DM Mono', size: 11 } } },
              y: { grid: { display: false }, ticks: { font: { family: 'Zen Maru Gothic', size: 11 } } }
            }
          }
        };
      }

      // ç¸¦æ£’ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
      return {
        type: 'bar',
        data: { labels, datasets: [{ label, data, backgroundColor: colors, borderRadius: 8, borderSkipped: false }] },
        options: {
          ...baseOptions,
          plugins: { ...baseOptions.plugins, legend: { display: false }, datalabels: datalabelsVertical },
          scales: {
            x: { grid: { display: false }, ticks: { font: { family: 'Zen Maru Gothic', size: 10 }, maxRotation: 45 } },
            y: { grid: { color: 'rgba(0,0,0,0.04)' }, ticks: { font: { family: 'DM Mono', size: 11 } } }
          }
        }
      };
    }

    // ============================================================
    // åˆ†æå®Ÿè¡Œ
    // ============================================================
    async function analyze() {
      const year = document.getElementById('yearSelect').value;
      const colType = document.getElementById('columnSelect').value;
      const chartType = document.getElementById('chartTypeSelect').value;
      const limit = parseInt(document.getElementById('limitSelect').value);
      const startVal = document.getElementById('startDate').value;
      const endVal = document.getElementById('endDate').value;

      const startDate = startVal ? new Date(startVal) : null;
      const endDate = endVal ? new Date(endVal + 'T23:59:59') : null;

      showLoading(true);
      try {
        const rows = await fetchSheetData(year);
        let results = aggregateData(rows, colType, startDate, endDate);

        if (results.length === 0) {
          alert('è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦ã¿ã¦ãã ã•ã„ã€‚');
          return;
        }

        // ä»¶æ•°åˆ¶é™
        const limited = results.slice(0, limit);

        // Stats
        const total = results.reduce((s, r) => s + r[1], 0);
        document.getElementById('stat-songs').textContent = results.length + 'æ›²';
        document.getElementById('stat-total').textContent = total + 'å›';
        document.getElementById('stat-top').textContent = results[0][0];
        document.getElementById('statsRow').style.display = 'flex';

        // Chart
        const labels = limited.map(r => r[0]);
        const data = limited.map(r => r[1]);
        const colLabel = document.getElementById('columnSelect').selectedOptions[0].text;

        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('chartTitleText').textContent = `${year}å¹´ ${colLabel}`;
        document.getElementById('chartSubtitle').textContent = `ä¸Šä½${limited.length}ä»¶ / å…¨${results.length}æ›²`;

        mainChartInstance = destroyChart(mainChartInstance);
        const ctx = document.getElementById('mainChart').getContext('2d');
        mainChartInstance = new Chart(ctx, getChartConfig(chartType, labels, data, colLabel));

        // Ranking
        renderRanking(results, limit);

      } catch (e) {
        alert('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®å…±æœ‰è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n\nã‚¨ãƒ©ãƒ¼: ' + e.message);
        console.error(e);
      } finally {
        showLoading(false);
      }
    }

    // ============================================================
    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°æç”»
    // ============================================================
    function renderRanking(results, limit) {
      const grid = document.getElementById('rankingGrid');
      grid.innerHTML = '';
      const max = results[0]?.[1] || 1;

      results.slice(0, limit === 999 ? results.length : limit).forEach(([name, count], i) => {
        const rank = i + 1;
        const rankClass = rank === 1 ? 'top1' : rank === 2 ? 'top2' : rank === 3 ? 'top3' : '';
        const pct = Math.round((count / max) * 100);

        const item = document.createElement('div');
        item.className = 'ranking-item';
        item.innerHTML = `
          <span class="rank-num ${rankClass}">${rank}</span>
          <div style="flex:1; overflow:hidden;">
            <div class="rank-name">${name}</div>
            <div class="rank-bar-wrap"><div class="rank-bar" style="width:${pct}%"></div></div>
          </div>
          <span class="rank-count">${count}å›</span>
        `;
        grid.appendChild(item);
      });
    }

    // ============================================================
    // å¹´åº¦æ¯”è¼ƒ (Enhanced)
    // ============================================================
    let eventChartInst = null;
    let monthlyChartInst = null;
    let trendChartInst = null;
    let monthlyCountChartInst = null;
    let drillMonthChartInst = null;
    let compareCategory = 'song';
    let cachedRows2024 = null;
    let cachedRows2025 = null;

    // ã‚«ãƒ†ã‚´ãƒªãƒ©ãƒ™ãƒ«ãƒãƒƒãƒ”ãƒ³ã‚°
    const CATEGORY_LABELS = {
      song: 'å…¨æ¥½æ›²', first: '1æ›²ç›®', last: 'ãƒˆãƒª(æœ€çµ‚æ›²)',
      spring: 'æ˜¥(3-5æœˆ)', summer: 'å¤(6-8æœˆ)', autumn: 'ç§‹(9-11æœˆ)', winter: 'å†¬(12-2æœˆ)',
      shortFirst: 'å°‘æ›²æ•°1æ›²ç›®', longFirst: 'å¤šæ›²æ•°1æ›²ç›®', combo: 'é‰„æ¿ã‚³ãƒ³ãƒœ'
    };

    function setCompareCategory(btn, cat) {
      document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      compareCategory = cat;
      runCompare();
    }

    function resetCompare() {
      document.getElementById('compareStart').value = '';
      document.getElementById('compareEnd').value = '';
      document.getElementById('compareLimit').value = '15';
      compareCategory = 'song';
      document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
      document.querySelector('.cat-btn[data-cat="song"]').classList.add('active');
      runCompare();
    }

    // æ¯”è¼ƒç”¨ãƒ‡ãƒ¼ã‚¿é›†è¨ˆï¼šã‚«ãƒ†ã‚´ãƒªå¯¾å¿œ
    function buildCompareData(rows, cat, startDate, endDate) {
      const colMap = detectColumns(rows);
      const dataRows = rows.slice(2);

      // ç”Ÿãƒ‡ãƒ¼ã‚¿ã‹ã‚‰é›†è¨ˆï¼ˆsong/first/last/seasonalï¼‰
      if (cat === 'song') {
        const map = {};
        dataRows.forEach(row => {
          if (!row[0] || !/^\d{5}/.test(row[0])) return;
          if (startDate || endDate) {
            const d = parseDate(row[0]); if (!d) return;
            if (startDate && d < startDate) return;
            if (endDate && d > endDate) return;
          }
          const name = row[3];
          if (!name || !name.trim()) return;
          map[name] = (map[name] || 0) + 1;
        });
        return map;
      }

      // é›†è¨ˆæ¸ˆã¿åˆ—ã‹ã‚‰èª­ã‚€ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãªã—ï¼‰
      const cfg = colMap[cat];
      if (!cfg) return {};
      const map = {};
      dataRows.forEach(row => {
        const name = row[cfg.nameCol];
        const count = parseFloat(row[cfg.countCol]);
        if (!name || !name.trim() || name === 'æ›²å' || name === 'ãƒšã‚¢') return;
        if (isNaN(count) || count <= 0) return;
        if (!map[name]) map[name] = count;
      });
      return map;
    }

    // æœˆåˆ¥ + ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ï¼ˆãƒ‰ãƒªãƒ«ãƒ€ã‚¦ãƒ³ç”¨ï¼‰
    function getSongDetails(rows, songName, year) {
      const monthly = {};
      for (let m = 1; m <= 12; m++) monthly[m] = 0;
      const events = [];
      const dataRows = rows.slice(2);
      const seenEvents = new Set();

      dataRows.forEach(row => {
        if (!row[0] || !/^\d{5}/.test(row[0])) return;
        const name = row[3];
        if (name !== songName) return;
        const d = parseDate(row[0]);
        if (!d) return;
        const m = d.getMonth() + 1;
        monthly[m]++;
        const evKey = row[0] + '_' + (row[2] || '');
        if (!seenEvents.has(evKey)) {
          seenEvents.add(evKey);
          events.push({ date: d, title: row[2] || 'ä¸æ˜', month: m });
        }
      });

      events.sort((a, b) => b.date - a.date);
      return { monthly, events: events.slice(0, 20) };
    }

    async function runCompare() {
      showLoading(true);
      try {
        // ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        if (!cachedRows2024) cachedRows2024 = await fetchSheetData('2024');
        if (!cachedRows2025) cachedRows2025 = await fetchSheetData('2025');
        const rows2024 = cachedRows2024;
        const rows2025 = cachedRows2025;

        // æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        const startVal = document.getElementById('compareStart').value;
        const endVal = document.getElementById('compareEnd').value;
        const startDate = startVal ? new Date(startVal + '-01') : null;
        const endDate = endVal ? new Date(endVal + '-01T23:59:59') : null;
        if (endDate) endDate.setMonth(endDate.getMonth() + 1); // month end

        const limit = parseInt(document.getElementById('compareLimit').value) || 15;
        const cat = compareCategory;

        // å…¬æ¼”æ•° + æœˆåˆ¥å…¬æ¼”æ•°
        const eventCounts = {};
        const monthlyEventData = {};
        for (let m = 1; m <= 12; m++) monthlyEventData[m] = { '2024': 0, '2025': 0 };
        for (const [year, rows] of [['2024', rows2024], ['2025', rows2025]]) {
          const seen = new Set();
          rows.slice(2).forEach(row => {
            if (!row[0] || !/^\d{5}/.test(row[0])) return;
            const d = parseDate(row[0]); if (!d) return;
            if (startDate && d < startDate) return;
            if (endDate && d > endDate) return;
            const key = row[0] + '_' + (row[2] || '');
            const m = d.getMonth() + 1;
            if (!seen.has(key)) { seen.add(key); monthlyEventData[m][year]++; }
          });
          eventCounts[year] = seen.size;
        }

        // ã‚«ãƒ†ã‚´ãƒªåˆ¥é›†è¨ˆ
        const map2024 = buildCompareData(rows2024, cat, startDate, endDate);
        const map2025 = buildCompareData(rows2025, cat, startDate, endDate);
        const allNames = [...new Set([...Object.keys(map2024), ...Object.keys(map2025)])];
        const combined = allNames.map(name => ({
          name,
          v2024: map2024[name] || 0,
          v2025: map2025[name] || 0,
          total: (map2024[name] || 0) + (map2025[name] || 0)
        })).sort((a, b) => b.total - a.total).slice(0, limit);

        const total2024 = Object.values(map2024).reduce((a,b)=>a+b,0);
        const total2025 = Object.values(map2025).reduce((a,b)=>a+b,0);
        const delta = total2025 - total2024;
        const growth = total2024 > 0 ? ((delta / total2024) * 100).toFixed(1) : 'â€”';

        // ã‚µãƒãƒªãƒ¼æ›´æ–°
        const summaryEl = document.getElementById('compareSummary');
        summaryEl.style.display = 'block';
        const catLabel = CATEGORY_LABELS[cat] || cat;
        document.getElementById('cs2024').innerHTML = `<div style="font-size:11px;color:var(--text-muted);margin-bottom:4px;">2024å¹´ ç·æ­Œå”±æ•°</div><div style="font-size:26px;font-weight:700;color:var(--gold);">${total2024.toLocaleString()}</div><div style="font-size:11px;color:var(--text-muted);">${eventCounts['2024']}å…¬æ¼”</div>`;
        document.getElementById('cs2025').innerHTML = `<div style="font-size:11px;color:var(--text-muted);margin-bottom:4px;">2025å¹´ ç·æ­Œå”±æ•°</div><div style="font-size:26px;font-weight:700;color:var(--pink);">${total2025.toLocaleString()}</div><div style="font-size:11px;color:var(--text-muted);">${eventCounts['2025']}å…¬æ¼”</div>`;
        document.getElementById('csDelta').innerHTML = `<div style="font-size:11px;color:var(--text-muted);margin-bottom:4px;">å¢—æ¸›</div><div style="font-size:26px;font-weight:700;color:${delta>=0?'#34d399':'#f87171'};">${delta>=0?'+':''}${delta.toLocaleString()}</div><div style="font-size:11px;color:var(--text-muted);">vs 2024å¹´</div>`;
        document.getElementById('csGrowth').innerHTML = `<div style="font-size:11px;color:var(--text-muted);margin-bottom:4px;">æˆé•·ç‡</div><div style="font-size:26px;font-weight:700;color:${delta>=0?'#34d399':'#f87171'};">${total2024>0?(delta>=0?'+':'')+growth+'%':'N/A'}</div><div style="font-size:11px;color:var(--text-muted);">å‰å¹´æ¯”</div>`;

        document.getElementById('compareChartTitle').textContent = `${catLabel} å¹´åº¦æ¯”è¼ƒ (Top${limit})`;
        document.getElementById('compareChartSub').textContent = `å„é …ç›®ã®2024å¹´ãƒ»2025å¹´ã®æ­Œå”±å›æ•°æ¯”è¼ƒ â€” ãƒãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°è¡¨ç¤º`;

        // æœˆåˆ¥æ­Œå”±æ•°ãƒˆãƒ¬ãƒ³ãƒ‰ã‚«ãƒ¼ãƒ‰
        const monthlyCountCard = document.getElementById('monthlyTrendCard');
        if (cat === 'song') {
          monthlyCountCard.style.display = 'block';
          // æœˆåˆ¥æ­Œå”±å›æ•°é›†è¨ˆ
          const monthlyCount = {};
          for (let m = 1; m <= 12; m++) monthlyCount[m] = { '2024': 0, '2025': 0 };
          for (const [year, rows] of [['2024', rows2024], ['2025', rows2025]]) {
            rows.slice(2).forEach(row => {
              if (!row[0] || !/^\d{5}/.test(row[0])) return;
              const d = parseDate(row[0]); if (!d) return;
              if (startDate && d < startDate) return;
              if (endDate && d > endDate) return;
              const name = row[3]; if (!name || !name.trim()) return;
              monthlyCount[d.getMonth()+1][year]++;
            });
          }
          const months = ['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
          monthlyCountChartInst = destroyChart(monthlyCountChartInst);
          const ctxMC = document.getElementById('monthlyCountChart').getContext('2d');
          monthlyCountChartInst = new Chart(ctxMC, {
            type: 'line',
            data: {
              labels: months,
              datasets: [
                { label: '2024', data: months.map((_,i) => monthlyCount[i+1]['2024']), borderColor: COLORS[1], backgroundColor: 'rgba(212,175,55,0.1)', fill: true, tension: 0.4, pointRadius: 5, pointHoverRadius: 8 },
                { label: '2025', data: months.map((_,i) => monthlyCount[i+1]['2025']), borderColor: COLORS[0], backgroundColor: 'rgba(244,114,182,0.1)', fill: true, tension: 0.4, pointRadius: 5, pointHoverRadius: 8 }
              ]
            },
            options: {
              responsive: true, maintainAspectRatio: false,
              plugins: {
                legend: { position: 'bottom', labels: { font: { family: 'Zen Maru Gothic', size: 11 }, padding: 14, boxWidth: 12 } },
                tooltip: { callbacks: { label: ctx => ` ${ctx.dataset.label}: ${ctx.parsed.y}å›` } },
                datalabels: { display: ctx => ctx.dataset.data[ctx.dataIndex] > 0, color: ctx => ctx.dataset.borderColor, font: { family: 'DM Mono', size: 10, weight: '700' }, anchor: 'end', align: 'top', offset: 2 }
              },
              scales: {
                x: { grid: { display: false }, ticks: { font: { family: 'Zen Maru Gothic', size: 10 } } },
                y: { grid: { color: 'rgba(0,0,0,0.04)' }, ticks: { font: { family: 'DM Mono', size: 10 } } }
              }
            }
          });
        } else {
          monthlyCountCard.style.display = 'none';
        }

        // --- å…¬æ¼”æ•°ã‚°ãƒ©ãƒ• ---
        eventChartInst = destroyChart(eventChartInst);
        const ctx1 = document.getElementById('eventChart').getContext('2d');
        eventChartInst = new Chart(ctx1, {
          type: 'bar',
          data: {
            labels: ['2024å¹´', '2025å¹´'],
            datasets: [{ data: [eventCounts['2024'], eventCounts['2025']], backgroundColor: [COLORS[1], COLORS[0]], borderRadius: 10, borderSkipped: false }]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: { callbacks: { label: ctx => ` ${ctx.parsed.y}å…¬æ¼”` } },
              datalabels: { color: '#fff', font: { family: 'DM Mono', size: 16, weight: '700' }, formatter: v => v + 'å…¬æ¼”', anchor: 'center', align: 'center' }
            },
            scales: {
              x: { grid: { display: false }, ticks: { font: { family: 'Zen Maru Gothic', size: 12 } } },
              y: { grid: { color: 'rgba(0,0,0,0.04)' }, ticks: { font: { family: 'DM Mono' } } }
            }
          }
        });

        // --- æœˆåˆ¥å…¬æ¼”æ•°ã‚°ãƒ©ãƒ• ---
        const months = ['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
        monthlyChartInst = destroyChart(monthlyChartInst);
        const ctx2 = document.getElementById('monthlyChart').getContext('2d');
        monthlyChartInst = new Chart(ctx2, {
          type: 'line',
          data: {
            labels: months,
            datasets: [
              { label: '2024', data: months.map((_,i) => monthlyEventData[i+1]['2024']), borderColor: COLORS[1], backgroundColor: 'rgba(212,175,55,0.1)', fill: true, tension: 0.4, pointRadius: 4 },
              { label: '2025', data: months.map((_,i) => monthlyEventData[i+1]['2025']), borderColor: COLORS[0], backgroundColor: 'rgba(244,114,182,0.1)', fill: true, tension: 0.4, pointRadius: 4 }
            ]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom', labels: { font: { family: 'Zen Maru Gothic', size: 11 }, padding: 12, boxWidth: 12 } },
              tooltip: { callbacks: { label: ctx => ` ${ctx.dataset.label}: ${ctx.parsed.y}å…¬æ¼”` } },
              datalabels: { display: false }
            },
            scales: {
              x: { grid: { display: false }, ticks: { font: { family: 'Zen Maru Gothic', size: 10 } } },
              y: { grid: { color: 'rgba(0,0,0,0.04)' }, ticks: { font: { family: 'DM Mono' } } }
            }
          }
        });

        // --- ãƒ¡ã‚¤ãƒ³æ¯”è¼ƒã‚°ãƒ©ãƒ•ï¼ˆãƒ‰ãƒªãƒ«ãƒ€ã‚¦ãƒ³ä»˜ãï¼‰ ---
        trendChartInst = destroyChart(trendChartInst);
        const ctx3 = document.getElementById('trendChart').getContext('2d');
        const isCombo = cat === 'combo';
        trendChartInst = new Chart(ctx3, {
          type: 'bar',
          data: {
            labels: combined.map(d => d.name.length > 14 ? d.name.slice(0,14)+'â€¦' : d.name),
            fullLabels: combined.map(d => d.name),
            datasets: [
              { label: '2024', data: combined.map(d => d.v2024), backgroundColor: 'rgba(212,175,55,0.85)', borderRadius: 4, borderSkipped: false },
              { label: '2025', data: combined.map(d => d.v2025), backgroundColor: 'rgba(244,114,182,0.85)', borderRadius: 4, borderSkipped: false }
            ]
          },
          options: {
            indexAxis: 'y',
            responsive: true, maintainAspectRatio: false,
            onClick: (evt, elements) => {
              if (elements.length > 0 && !isCombo) {
                const idx = elements[0].index;
                const songName = combined[idx].name;
                openDrill(songName, rows2024, rows2025, combined[idx]);
              }
            },
            plugins: {
              legend: { position: 'top', labels: { font: { family: 'Zen Maru Gothic', size: 12 }, padding: 16, boxWidth: 12 } },
              tooltip: { callbacks: { label: ctx => ` ${ctx.dataset.label}: ${ctx.parsed.x}å›` } },
              datalabels: {
                display: ctx => ctx.parsed.x > 0,
                color: '#fff',
                font: { family: 'DM Mono', size: 10, weight: '700' },
                formatter: v => v,
                anchor: 'end',
                align: 'start',
                offset: 4,
                clamp: true
              }
            },
            scales: {
              x: { grid: { color: 'rgba(0,0,0,0.04)' }, ticks: { font: { family: 'DM Mono' } } },
              y: { grid: { display: false }, ticks: { font: { family: 'Zen Maru Gothic', size: 11 } } }
            }
          }
        });

        // ã‚«ãƒ¼ã‚½ãƒ«ã‚’ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã«
        document.getElementById('trendChart').style.cursor = isCombo ? 'default' : 'pointer';

      } catch (e) {
        alert('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
        console.error(e);
      } finally {
        showLoading(false);
      }
    }

    // ãƒ‰ãƒªãƒ«ãƒ€ã‚¦ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«
    function openDrill(songName, rows2024, rows2025, songData) {
      const details2024 = getSongDetails(rows2024, songName, '2024');
      const details2025 = getSongDetails(rows2025, songName, '2025');

      document.getElementById('drillSongName').textContent = songName;
      document.getElementById('drillSongSub').textContent = `2024: ${songData.v2024}å› ï¼ 2025: ${songData.v2025}å› ï¼ åˆè¨ˆ: ${songData.total}å›`;

      const delta = songData.v2025 - songData.v2024;
      const growth = songData.v2024 > 0 ? ((delta/songData.v2024)*100).toFixed(1) : 'â€”';
      document.getElementById('drill2024').innerHTML = `<div style="font-size:11px;color:var(--text-muted);margin-bottom:4px;">2024å¹´</div><div style="font-size:28px;font-weight:700;color:var(--gold);">${songData.v2024}å›</div>`;
      document.getElementById('drill2025').innerHTML = `<div style="font-size:11px;color:var(--text-muted);margin-bottom:4px;">2025å¹´ <span style="font-size:12px;color:${delta>=0?'#34d399':'#f87171'};font-weight:700;">${delta>=0?'â–²':'â–¼'}${Math.abs(delta)}å› (${delta>=0?'+':''}${growth}%)</span></div><div style="font-size:28px;font-weight:700;color:var(--pink);">${songData.v2025}å›</div>`;

      // æœˆåˆ¥ã‚°ãƒ©ãƒ•
      drillMonthChartInst = destroyChart(drillMonthChartInst);
      const months = ['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
      const ctxD = document.getElementById('drillMonthChart').getContext('2d');
      drillMonthChartInst = new Chart(ctxD, {
        type: 'bar',
        data: {
          labels: months,
          datasets: [
            { label: '2024', data: months.map((_,i) => details2024.monthly[i+1]), backgroundColor: 'rgba(212,175,55,0.8)', borderRadius: 4 },
            { label: '2025', data: months.map((_,i) => details2025.monthly[i+1]), backgroundColor: 'rgba(244,114,182,0.8)', borderRadius: 4 }
          ]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom', labels: { font: { family: 'Zen Maru Gothic', size: 11 }, padding: 10, boxWidth: 10 } },
            datalabels: { display: ctx => ctx.parsed.y > 0, color: '#fff', font: { family: 'DM Mono', size: 9, weight: '700' }, anchor: 'center', align: 'center' }
          },
          scales: {
            x: { grid: { display: false }, ticks: { font: { family: 'Zen Maru Gothic', size: 10 } } },
            y: { grid: { color: 'rgba(0,0,0,0.04)' }, ticks: { font: { family: 'DM Mono', size: 10 } }, beginAtZero: true }
          }
        }
      });

      // ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§
      const allEvents = [
        ...details2024.events.map(e => ({...e, year: '2024'})),
        ...details2025.events.map(e => ({...e, year: '2025'}))
      ].sort((a,b) => b.date - a.date).slice(0, 20);

      const eventHtml = allEvents.map(e => {
        const dateStr = `${e.date.getFullYear()}/${String(e.date.getMonth()+1).padStart(2,'0')}/${String(e.date.getDate()).padStart(2,'0')}`;
        const color = e.year === '2025' ? 'var(--pink)' : 'var(--gold)';
        return `<div style="display:flex;gap:10px;align-items:flex-start;padding:8px 12px;background:var(--bg);border-radius:10px;">
          <span style="font-size:10px;font-weight:700;color:#fff;background:${color};padding:2px 7px;border-radius:20px;flex-shrink:0;margin-top:1px;">${e.year}</span>
          <div><div style="font-size:12px;font-weight:600;color:var(--text);">${e.title}</div><div style="font-size:11px;color:var(--text-muted);">${dateStr}</div></div>
        </div>`;
      }).join('');
      document.getElementById('drillEventList').innerHTML = eventHtml || '<div style="color:var(--text-muted);font-size:13px;">ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ãªã—</div>';

      document.getElementById('drillModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
    }

    function closeDrill() {
      document.getElementById('drillModal').style.display = 'none';
      document.body.style.overflow = '';
      drillMonthChartInst = destroyChart(drillMonthChartInst);
    }

    // ============================================================
    // UI ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    // ============================================================
    let compareHasRun = false;
    function switchTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.getElementById('tab-' + tabId).classList.add('active');

      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      const navBtns = document.querySelectorAll('.nav-btn');
      const tabOrder = ['single', 'ranking', 'compare'];
      const idx = tabOrder.indexOf(tabId);
      if (navBtns[idx]) navBtns[idx].classList.add('active');

      document.querySelectorAll('.mobile-nav-btn').forEach(b => b.classList.remove('active'));
      const mBtn = document.getElementById('mnav-' + tabId);
      if (mBtn) mBtn.classList.add('active');

      // å¹´åº¦æ¯”è¼ƒã‚¿ãƒ–ã‚’åˆã‚ã¦é–‹ã„ãŸã‚‰è‡ªå‹•å®Ÿè¡Œ
      if (tabId === 'compare' && !compareHasRun) {
        compareHasRun = true;
        runCompare();
      }
    }

    function resetFilters() {
      document.getElementById('yearSelect').value = '2025';
      document.getElementById('columnSelect').value = 'song';
      document.getElementById('chartTypeSelect').value = 'bar';
      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';
      document.getElementById('limitSelect').value = '10';
      document.getElementById('statsRow').style.display = 'none';
      document.getElementById('emptyState').style.display = 'flex';
      document.getElementById('chartTitleText').textContent = 'åˆ†æçµæœ';
      document.getElementById('chartSubtitle').textContent = 'åˆ†æè¨­å®šã‚’é¸æŠã—ã¦ã€Œåˆ†æã‚’é–‹å§‹ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„';
      mainChartInstance = destroyChart(mainChartInstance);
    }

    function showLoading(show) {
      document.getElementById('loading').classList.toggle('show', show);
    }
  </script>
</body>
</html>
