<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãŸã‹ã­ã“ æ¥½æ›²åˆ†æ Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
  <style>
    :root {
      --pink:#f472b6; --pink-light:#fce7f3; --pink-dark:#db2777; --pink-soft:#fbcfe8;
      --gold:#d4af37; --gold-light:#fef9e7;
      --bg:#fff5f9; --surface:#ffffff; --text:#3d2b35; --text-muted:#9d6b8a;
      --border:#fad4e8; --radius:20px;
      --shadow:0 4px 24px rgba(244,114,182,0.12);
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:'Zen Maru Gothic',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;
      background-image:radial-gradient(circle at 20% 20%,rgba(244,114,182,0.08) 0%,transparent 50%),
      radial-gradient(circle at 80% 80%,rgba(212,175,55,0.06) 0%,transparent 50%);}

    /* HEADER */
    header{background:var(--surface);border-bottom:1px solid var(--border);padding:0 20px;position:sticky;top:0;z-index:100;box-shadow:0 2px 12px rgba(244,114,182,0.08);}
    .header-inner{max-width:1280px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;height:64px;gap:10px;}
    .logo{display:flex;flex-direction:column;line-height:1.2;flex-shrink:0;}
    .logo-sub{font-size:9px;letter-spacing:2px;color:var(--gold);font-family:'DM Mono',monospace;text-transform:uppercase;}
    .logo-main{font-size:15px;font-weight:700;color:var(--pink-dark);}
    nav{display:flex;gap:4px;flex-shrink:0;}
    .nav-btn{padding:7px 13px;border:1.5px solid var(--border);background:transparent;color:var(--text-muted);border-radius:50px;cursor:pointer;font-family:'Zen Maru Gothic',sans-serif;font-size:12px;font-weight:500;transition:all .2s;white-space:nowrap;}
    .nav-btn:hover{border-color:var(--pink);color:var(--pink);background:var(--pink-light);}
    .nav-btn.active{background:var(--pink);border-color:var(--pink);color:#fff;box-shadow:0 2px 12px rgba(244,114,182,0.3);}
    .official-links{display:flex;gap:5px;flex-shrink:0;}
    .link-btn{padding:5px 10px;border-radius:50px;text-decoration:none;font-size:10px;font-weight:700;color:#fff;transition:all .2s;white-space:nowrap;}
    .link-btn:hover{transform:translateY(-2px);opacity:.85;}
    .link-web{background:var(--pink);} .link-x{background:#000;} .link-yt{background:#f00;} .link-fc{background:var(--gold);}

    /* MAIN */
    main{max-width:1280px;margin:0 auto;padding:22px 18px;}
    .tab-content{display:none;animation:fadeUp .3s ease;}
    .tab-content.active{display:block;}
    @keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

    /* CARDS */
    .card{background:var(--surface);border-radius:var(--radius);padding:18px;border:1px solid var(--border);box-shadow:var(--shadow);margin-bottom:16px;}
    .card-title{font-size:11px;font-weight:700;letter-spacing:2px;color:var(--gold);font-family:'DM Mono',monospace;text-transform:uppercase;margin-bottom:12px;}
    .chart-card{background:var(--surface);border-radius:var(--radius);border:1px solid var(--border);box-shadow:var(--shadow);padding:18px;margin-bottom:16px;position:relative;min-height:380px;}
    .chart-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px;flex-wrap:wrap;gap:8px;}
    .chart-title{font-size:15px;font-weight:700;color:var(--text);}
    .chart-subtitle{font-size:11px;color:var(--text-muted);margin-top:2px;}
    .chart-wrap{position:relative;height:380px;}

    /* CONTROLS */
    .controls-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(155px,1fr));gap:10px;align-items:end;}
    .field{display:flex;flex-direction:column;gap:4px;}
    .field label{font-size:11px;font-weight:700;color:var(--pink-dark);}
    select,input[type=date],input[type=month]{padding:8px 30px 8px 11px;border:1.5px solid var(--border);border-radius:11px;font-family:'Zen Maru Gothic',sans-serif;font-size:13px;color:var(--text);background:var(--surface);outline:none;transition:border-color .2s;width:100%;appearance:none;-webkit-appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%239d6b8a' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;}
    input[type=date],input[type=month]{background-image:none;padding-right:11px;}
    select:focus,input:focus{border-color:var(--pink);box-shadow:0 0 0 3px rgba(244,114,182,0.1);}
    .btn-row{display:flex;gap:8px;align-items:center;padding-top:2px;}
    .btn{padding:9px 16px;border-radius:50px;border:none;font-family:'Zen Maru Gothic',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:all .2s;white-space:nowrap;}
    .btn-primary{background:var(--pink);color:#fff;flex:1;box-shadow:0 2px 12px rgba(244,114,182,0.25);}
    .btn-primary:hover{background:var(--pink-dark);transform:translateY(-2px);}
    .btn-secondary{background:#f3f4f6;color:#888;}
    .btn-secondary:hover{background:#e5e7eb;}
    .btn-gold{background:var(--gold);color:#fff;box-shadow:0 2px 12px rgba(212,175,55,0.25);}
    .btn-gold:hover{transform:translateY(-2px);opacity:.9;}
    .notice{background:var(--pink-light);border-left:3px solid var(--pink);padding:8px 12px;border-radius:8px;font-size:11px;color:var(--pink-dark);margin-top:10px;line-height:1.6;}

    /* ZOOM HINT */
    .zoom-hint{display:inline-flex;align-items:center;gap:4px;font-size:10px;color:var(--text-muted);background:var(--pink-light);padding:3px 9px;border-radius:20px;font-family:'DM Mono',monospace;}
    .zoom-reset-btn{padding:3px 9px;border-radius:20px;border:1.5px solid var(--border);background:var(--surface);color:var(--text-muted);font-size:11px;cursor:pointer;font-family:'Zen Maru Gothic',sans-serif;font-weight:700;transition:all .2s;}
    .zoom-reset-btn:hover{border-color:var(--pink);color:var(--pink);}

    /* EMPTY STATE */
    .empty-state{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--text-muted);gap:12px;}
    .empty-icon{font-size:48px;opacity:.4;} .empty-text{font-size:14px;}

    /* STATS PILLS */
    .stats-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;}
    .stat-pill{background:var(--surface);border:1px solid var(--border);border-radius:50px;padding:6px 14px;display:flex;align-items:center;gap:7px;box-shadow:var(--shadow);}
    .stat-label{font-size:10px;color:var(--text-muted);}
    .stat-val{font-family:'DM Mono',monospace;font-size:14px;font-weight:500;color:var(--pink-dark);}

    /* RANKING */
    .ranking-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(255px,1fr));gap:7px;}
    .ranking-item{display:flex;align-items:center;gap:11px;padding:11px 13px;background:var(--surface);border:1px solid var(--border);border-radius:13px;transition:all .2s;cursor:pointer;}
    .ranking-item:hover{border-color:var(--pink);box-shadow:var(--shadow);transform:translateY(-2px);}
    .rank-num{font-family:'DM Mono',monospace;font-size:16px;font-weight:500;color:var(--pink-soft);width:28px;flex-shrink:0;text-align:center;}
    .rank-num.top1{color:var(--gold);font-size:20px;} .rank-num.top2{color:#b0b0b0;font-size:18px;} .rank-num.top3{color:#cd7f32;font-size:18px;}
    .rank-name{flex:1;font-size:13px;font-weight:700;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .rank-count{font-family:'DM Mono',monospace;font-size:13px;font-weight:500;color:var(--gold);flex-shrink:0;}
    .rank-bar-wrap{width:100%;height:3px;background:var(--border);border-radius:2px;margin-top:5px;overflow:hidden;}
    .rank-bar{height:100%;background:linear-gradient(90deg,var(--pink),var(--gold));border-radius:2px;transition:width .8s cubic-bezier(.4,0,.2,1);}

    /* COMPARE */
    .compare-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;}
    .chart-half{background:var(--surface);border-radius:var(--radius);border:1px solid var(--border);box-shadow:var(--shadow);padding:16px;}
    .chart-half-wrap{position:relative;height:260px;}
    .stat-badge{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:12px 16px;box-shadow:var(--shadow);}

    /* CATEGORY BTNS */
    .cat-btn{padding:5px 11px;border:1.5px solid var(--border);border-radius:20px;background:var(--surface);color:var(--text-muted);font-family:'Zen Maru Gothic',sans-serif;font-size:11px;font-weight:700;cursor:pointer;transition:all .18s;white-space:nowrap;}
    .cat-btn:hover{border-color:var(--pink);color:var(--pink-dark);background:var(--pink-light);}
    .cat-btn.active{background:linear-gradient(135deg,var(--pink),var(--pink-dark));border-color:var(--pink-dark);color:#fff;box-shadow:0 3px 12px rgba(244,114,182,0.35);}
    .cat-group{display:flex;gap:5px;flex-wrap:wrap;}

    /* PREF */
    .pref-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(125px,1fr));gap:7px;}
    .pref-card{background:var(--surface);border:1px solid var(--border);border-radius:13px;padding:11px;text-align:center;transition:all .2s;cursor:pointer;}
    .pref-card:hover{border-color:var(--pink);transform:translateY(-2px);box-shadow:var(--shadow);}
    .pref-name{font-size:11px;font-weight:700;color:var(--text);margin-bottom:3px;}
    .pref-count{font-family:'DM Mono',monospace;font-size:20px;font-weight:500;color:var(--pink-dark);}
    .pref-sub{font-size:9px;color:var(--text-muted);}
    .pref-top{font-size:9px;color:var(--gold);font-weight:700;margin-top:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

    /* LOADING */
    .loading-overlay{position:fixed;inset:0;background:rgba(255,245,249,0.92);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:9999;gap:16px;backdrop-filter:blur(4px);}
    .loading-overlay.show{display:flex;}
    .spinner{width:44px;height:44px;border:3px solid var(--pink-soft);border-top-color:var(--pink);border-radius:50%;animation:spin .8s linear infinite;}
    .loading-text{font-size:13px;color:var(--text-muted);font-family:'DM Mono',monospace;letter-spacing:2px;}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* MOBILE NAV */
    .mobile-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--surface);border-top:1px solid var(--border);padding:7px 12px env(safe-area-inset-bottom,10px);z-index:100;gap:3px;}
    .mobile-nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px 3px;border:none;background:transparent;color:var(--text-muted);font-family:'Zen Maru Gothic',sans-serif;font-size:9px;font-weight:500;cursor:pointer;border-radius:11px;transition:all .2s;}
    .mobile-nav-btn.active{color:var(--pink);background:var(--pink-light);}
    .mobile-nav-icon{font-size:18px;}

    /* DRILL MODAL */
    .drill-modal{display:none;position:fixed;inset:0;z-index:1000;background:rgba(61,43,53,0.55);backdrop-filter:blur(6px);overflow-y:auto;padding:18px 14px;}
    .drill-inner{max-width:760px;margin:0 auto;background:var(--surface);border-radius:var(--radius);box-shadow:0 20px 80px rgba(244,114,182,0.25);overflow:hidden;}
    .drill-head{background:linear-gradient(135deg,var(--pink),var(--pink-dark));padding:20px 24px;display:flex;justify-content:space-between;align-items:center;}
    .drill-close{background:rgba(255,255,255,0.2);border:none;border-radius:50%;width:34px;height:34px;cursor:pointer;font-size:17px;color:#fff;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:background .2s;}
    .drill-close:hover{background:rgba(255,255,255,0.35);}
    .drill-body{padding:20px 24px;}

    /* RESPONSIVE */
    @media(max-width:900px){.compare-grid{grid-template-columns:1fr;}}
    @media(max-width:768px){
      header{padding:0 12px;} .header-inner{height:52px;} .logo-main{font-size:13px;}
      nav{display:none;} .official-links{display:none;}
      main{padding:12px 10px 80px;}
      .controls-grid{grid-template-columns:1fr 1fr;}
      .mobile-nav{display:flex;}
      .card{padding:13px;} .chart-card{padding:13px;min-height:300px;}
      .chart-wrap{height:280px;} .chart-half-wrap{height:210px;}
      .ranking-grid{grid-template-columns:1fr;}
      .drill-body{padding:14px;} .drill-head{padding:14px 16px;}
      .pref-grid{grid-template-columns:repeat(auto-fill,minmax(100px,1fr));}
    }
    @media(max-width:480px){
      .controls-grid{grid-template-columns:1fr;}
      .stats-row{gap:5px;} .cat-btn{font-size:10px;padding:4px 9px;}
    }
  </style>
</head>
<body>

<header>
  <div class="header-inner">
    <div class="logo">
      <span class="logo-sub">Advanced Performance Analysis</span>
      <span class="logo-main">ãŸã‹ã­ã“ æ¥½æ›²åˆ†æ Portal</span>
    </div>
    <nav>
      <button class="nav-btn active" onclick="switchTab('single')">æœŸé–“ãƒ»è©³ç´°åˆ†æ</button>
      <button class="nav-btn" onclick="switchTab('ranking')">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ä¸€è¦§</button>
      <button class="nav-btn" onclick="switchTab('compare')">å¹´åº¦æ¯”è¼ƒ</button>
      <button class="nav-btn" onclick="switchTab('pref')">éƒ½é“åºœçœŒåˆ†æ</button>
    </nav>
    <div class="official-links">
      <a href="https://takanenonadeshiko.jp/" target="_blank" class="link-btn link-web">å…¬å¼</a>
      <a href="https://x.com/takanenofficial" target="_blank" class="link-btn link-x">X</a>
      <a href="https://www.youtube.com/channel/UCoR4zZDvWvUIqgEWz4HS-sA" target="_blank" class="link-btn link-yt">YT</a>
      <a href="https://takanekofc.com/#/" target="_blank" class="link-btn link-fc">FC</a>
    </div>
  </div>
</header>

<main>

  <!-- TAB: æœŸé–“ãƒ»è©³ç´°åˆ†æ -->
  <div id="tab-single" class="tab-content active">
    <div class="card">
      <div class="card-title">ğŸ” Analysis Settings</div>
      <div class="controls-grid">
        <div class="field">
          <label>å¯¾è±¡å¹´</label>
          <select id="yearSelect">
            <option value="2025">2025å¹´</option>
            <option value="2024">2024å¹´</option>
            <option value="2023">2023å¹´</option>
          </select>
        </div>
        <div class="field">
          <label>åˆ†æã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
          <select id="columnSelect">
            <optgroup label="åŸºæœ¬">
              <option value="song">â˜… æ¥½æ›²åˆ¥ æ­Œå”±å›æ•°</option>
              <option value="first">ã€1æ›²ç›®ã€‘å‡ºç¾å›æ•°</option>
              <option value="last">ã€ãƒˆãƒªã€‘å‡ºç¾å›æ•°</option>
              <option value="combo">é‰„æ¿ã‚³ãƒ³ãƒœåˆ†æ</option>
            </optgroup>
            <optgroup label="å­£ç¯€åˆ¥">
              <option value="spring">æ˜¥ (3ã€œ5æœˆ)</option>
              <option value="summer">å¤ (6ã€œ8æœˆ)</option>
              <option value="autumn">ç§‹ (9ã€œ11æœˆ)</option>
              <option value="winter">å†¬ (12ã€œ2æœˆ)</option>
            </optgroup>
            <optgroup label="ã‚»ãƒƒãƒˆè¦æ¨¡åˆ¥">
              <option value="shortFirst">å°‘æ›²æ•°(1-4æ›²)1æ›²ç›®</option>
              <option value="longFirst">å¤šæ›²æ•°(5æ›²ä»¥ä¸Š)1æ›²ç›®</option>
            </optgroup>
            <optgroup label="âœ¨ NEW: ã‚¤ãƒ™ãƒ³ãƒˆç¨®åˆ¥">
              <option value="fesFirst">ãƒ•ã‚§ã‚¹/å¯¾ãƒãƒ³é™å®š 1æ›²ç›®</option>
              <option value="fesSong">ãƒ•ã‚§ã‚¹/å¯¾ãƒãƒ³é™å®š TOPæ›²</option>
              <option value="onemanFirst">ãƒ¯ãƒ³ãƒãƒ³é™å®š 1æ›²ç›®</option>
              <option value="onemanSong">ãƒ¯ãƒ³ãƒãƒ³é™å®š TOPæ›²</option>
              <option value="multiFirst">äºŒéƒ¨åˆ¶é™å®š 1æ›²ç›®</option>
            </optgroup>
          </select>
        </div>
        <div class="field">
          <label>ã‚°ãƒ©ãƒ•ç¨®åˆ¥</label>
          <select id="chartTypeSelect">
            <option value="bar">ç¸¦æ£’ã‚°ãƒ©ãƒ•</option>
            <option value="horizontalBar">æ¨ªæ£’ã‚°ãƒ©ãƒ•</option>
            <option value="pie">å††ã‚°ãƒ©ãƒ•</option>
            <option value="doughnut">ãƒ‰ãƒ¼ãƒŠãƒ„ã‚°ãƒ©ãƒ•</option>
          </select>
        </div>
        <div class="field">
          <label>æœŸé–“ï¼ˆé–‹å§‹ï¼‰</label>
          <input type="date" id="startDate">
        </div>
        <div class="field">
          <label>æœŸé–“ï¼ˆçµ‚äº†ï¼‰</label>
          <input type="date" id="endDate">
        </div>
        <div class="field">
          <label>è¡¨ç¤ºä»¶æ•°</label>
          <select id="limitSelect">
            <option value="10">ä¸Šä½10ä»¶</option>
            <option value="20">ä¸Šä½20ä»¶</option>
            <option value="30">ä¸Šä½30ä»¶</option>
            <option value="999">å…¨ä»¶</option>
          </select>
        </div>
      </div>
      <div class="btn-row" style="margin-top:12px;">
        <button class="btn btn-primary" onclick="analyze()">ğŸ“Š åˆ†æã‚’é–‹å§‹ã™ã‚‹</button>
        <button class="btn btn-secondary" onclick="resetFilters()">ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
      <div class="notice">ğŸ’¡ ã‚°ãƒ©ãƒ•ã¯ãƒ‰ãƒ©ãƒƒã‚°ã§ç¯„å›²ã‚ºãƒ¼ãƒ ãƒ»ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ãƒªã‚»ãƒƒãƒˆã€‚ãƒãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨æ›²ã®è©³ç´°ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</div>
    </div>

    <div class="stats-row" id="statsRow" style="display:none;">
      <div class="stat-pill"><span class="stat-label">ç·æ¥½æ›²æ•°</span><span class="stat-val" id="stat-songs">-</span></div>
      <div class="stat-pill"><span class="stat-label">ç·æ­Œå”±å›æ•°</span><span class="stat-val" id="stat-total">-</span></div>
      <div class="stat-pill"><span class="stat-label">æœ€å¤šæ¥½æ›²</span><span class="stat-val" id="stat-top">-</span></div>
    </div>

    <div class="chart-card">
      <div class="chart-header">
        <div>
          <div class="chart-title" id="chartTitleText">åˆ†æçµæœ</div>
          <div class="chart-subtitle" id="chartSubtitle">åˆ†æè¨­å®šã‚’é¸æŠã—ã¦ã€Œåˆ†æã‚’é–‹å§‹ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
        </div>
        <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
          <span class="zoom-hint">ğŸ” ãƒ‰ãƒ©ãƒƒã‚°ã§ã‚ºãƒ¼ãƒ </span>
          <button class="zoom-reset-btn" onclick="resetMainZoom()">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
      </div>
      <div class="chart-wrap">
        <canvas id="mainChart"></canvas>
        <div class="empty-state" id="emptyState">
          <div class="empty-icon">ğŸµ</div>
          <div class="empty-text">åˆ†æã‚’å®Ÿè¡Œã™ã‚‹ã¨çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
        </div>
      </div>
    </div>
  </div>

  <!-- TAB: ãƒ©ãƒ³ã‚­ãƒ³ã‚°ä¸€è¦§ -->
  <div id="tab-ranking" class="tab-content">
    <div class="card">
      <div class="card-title">ğŸ† Ranking List</div>
      <p style="font-size:13px;color:var(--text-muted);">ã€ŒæœŸé–“ãƒ»è©³ç´°åˆ†æã€ã§åˆ†æã‚’å®Ÿè¡Œã™ã‚‹ã¨ã“ã“ã«ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚å„ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°è¡¨ç¤ºã€‚</p>
    </div>
    <div class="ranking-grid" id="rankingGrid"></div>
  </div>

  <!-- TAB: å¹´åº¦æ¯”è¼ƒ -->
  <div id="tab-compare" class="tab-content">
    <div class="card">
      <div class="card-title">ğŸ“ˆ Year Comparison</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;">
        <div style="display:flex;flex-direction:column;gap:4px;flex:1;min-width:200px;">
          <label style="font-size:11px;color:var(--text-muted);font-weight:700;">ã‚«ãƒ†ã‚´ãƒª</label>
          <div class="cat-group">
            <button class="cat-btn active" data-cat="song" onclick="setCompareCategory(this,'song')">ğŸµ å…¨æ›²</button>
            <button class="cat-btn" data-cat="first" onclick="setCompareCategory(this,'first')">ğŸ¤ 1æ›²ç›®</button>
            <button class="cat-btn" data-cat="last" onclick="setCompareCategory(this,'last')">ğŸ† ãƒˆãƒª</button>
            <button class="cat-btn" data-cat="spring" onclick="setCompareCategory(this,'spring')">ğŸŒ¸ æ˜¥</button>
            <button class="cat-btn" data-cat="summer" onclick="setCompareCategory(this,'summer')">â˜€ï¸ å¤</button>
            <button class="cat-btn" data-cat="autumn" onclick="setCompareCategory(this,'autumn')">ğŸ‚ ç§‹</button>
            <button class="cat-btn" data-cat="winter" onclick="setCompareCategory(this,'winter')">â„ï¸ å†¬</button>
            <button class="cat-btn" data-cat="combo" onclick="setCompareCategory(this,'combo')">ğŸ”— ã‚³ãƒ³ãƒœ</button>
            <button class="cat-btn" data-cat="fesFirst" onclick="setCompareCategory(this,'fesFirst')">ğŸª ãƒ•ã‚§ã‚¹1æ›²ç›®</button>
            <button class="cat-btn" data-cat="onemanFirst" onclick="setCompareCategory(this,'onemanFirst')">ğŸŸ ãƒ¯ãƒ³ãƒãƒ³1æ›²ç›®</button>
          </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:4px;">
          <label style="font-size:11px;color:var(--text-muted);font-weight:700;">è¡¨ç¤ºä»¶æ•°</label>
          <select id="compareLimit" style="height:36px;padding:0 28px 0 10px;" onchange="runCompare()">
            <option value="10">Top 10</option><option value="15" selected>Top 15</option>
            <option value="20">Top 20</option><option value="30">Top 30</option>
          </select>
        </div>
        <div style="display:flex;flex-direction:column;gap:4px;">
          <label style="font-size:11px;color:var(--text-muted);font-weight:700;">æœŸé–“ï¼ˆé–‹å§‹ï¼‰</label>
          <input type="month" id="compareStart" style="height:36px;padding:0 10px;" onchange="runCompare()">
        </div>
        <div style="display:flex;flex-direction:column;gap:4px;">
          <label style="font-size:11px;color:var(--text-muted);font-weight:700;">æœŸé–“ï¼ˆçµ‚äº†ï¼‰</label>
          <input type="month" id="compareEnd" style="height:36px;padding:0 10px;" onchange="runCompare()">
        </div>
        <button class="btn btn-gold" onclick="runCompare()">ğŸ”„ åˆ†æå®Ÿè¡Œ</button>
        <button class="btn" style="background:var(--pink-light);color:var(--pink-dark);" onclick="resetCompare()">âœ• ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>

    <div id="compareSummary" style="display:none;margin-bottom:14px;">
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;">
        <div class="stat-badge" id="cs2024"></div>
        <div class="stat-badge" id="cs2025"></div>
        <div class="stat-badge" id="csDelta"></div>
        <div class="stat-badge" id="csGrowth"></div>
      </div>
    </div>

    <div class="compare-grid">
      <div class="chart-half">
        <div class="chart-title" style="font-size:13px;margin-bottom:10px;">å¹´åº¦åˆ¥ å…¬æ¼”æ•°</div>
        <div class="chart-half-wrap"><canvas id="eventChart"></canvas></div>
      </div>
      <div class="chart-half">
        <div class="chart-title" style="font-size:13px;margin-bottom:10px;">æœˆåˆ¥ å…¬æ¼”æ•°æ¨ç§»</div>
        <div class="chart-half-wrap"><canvas id="monthlyChart"></canvas></div>
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-header">
        <div>
          <div class="chart-title" id="compareChartTitle">æ¥½æ›²åˆ¥ å¹´åº¦æ¯”è¼ƒ</div>
          <div class="chart-subtitle" id="compareChartSub">ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã‚“ã§åˆ†æå®Ÿè¡Œã—ã¦ãã ã•ã„</div>
        </div>
        <div style="display:flex;gap:5px;align-items:center;flex-wrap:wrap;">
          <span class="zoom-hint">ğŸ” ãƒ‰ãƒ©ãƒƒã‚°ã§ã‚ºãƒ¼ãƒ </span>
          <button class="zoom-reset-btn" onclick="resetTrendZoom()">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
      </div>
      <div style="position:relative;height:520px;"><canvas id="trendChart"></canvas></div>
    </div>

    <div class="chart-card" id="monthlyTrendCard" style="display:none;">
      <div class="chart-header">
        <div>
          <div class="chart-title">æœˆåˆ¥ æ­Œå”±å›æ•°æ¨ç§»</div>
          <div class="chart-subtitle">å„æœˆã®æ­Œå”±å›æ•°ï¼ˆå…¨æ¥½æ›²åˆè¨ˆï¼‰</div>
        </div>
        <div style="display:flex;gap:5px;">
          <span class="zoom-hint">ğŸ” ãƒ‰ãƒ©ãƒƒã‚°ã§ã‚ºãƒ¼ãƒ </span>
          <button class="zoom-reset-btn" onclick="resetMonthlyZoom()">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
      </div>
      <div style="position:relative;height:280px;"><canvas id="monthlyCountChart"></canvas></div>
    </div>
  </div>

  <!-- TAB: éƒ½é“åºœçœŒåˆ†æ -->
  <div id="tab-pref" class="tab-content">
    <div class="card">
      <div class="card-title">ğŸ—¾ Prefecture Analysis</div>
      <div class="controls-grid" style="grid-template-columns:repeat(auto-fit,minmax(155px,1fr));">
        <div class="field">
          <label>å¯¾è±¡å¹´</label>
          <select id="prefYearSelect" onchange="loadPrefData()">
            <option value="2025">2025å¹´</option>
            <option value="2024">2024å¹´</option>
            <option value="2023">2023å¹´</option>
          </select>
        </div>
      </div>
    </div>

    <div id="prefSummary" style="display:none;margin-bottom:14px;">
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(125px,1fr));gap:10px;">
        <div class="stat-badge" id="ps-visited"></div>
        <div class="stat-badge" id="ps-events"></div>
        <div class="stat-badge" id="ps-top"></div>
        <div class="stat-badge" id="ps-abroad"></div>
      </div>
    </div>

    <div class="chart-card" style="min-height:auto;">
      <div class="chart-title" style="margin-bottom:12px;">éƒ½é“åºœçœŒåˆ¥ è¨ªå•å›æ•°</div>
      <div id="prefGrid" class="pref-grid"></div>
    </div>

    <div class="chart-card">
      <div class="chart-header">
        <div>
          <div class="chart-title" id="prefChartTitle">éƒ½é“åºœçœŒåˆ¥ TOPæ›²</div>
          <div class="chart-subtitle" id="prefChartSub">éƒ½é“åºœçœŒã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è©³ç´°ã‚’è¡¨ç¤º</div>
        </div>
        <div style="display:flex;gap:5px;">
          <span class="zoom-hint">ğŸ” ãƒ‰ãƒ©ãƒƒã‚°ã§ã‚ºãƒ¼ãƒ </span>
          <button class="zoom-reset-btn" onclick="resetPrefZoom()">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
      </div>
      <div style="position:relative;height:360px;">
        <canvas id="prefChart"></canvas>
        <div class="empty-state" id="prefEmptyState">
          <div class="empty-icon">ğŸ—¾</div>
          <div class="empty-text">éƒ½é“åºœçœŒã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</div>
        </div>
      </div>
    </div>
  </div>

</main>

<!-- MOBILE NAV -->
<div class="mobile-nav" id="mobileNav">
  <button class="mobile-nav-btn active" id="mnav-single" onclick="switchTab('single')"><span class="mobile-nav-icon">ğŸ”</span>è©³ç´°åˆ†æ</button>
  <button class="mobile-nav-btn" id="mnav-ranking" onclick="switchTab('ranking')"><span class="mobile-nav-icon">ğŸ†</span>ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
  <button class="mobile-nav-btn" id="mnav-compare" onclick="switchTab('compare')"><span class="mobile-nav-icon">ğŸ“ˆ</span>å¹´åº¦æ¯”è¼ƒ</button>
  <button class="mobile-nav-btn" id="mnav-pref" onclick="switchTab('pref')"><span class="mobile-nav-icon">ğŸ—¾</span>éƒ½é“åºœçœŒ</button>
</div>

<!-- LOADING -->
<div class="loading-overlay" id="loading">
  <div class="spinner"></div>
  <div class="loading-text">NOW ANALYZING...</div>
</div>

<!-- DRILL MODAL -->
<div id="drillModal" class="drill-modal">
  <div class="drill-inner">
    <div class="drill-head">
      <div>
        <div id="drillSongName" style="font-size:18px;font-weight:700;color:#fff;"></div>
        <div id="drillSongSub" style="font-size:11px;color:rgba(255,255,255,0.75);margin-top:3px;"></div>
      </div>
      <button class="drill-close" onclick="closeDrill()">âœ•</button>
    </div>
    <div class="drill-body">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:18px;">
        <div class="stat-badge" id="drill2024"></div>
        <div class="stat-badge" id="drill2025"></div>
      </div>
      <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:9px;">ğŸ“… æœˆåˆ¥ æ­Œå”±æ¨ç§»</div>
      <div style="position:relative;height:200px;margin-bottom:16px;"><canvas id="drillMonthChart"></canvas></div>
      <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:8px;">ğŸ“‹ å‡ºæ¼”ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæœ€å¤§20ä»¶ï¼‰</div>
      <div id="drillEventList" style="display:flex;flex-direction:column;gap:5px;max-height:240px;overflow-y:auto;"></div>
    </div>
  </div>
</div>

<script>
// ============================================================
// è¨­å®š
// ============================================================
const SHEET_ID = '10QKtPdhdtaLFxxkRhdzTRVePeh3DUmib0WpEJA49Erw';
const SHEET_NAMES = {
  '2023':'æ¥½æ›²åˆ†è§£ã‚·ãƒ¼ãƒˆï¼ˆ2023ï¼‰',
  '2024':'æ¥½æ›²åˆ†è§£ã‚·ãƒ¼ãƒˆï¼ˆ2024ï¼‰',
  '2025':'æ¥½æ›²åˆ†è§£ã‚·ãƒ¼ãƒˆï¼ˆ2025ï¼‰',
};
const COLORS = [
  '#f472b6','#d4af37','#818cf8','#34d399','#fb923c',
  '#60a5fa','#e879f9','#4ade80','#f87171','#38bdf8',
  '#fbbf24','#a78bfa','#fb7185','#2dd4bf','#c084fc',
  '#f9a8d4','#86efac','#93c5fd','#fcd34d','#6ee7b7'
];

// æ¥½æ›²åˆ†è§£ã‚·ãƒ¼ãƒˆ v4 åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆ0å§‹ã¾ã‚Šï¼‰
// Aã€œK: è©³ç´°ãƒ‡ãƒ¼ã‚¿è¡Œ
const C = {
  date:0, month:1, title:2, rawSong:3, song:4, count:5, ratio:6,
  venue:7, pref:8, isFirst:9, isLast:10,
  // Lã€œ é›†è¨ˆãƒ–ãƒ­ãƒƒã‚¯ï¼ˆå„ãƒ–ãƒ­ãƒƒã‚¯2åˆ—ï¼‰
  b1n:11,b1c:12, // 1æ›²ç›®
  b2n:13,b2c:14, // ãƒˆãƒª
  b3n:15,b3c:16, // æ˜¥
  b4n:17,b4c:18, // å¤
  b5n:19,b5c:20, // ç§‹
  b6n:21,b6c:22, // å†¬
  b7n:23,b7c:24, // å°‘æ›²æ•°1æ›²ç›®
  b8n:25,b8c:26, // å¤šæ›²æ•°1æ›²ç›®
  b9n:27,b9c:28, // ã‚³ãƒ³ãƒœ
  prefRankN:29,prefRankC:30, // éƒ½é“åºœçœŒè¨ªå•ãƒ©ãƒ³ã‚­ãƒ³ã‚°
  prefTopStart:31, // éƒ½é“åºœçœŒåˆ¥TOPæ›²ï¼ˆå¯å¤‰åˆ—ï¼‰
};

const CAT_COL = {
  song:{n:C.song,c:C.count},       first:{n:C.b1n,c:C.b1c},
  last:{n:C.b2n,c:C.b2c},          spring:{n:C.b3n,c:C.b3c},
  summer:{n:C.b4n,c:C.b4c},        autumn:{n:C.b5n,c:C.b5c},
  winter:{n:C.b6n,c:C.b6c},        shortFirst:{n:C.b7n,c:C.b7c},
  longFirst:{n:C.b8n,c:C.b8c},     combo:{n:C.b9n,c:C.b9c},
};

const CAT_LABEL = {
  song:'å…¨æ¥½æ›²',first:'1æ›²ç›®',last:'ãƒˆãƒª',spring:'æ˜¥(3-5æœˆ)',summer:'å¤(6-8æœˆ)',
  autumn:'ç§‹(9-11æœˆ)',winter:'å†¬(12-2æœˆ)',shortFirst:'å°‘æ›²æ•°1æ›²ç›®',longFirst:'å¤šæ›²æ•°1æ›²ç›®',
  combo:'é‰„æ¿ã‚³ãƒ³ãƒœ',fesFirst:'ãƒ•ã‚§ã‚¹1æ›²ç›®',fesSong:'ãƒ•ã‚§ã‚¹TOPæ›²',
  onemanFirst:'ãƒ¯ãƒ³ãƒãƒ³1æ›²ç›®',onemanSong:'ãƒ¯ãƒ³ãƒãƒ³TOPæ›²',multiFirst:'äºŒéƒ¨åˆ¶1æ›²ç›®',
};

// ============================================================
// ãƒ‡ãƒ¼ã‚¿å–å¾—
// ============================================================
const sheetCache = {};
async function fetchSheet(year) {
  if (sheetCache[year]) return sheetCache[year];
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAMES[year])}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error('å–å¾—å¤±æ•—: '+year);
  const rows = parseCSV(await res.text());
  sheetCache[year] = rows;
  return rows;
}

function parseCSV(text) {
  return text.split('\n').map(line => {
    const r=[]; let q=false,cur='';
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch==='"'){if(q&&line[i+1]==='"'){cur+='"';i++;}else q=!q;}
      else if(ch===','&&!q){r.push(cur.trim());cur='';}
      else cur+=ch;
    }
    r.push(cur.trim()); return r;
  }).filter(r=>r.length>1&&r[0]);
}

function parseDate(v) {
  if (!v) return null;
  const s = String(v).trim();
  if (/^\d{5}/.test(s)) {
    const n=parseFloat(s); if(isNaN(n)) return null;
    const d=new Date(Math.round((n-25569)*86400*1000));
    return isNaN(d.getTime())?null:d;
  }
  const d=new Date(s.replace(/\//g,'-'));
  return isNaN(d.getTime())?null:d;
}

function isDataRow(row) {
  const v = String(row[C.date]||'').trim();
  return /^\d{5}/.test(v) || /^\d{4}[\/\-]/.test(v);
}

// éƒ½é“åºœçœŒãƒ–ãƒ­ãƒƒã‚¯å¾Œã®åˆ—ã‚’å‹•çš„æ¤œå‡º
function detectNewCols(rows) {
  const h = rows[0]||[];
  let prefCols=0, col=C.prefTopStart;
  while(col<h.length && h[col] && String(h[col]).indexOf('TOPæ›²')!==-1){prefCols++;col+=2;}
  const m12 = C.prefTopStart + prefCols*2; // æœˆåˆ¥ãƒ–ãƒ­ãƒƒã‚¯
  const b13  = m12 + 14;                   // ãƒ•ã‚§ã‚¹ç­‰ãƒ–ãƒ­ãƒƒã‚¯
  return {
    prefTopStart:C.prefTopStart, prefTopCols:prefCols,
    fesFirstN:b13,fesFirstC:b13+1,
    fesSongN:b13+2,fesSongC:b13+3,
    onemanFirstN:b13+4,onemanFirstC:b13+5,
    onemanSongN:b13+6,onemanSongC:b13+7,
    multiFirstN:b13+8,multiFirstC:b13+9,
  };
}

// ============================================================
// é›†è¨ˆ
// ============================================================
function aggRaw(rows, startDate, endDate) {
  const m={};
  rows.slice(2).forEach(row=>{
    if(!isDataRow(row)) return;
    if(startDate||endDate){const d=parseDate(row[C.date]);if(!d)return;if(startDate&&d<startDate)return;if(endDate&&d>endDate)return;}
    const n=row[C.rawSong]; if(!n||!n.trim()) return;
    m[n]=(m[n]||0)+1;
  });
  return Object.entries(m).sort((a,b)=>b[1]-a[1]);
}

function aggRanking(rows, nameCol, cntCol) {
  const m={};
  rows.slice(2).forEach(row=>{
    const n=row[nameCol],c=parseFloat(row[cntCol]);
    if(!n||!n.trim()||n==='æ›²å'||n==='ãƒšã‚¢'||n==='éƒ½é“åºœçœŒ'||n==='è¨ªå•éƒ½é“åºœçœŒãƒ©ãƒ³ã‚­ãƒ³ã‚°'||n==='è¨ªå•éƒ½é“åºœçœŒæ•°') return;
    if(isNaN(c)||c<=0) return;
    if(!m[n]) m[n]=c;
  });
  return Object.entries(m).sort((a,b)=>b[1]-a[1]);
}

function aggData(rows, cat, startDate, endDate) {
  if(cat==='song') return aggRaw(rows,startDate,endDate);
  const nc=detectNewCols(rows);
  const extra={
    fesFirst:{n:nc.fesFirstN,c:nc.fesFirstC},
    fesSong:{n:nc.fesSongN,c:nc.fesSongC},
    onemanFirst:{n:nc.onemanFirstN,c:nc.onemanFirstC},
    onemanSong:{n:nc.onemanSongN,c:nc.onemanSongC},
    multiFirst:{n:nc.multiFirstN,c:nc.multiFirstC},
  };
  const cfg=CAT_COL[cat]||extra[cat]; if(!cfg) return [];
  return aggRanking(rows,cfg.n,cfg.c);
}

function getSongDetails(rows, songName) {
  const monthly={}; for(let m=1;m<=12;m++) monthly[m]=0;
  const events=[]; const seen=new Set();
  rows.slice(2).forEach(row=>{
    if(!isDataRow(row)) return;
    if(row[C.rawSong]!==songName) return;
    const d=parseDate(row[C.date]); if(!d) return;
    monthly[d.getMonth()+1]++;
    const key=row[C.date]+'_'+(row[C.title]||'');
    if(!seen.has(key)){seen.add(key);events.push({date:d,title:row[C.title]||'ä¸æ˜',venue:row[C.venue]||'',pref:row[C.pref]||''});}
  });
  events.sort((a,b)=>b.date-a.date);
  return {monthly,events:events.slice(0,20)};
}

// ============================================================
// ãƒãƒ£ãƒ¼ãƒˆãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// ============================================================
Chart.register(ChartDataLabels);

function resetCanvas(id) {
  const el=document.getElementById(id); if(!el) return null;
  const p=el.parentNode;
  const nc=document.createElement('canvas'); nc.id=id; nc.style.cssText=el.style.cssText||'';
  p.replaceChild(nc,el);
  return document.getElementById(id).getContext('2d');
}

function destroyChart(inst) { if(inst){try{inst.destroy();}catch(e){}} return null; }

const ZoomPlugin = { zoom:{drag:{enabled:true,backgroundColor:'rgba(244,114,182,0.12)',borderColor:'rgba(244,114,182,0.4)',borderWidth:1},mode:'x'},pan:{enabled:false} };
const ZoomPluginY = { zoom:{drag:{enabled:true,backgroundColor:'rgba(244,114,182,0.12)',borderColor:'rgba(244,114,182,0.4)',borderWidth:1},mode:'y'},pan:{enabled:false} };

function datalabelCfg(type) {
  if(type==='pie'||type==='doughnut') return {color:'#fff',font:{family:'DM Mono',size:11,weight:'bold'},formatter:v=>v>0?v+'å›':''};
  if(type==='horizontalBar') return {anchor:'end',align:'end',color:'#3d2b35',font:{family:'DM Mono',size:10,weight:'bold'},formatter:v=>v>0?v+'å›':'',padding:{left:3}};
  return {anchor:'end',align:'end',color:'#3d2b35',font:{family:'DM Mono',size:10,weight:'bold'},formatter:v=>v>0?v+'å›':'',padding:{bottom:3}};
}

function buildChart(type, labels, data, label, onClickFn) {
  const colors=labels.map((_,i)=>COLORS[i%COLORS.length]);
  const isH=type==='horizontalBar';
  if(type==='pie'||type==='doughnut') {
    return {type,data:{labels,datasets:[{data,backgroundColor:colors,borderWidth:2,borderColor:'#fff'}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true,position:'right',labels:{font:{family:'Zen Maru Gothic',size:11},padding:10,boxWidth:10}},tooltip:{callbacks:{label:ctx=>` ${ctx.label}: ${ctx.parsed}å›`}},datalabels:datalabelCfg(type)}}};
  }
  return {
    type:'bar',
    data:{labels,datasets:[{label,data,backgroundColor:colors,borderRadius:isH?5:7,borderSkipped:false}]},
    options:{
      responsive:true,maintainAspectRatio:false,
      ...(isH?{indexAxis:'y'}:{}),
      onClick:onClickFn||undefined,
      plugins:{
        legend:{display:false},
        tooltip:{callbacks:{label:ctx=>` ${isH?ctx.parsed.x:ctx.parsed.y}å›`}},
        datalabels:datalabelCfg(type),
        zoom:isH?ZoomPluginY:ZoomPlugin,
      },
      scales:{
        x:{grid:{display:!isH,color:'rgba(0,0,0,0.04)'},ticks:{font:{family:isH?'DM Mono':'Zen Maru Gothic',size:10},maxRotation:isH?0:35}},
        y:{grid:{display:isH,color:'rgba(0,0,0,0.04)'},ticks:{font:{family:isH?'Zen Maru Gothic':'DM Mono',size:isH?11:10}},beginAtZero:true}
      }
    }
  };
}

// ============================================================
// åˆ†æå®Ÿè¡Œ
// ============================================================
let mainChartInst=null;

async function analyze() {
  const year=document.getElementById('yearSelect').value;
  const cat=document.getElementById('columnSelect').value;
  const chartType=document.getElementById('chartTypeSelect').value;
  const limit=parseInt(document.getElementById('limitSelect').value);
  const sd=document.getElementById('startDate').value?new Date(document.getElementById('startDate').value):null;
  const ed=document.getElementById('endDate').value?new Date(document.getElementById('endDate').value+'T23:59:59'):null;

  showLoading(true);
  try {
    const rows=await fetchSheet(year);
    const results=aggData(rows,cat,sd,ed);
    if(!results.length){alert('è©²å½“ãƒ‡ãƒ¼ã‚¿ãªã—ã€‚æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚');return;}

    const limited=results.slice(0,limit===999?results.length:limit);
    const total=results.reduce((s,r)=>s+r[1],0);

    document.getElementById('stat-songs').textContent=results.length+'æ›²';
    document.getElementById('stat-total').textContent=total+'å›';
    document.getElementById('stat-top').textContent=results[0][0];
    document.getElementById('statsRow').style.display='flex';

    const labels=limited.map(r=>r[0]);
    const data=limited.map(r=>r[1]);
    const colLabel=document.getElementById('columnSelect').selectedOptions[0].text;

    document.getElementById('emptyState').style.display='none';
    document.getElementById('chartTitleText').textContent=`${year}å¹´ ${colLabel}`;
    document.getElementById('chartSubtitle').textContent=`ä¸Šä½${limited.length}ä»¶ / å…¨${results.length}æ›² â€” ãƒãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°`;

    mainChartInst=destroyChart(mainChartInst);
    const ctx=resetCanvas('mainChart');

    const onClickFn=(cat!=='combo')?(evt,els)=>{
      if(els.length>0) openDrill(limited[els[0].index][0],rows,{v2024:0,v2025:0,total:limited[els[0].index][1]},year);
    }:null;

    mainChartInst=new Chart(ctx,buildChart(chartType,labels,data,colLabel,onClickFn));
    if(cat!=='combo') document.getElementById('mainChart').style.cursor='pointer';

    renderRanking(results,limit,rows,year);
  } catch(e){alert('ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—: '+e.message);console.error(e);}
  finally{showLoading(false);}
}

function resetMainZoom(){if(mainChartInst) mainChartInst.resetZoom();}

// ============================================================
// ãƒ©ãƒ³ã‚­ãƒ³ã‚°
// ============================================================
function renderRanking(results,limit,rows,year) {
  const grid=document.getElementById('rankingGrid'); grid.innerHTML='';
  const max=results[0]?.[1]||1;
  const count=limit===999?results.length:limit;
  results.slice(0,count).forEach(([name,cnt],i)=>{
    const rank=i+1; const rc=rank===1?'top1':rank===2?'top2':rank===3?'top3':'';
    const pct=Math.round((cnt/max)*100);
    const el=document.createElement('div'); el.className='ranking-item';
    el.onclick=()=>openDrill(name,rows,{v2024:0,v2025:0,total:cnt},year);
    el.innerHTML=`<span class="rank-num ${rc}">${rank}</span>
      <div style="flex:1;overflow:hidden;">
        <div class="rank-name">${name}</div>
        <div class="rank-bar-wrap"><div class="rank-bar" style="width:${pct}%"></div></div>
      </div><span class="rank-count">${cnt}å›</span>`;
    grid.appendChild(el);
  });
}

// ============================================================
// ãƒ‰ãƒªãƒ«ãƒ€ã‚¦ãƒ³
// ============================================================
let drillInst=null;
function openDrill(songName,rows,songData,year) {
  const det=getSongDetails(rows,songName);
  document.getElementById('drillSongName').textContent=songName;
  document.getElementById('drillSongSub').textContent=`${year}å¹´ åˆè¨ˆ: ${songData.total||songData['v'+year]||0}å›`;

  const v24=songData.v2024||0, v25=songData.v2025||0;
  const delta=v25-v24; const growth=v24>0?((delta/v24)*100).toFixed(1):'â€”';
  document.getElementById('drill2024').innerHTML=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:3px;">2024å¹´</div><div style="font-size:24px;font-weight:700;color:var(--gold);">${v24}å›</div>`;
  document.getElementById('drill2025').innerHTML=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:3px;">2025å¹´ <span style="font-size:11px;color:${delta>=0?'#34d399':'#f87171'};font-weight:700;">${delta>=0?'â–²':'â–¼'}${Math.abs(delta)} (${delta>=0?'+':''}${growth}%)</span></div><div style="font-size:24px;font-weight:700;color:var(--pink);">${v25}å›</div>`;

  drillInst=destroyChart(drillInst);
  const mths=['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
  const dctx=resetCanvas('drillMonthChart');
  drillInst=new Chart(dctx,{
    type:'bar',
    data:{labels:mths,datasets:[{label:year+'å¹´',data:mths.map((_,i)=>det.monthly[i+1]),backgroundColor:'rgba(244,114,182,0.8)',borderRadius:5}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>` ${ctx.parsed.y}å›`}},datalabels:{anchor:'end',align:'end',color:'#3d2b35',font:{family:'DM Mono',size:9,weight:'bold'},formatter:v=>v>0?v+'å›':''}},scales:{x:{grid:{display:false},ticks:{font:{family:'Zen Maru Gothic',size:10}}},y:{grid:{color:'rgba(0,0,0,0.04)'},ticks:{font:{family:'DM Mono',size:10}},beginAtZero:true}}}
  });

  const evHtml=det.events.map(e=>{
    const ds=`${e.date.getFullYear()}/${String(e.date.getMonth()+1).padStart(2,'0')}/${String(e.date.getDate()).padStart(2,'0')}`;
    return `<div style="display:flex;gap:7px;align-items:flex-start;padding:6px 10px;background:var(--bg);border-radius:9px;">
      <div style="flex:1;overflow:hidden;"><div style="font-size:12px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${e.title}</div>
      <div style="font-size:10px;color:var(--text-muted);">${ds}${e.venue?' Â· '+e.venue:''}${e.pref?' ğŸ“'+e.pref:''}</div></div></div>`;
  }).join('');
  document.getElementById('drillEventList').innerHTML=evHtml||'<div style="color:var(--text-muted);font-size:13px;">ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ãªã—</div>';

  document.getElementById('drillModal').style.display='block';
  document.body.style.overflow='hidden';
}

function closeDrill(){document.getElementById('drillModal').style.display='none';document.body.style.overflow='';drillInst=destroyChart(drillInst);}

// ============================================================
// å¹´åº¦æ¯”è¼ƒ
// ============================================================
let evChartInst=null,moChartInst=null,trChartInst=null,mcChartInst=null;
let compareCategory='song'; let compareHasRun=false;

function setCompareCategory(btn,cat){
  document.querySelectorAll('.cat-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active'); compareCategory=cat; runCompare();
}

function resetCompare(){
  document.getElementById('compareStart').value='';
  document.getElementById('compareEnd').value='';
  document.getElementById('compareLimit').value='15';
  compareCategory='song';
  document.querySelectorAll('.cat-btn').forEach(b=>b.classList.remove('active'));
  document.querySelector('.cat-btn[data-cat="song"]').classList.add('active');
  Object.keys(sheetCache).forEach(k=>delete sheetCache[k]);
  runCompare();
}

function buildMap(rows,cat,sd,ed){
  if(cat==='song'){
    const m={};
    rows.slice(2).forEach(row=>{
      if(!isDataRow(row)) return;
      if(sd||ed){const d=parseDate(row[C.date]);if(!d)return;if(sd&&d<sd)return;if(ed&&d>ed)return;}
      const n=row[C.rawSong]; if(!n||!n.trim()) return; m[n]=(m[n]||0)+1;
    });
    return m;
  }
  const nc=detectNewCols(rows);
  const extra={fesFirst:{n:nc.fesFirstN,c:nc.fesFirstC},fesSong:{n:nc.fesSongN,c:nc.fesSongC},onemanFirst:{n:nc.onemanFirstN,c:nc.onemanFirstC},onemanSong:{n:nc.onemanSongN,c:nc.onemanSongC},multiFirst:{n:nc.multiFirstN,c:nc.multiFirstC}};
  const cfg=CAT_COL[cat]||extra[cat]; if(!cfg) return {};
  const m={};
  rows.slice(2).forEach(row=>{
    const n=row[cfg.n],c=parseFloat(row[cfg.c]);
    if(!n||!n.trim()||n==='æ›²å'||n==='ãƒšã‚¢') return;
    if(isNaN(c)||c<=0) return;
    if(!m[n]) m[n]=c;
  });
  return m;
}

async function runCompare(){
  showLoading(true);
  try {
    const [r24,r25]=[await fetchSheet('2024'),await fetchSheet('2025')];
    const sv=document.getElementById('compareStart').value, ev=document.getElementById('compareEnd').value;
    const sd=sv?new Date(sv+'-01'):null, ed=ev?new Date(ev+'-01T23:59:59'):null;
    if(ed) ed.setMonth(ed.getMonth()+1);
    const limit=parseInt(document.getElementById('compareLimit').value)||15;
    const cat=compareCategory;

    // å…¬æ¼”æ•°
    const evCnt={}, moEv={}; for(let m=1;m<=12;m++) moEv[m]={'2024':0,'2025':0};
    for(const [yr,rows] of [['2024',r24],['2025',r25]]){
      const seen=new Set();
      rows.slice(2).forEach(row=>{
        if(!isDataRow(row)) return;
        const d=parseDate(row[C.date]); if(!d) return;
        if(sd&&d<sd) return; if(ed&&d>ed) return;
        const key=row[C.date]+'_'+(row[C.title]||'');
        const m=d.getMonth()+1;
        if(!seen.has(key)){seen.add(key);moEv[m][yr]++;}
      });
      evCnt[yr]=seen.size;
    }

    // ã‚«ãƒ†ã‚´ãƒªé›†è¨ˆ
    const m24=buildMap(r24,cat,sd,ed), m25=buildMap(r25,cat,sd,ed);
    const names=[...new Set([...Object.keys(m24),...Object.keys(m25)])];
    const combined=names.map(n=>({name:n,v2024:m24[n]||0,v2025:m25[n]||0,total:(m24[n]||0)+(m25[n]||0)}))
      .sort((a,b)=>b.total-a.total).slice(0,limit);

    const t24=Object.values(m24).reduce((a,b)=>a+b,0);
    const t25=Object.values(m25).reduce((a,b)=>a+b,0);
    const delta=t25-t24; const growth=t24>0?((delta/t24)*100).toFixed(1):'â€”';
    const catL=CAT_LABEL[cat]||cat;

    document.getElementById('compareSummary').style.display='block';
    document.getElementById('cs2024').innerHTML=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:2px;">2024å¹´ ç·æ­Œå”±æ•°</div><div style="font-size:22px;font-weight:700;color:var(--gold);">${t24.toLocaleString()}</div><div style="font-size:10px;color:var(--text-muted);">${evCnt['2024']}å…¬æ¼”</div>`;
    document.getElementById('cs2025').innerHTML=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:2px;">2025å¹´ ç·æ­Œå”±æ•°</div><div style="font-size:22px;font-weight:700;color:var(--pink);">${t25.toLocaleString()}</div><div style="font-size:10px;color:var(--text-muted);">${evCnt['2025']}å…¬æ¼”</div>`;
    document.getElementById('csDelta').innerHTML=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:2px;">å¢—æ¸›</div><div style="font-size:22px;font-weight:700;color:${delta>=0?'#34d399':'#f87171'};">${delta>=0?'+':''}${delta.toLocaleString()}</div><div style="font-size:10px;color:var(--text-muted);">vs 2024å¹´</div>`;
    document.getElementById('csGrowth').innerHTML=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:2px;">æˆé•·ç‡</div><div style="font-size:22px;font-weight:700;color:${delta>=0?'#34d399':'#f87171'};">${t24>0?(delta>=0?'+':'')+growth+'%':'N/A'}</div><div style="font-size:10px;color:var(--text-muted);">å‰å¹´æ¯”</div>`;
    document.getElementById('compareChartTitle').textContent=`${catL} å¹´åº¦æ¯”è¼ƒ (Top${limit})`;
    document.getElementById('compareChartSub').textContent='ãƒãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´° / ãƒ‰ãƒ©ãƒƒã‚°ã§ã‚ºãƒ¼ãƒ ';

    // å…¬æ¼”æ•°ã‚°ãƒ©ãƒ•
    evChartInst=destroyChart(evChartInst);
    evChartInst=new Chart(resetCanvas('eventChart'),{
      type:'bar',data:{labels:['2024å¹´','2025å¹´'],datasets:[{data:[evCnt['2024'],evCnt['2025']],backgroundColor:[COLORS[1],COLORS[0]],borderRadius:10,borderSkipped:false}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>` ${ctx.parsed.y}å…¬æ¼”`}},datalabels:{anchor:'end',align:'end',color:'#3d2b35',font:{family:'DM Mono',size:12,weight:'bold'},formatter:v=>v+'å…¬æ¼”'}},scales:{x:{grid:{display:false},ticks:{font:{family:'Zen Maru Gothic',size:12}}},y:{grid:{color:'rgba(0,0,0,0.04)'},ticks:{font:{family:'DM Mono'}},beginAtZero:true}}}
    });

    // æœˆåˆ¥å…¬æ¼”ã‚°ãƒ©ãƒ•
    const mths=['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
    moChartInst=destroyChart(moChartInst);
    moChartInst=new Chart(resetCanvas('monthlyChart'),{
      type:'line',data:{labels:mths,datasets:[
        {label:'2024',data:mths.map((_,i)=>moEv[i+1]['2024']),borderColor:COLORS[1],backgroundColor:'rgba(212,175,55,0.1)',fill:true,tension:0.4,pointRadius:4,pointHoverRadius:7},
        {label:'2025',data:mths.map((_,i)=>moEv[i+1]['2025']),borderColor:COLORS[0],backgroundColor:'rgba(244,114,182,0.1)',fill:true,tension:0.4,pointRadius:4,pointHoverRadius:7}
      ]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font:{family:'Zen Maru Gothic',size:10},padding:8,boxWidth:10}},tooltip:{callbacks:{label:ctx=>` ${ctx.dataset.label}: ${ctx.parsed.y}å…¬æ¼”`}},datalabels:{display:false}},scales:{x:{grid:{display:false},ticks:{font:{family:'Zen Maru Gothic',size:10}}},y:{grid:{color:'rgba(0,0,0,0.04)'},ticks:{font:{family:'DM Mono'}},beginAtZero:true}}}
    });

    // ãƒˆãƒ¬ãƒ³ãƒ‰ã‚°ãƒ©ãƒ•
    const isCombo=cat==='combo';
    trChartInst=destroyChart(trChartInst);
    trChartInst=new Chart(resetCanvas('trendChart'),{
      type:'bar',
      data:{labels:combined.map(d=>d.name.length>16?d.name.slice(0,16)+'â€¦':d.name),datasets:[
        {label:'2024',data:combined.map(d=>d.v2024),backgroundColor:'rgba(212,175,55,0.85)',borderRadius:4,borderSkipped:false},
        {label:'2025',data:combined.map(d=>d.v2025),backgroundColor:'rgba(244,114,182,0.85)',borderRadius:4,borderSkipped:false}
      ]},
      options:{
        indexAxis:'y',responsive:true,maintainAspectRatio:false,
        onClick:(evt,els)=>{if(els.length>0&&!isCombo){const d=combined[els[0].index];openDrill(d.name,r24,d,'2024');}},
        plugins:{
          legend:{position:'top',labels:{font:{family:'Zen Maru Gothic',size:11},padding:12,boxWidth:10}},
          tooltip:{callbacks:{label:ctx=>` ${ctx.dataset.label}: ${ctx.parsed.x}å›`}},
          datalabels:{anchor:'end',align:'end',color:'#3d2b35',font:{family:'DM Mono',size:9,weight:'bold'},formatter:v=>v>0?v+'å›':''},
          zoom:ZoomPluginY,
        },
        scales:{x:{grid:{color:'rgba(0,0,0,0.04)'},ticks:{font:{family:'DM Mono'}}},y:{grid:{display:false},ticks:{font:{family:'Zen Maru Gothic',size:11}}}}
      }
    });
    if(!isCombo) document.getElementById('trendChart').style.cursor='pointer';

    // æœˆåˆ¥æ­Œå”±æ¨ç§»
    const mcCard=document.getElementById('monthlyTrendCard');
    if(cat==='song'){
      mcCard.style.display='block';
      const mc={}; for(let m=1;m<=12;m++) mc[m]={'2024':0,'2025':0};
      for(const [yr,rows] of [['2024',r24],['2025',r25]]){
        rows.slice(2).forEach(row=>{
          if(!isDataRow(row)) return;
          const d=parseDate(row[C.date]); if(!d) return;
          if(sd&&d<sd) return; if(ed&&d>ed) return;
          const n=row[C.rawSong]; if(!n||!n.trim()) return;
          mc[d.getMonth()+1][yr]++;
        });
      }
      mcChartInst=destroyChart(mcChartInst);
      mcChartInst=new Chart(resetCanvas('monthlyCountChart'),{
        type:'line',data:{labels:mths,datasets:[
          {label:'2024',data:mths.map((_,i)=>mc[i+1]['2024']),borderColor:COLORS[1],backgroundColor:'rgba(212,175,55,0.1)',fill:true,tension:0.4,pointRadius:5,pointHoverRadius:8},
          {label:'2025',data:mths.map((_,i)=>mc[i+1]['2025']),borderColor:COLORS[0],backgroundColor:'rgba(244,114,182,0.1)',fill:true,tension:0.4,pointRadius:5,pointHoverRadius:8}
        ]},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font:{family:'Zen Maru Gothic',size:11},padding:10,boxWidth:10}},tooltip:{callbacks:{label:ctx=>` ${ctx.dataset.label}: ${ctx.parsed.y}å›`}},datalabels:{display:false},zoom:ZoomPlugin},scales:{x:{grid:{display:false},ticks:{font:{family:'Zen Maru Gothic',size:10}}},y:{grid:{color:'rgba(0,0,0,0.04)'},ticks:{font:{family:'DM Mono'}},beginAtZero:true}}}
      });
    } else { mcCard.style.display='none'; }

  } catch(e){alert('ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—: '+e.message);console.error(e);}
  finally{showLoading(false);}
}

function resetTrendZoom(){if(trChartInst) trChartInst.resetZoom();}
function resetMonthlyZoom(){if(mcChartInst) mcChartInst.resetZoom();}

// ============================================================
// éƒ½é“åºœçœŒåˆ†æ
// ============================================================
let prefChartInst=null;

async function loadPrefData(){
  const year=document.getElementById('prefYearSelect').value;
  showLoading(true);
  try {
    const rows=await fetchSheet(year);
    const nc=detectNewCols(rows);

    // è¨ªå•å›æ•°ï¼ˆãƒ–ãƒ­ãƒƒã‚¯10ï¼‰
    const prefMap={};
    rows.slice(2).forEach(row=>{
      const n=row[C.prefRankN],c=parseFloat(row[C.prefRankC]);
      if(!n||!n.trim()||n==='éƒ½é“åºœçœŒ'||n==='è¨ªå•éƒ½é“åºœçœŒãƒ©ãƒ³ã‚­ãƒ³ã‚°'||n==='è¨ªå•éƒ½é“åºœçœŒæ•°') return;
      if(isNaN(c)||c<=0) return;
      if(!prefMap[n]) prefMap[n]=c;
    });
    const prefSorted=Object.entries(prefMap).sort((a,b)=>b[1]-a[1]);

    // éƒ½é“åºœçœŒåˆ¥TOPæ›²ï¼ˆãƒ–ãƒ­ãƒƒã‚¯11ï¼‰
    const prefTopMap={};
    if(nc.prefTopCols>0){
      const h=rows[0]||[];
      for(let p=0;p<nc.prefTopCols;p++){
        const nc_=nc.prefTopStart+p*2, cc_=nc.prefTopStart+p*2+1;
        const pname=String(h[nc_]||'').replace('TOPæ›²','').trim();
        if(!pname) continue;
        const songs={};
        rows.slice(2).forEach(row=>{
          const sn=row[nc_],sc=parseFloat(row[cc_]);
          if(!sn||!sn.trim()||sn==='æ›²å') return;
          if(isNaN(sc)||sc<=0) return;
          if(!songs[sn]) songs[sn]=sc;
        });
        prefTopMap[pname]=Object.entries(songs).sort((a,b)=>b[1]-a[1]);
      }
    }

    // ã‚µãƒãƒªãƒ¼
    const totalEv=prefSorted.reduce((s,r)=>s+r[1],0);
    const abroad=prefSorted.filter(p=>['ä¸­å›½ï¼ˆä¸Šæµ·ï¼‰','éŸ“å›½','å°æ¹¾'].includes(p[0]));
    document.getElementById('prefSummary').style.display='block';
    document.getElementById('ps-visited').innerHTML=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:2px;">è¨ªå•ãƒµæ‰€æ•°</div><div style="font-size:26px;font-weight:700;color:var(--pink-dark);">${prefSorted.length}<span style="font-size:12px;font-weight:400;">ãƒµæ‰€</span></div>`;
    document.getElementById('ps-events').innerHTML=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:2px;">ç·ã‚¤ãƒ™ãƒ³ãƒˆæ•°</div><div style="font-size:26px;font-weight:700;color:var(--gold);">${totalEv}<span style="font-size:12px;font-weight:400;">å…¬æ¼”</span></div>`;
    document.getElementById('ps-top').innerHTML=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:2px;">æœ€å¤šè¨ªå•åœ°</div><div style="font-size:16px;font-weight:700;color:var(--text);">${prefSorted[0]?.[0]||'â€”'}</div><div style="font-size:10px;color:var(--text-muted);">${prefSorted[0]?.[1]||0}å…¬æ¼”</div>`;
    document.getElementById('ps-abroad').innerHTML=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:2px;">æµ·å¤–å…¬æ¼”</div><div style="font-size:16px;font-weight:700;color:var(--text);">${abroad.length}<span style="font-size:11px;font-weight:400;">ãƒµå›½</span></div><div style="font-size:10px;color:var(--text-muted);">${abroad.map(a=>a[0]).join(' / ')||'ãªã—'}</div>`;

    // éƒ½é“åºœçœŒã‚«ãƒ¼ãƒ‰
    const grid=document.getElementById('prefGrid'); grid.innerHTML='';
    prefSorted.forEach(([pref,cnt])=>{
      const tops=prefTopMap[pref]||[];
      const top1=tops[0]?.[0]||'â€”';
      const card=document.createElement('div'); card.className='pref-card';
      card.onclick=()=>renderPrefChart(pref,tops,year);
      card.innerHTML=`<div class="pref-name">${pref}</div><div class="pref-count">${cnt}<span style="font-size:10px;font-weight:400;color:var(--text-muted);">å…¬æ¼”</span></div><div class="pref-top">ğŸµ ${top1}</div>`;
      grid.appendChild(card);
    });

  } catch(e){alert('éƒ½é“åºœçœŒãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—: '+e.message);console.error(e);}
  finally{showLoading(false);}
}

function renderPrefChart(pref,songs,year){
  document.getElementById('prefEmptyState').style.display='none';
  document.getElementById('prefChartSub').textContent=`${pref} â€” ${year}å¹´ TOPæ›² (${songs.length}æ›²)`;
  const top20=songs.slice(0,20);
  prefChartInst=destroyChart(prefChartInst);
  prefChartInst=new Chart(resetCanvas('prefChart'),{
    type:'bar',
    data:{labels:top20.map(s=>s[0].length>12?s[0].slice(0,12)+'â€¦':s[0]),datasets:[{label:pref,data:top20.map(s=>s[1]),backgroundColor:COLORS.map(c=>c+'bb'),borderRadius:7,borderSkipped:false}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>` ${ctx.parsed.y}å›`}},datalabels:{anchor:'end',align:'end',color:'#3d2b35',font:{family:'DM Mono',size:10,weight:'bold'},formatter:v=>v>0?v+'å›':''},zoom:ZoomPlugin},scales:{x:{grid:{display:false},ticks:{font:{family:'Zen Maru Gothic',size:10},maxRotation:35}},y:{grid:{color:'rgba(0,0,0,0.04)'},ticks:{font:{family:'DM Mono',size:10}},beginAtZero:true}}}
  });
}

function resetPrefZoom(){if(prefChartInst) prefChartInst.resetZoom();}

// ============================================================
// UI
// ============================================================
let compareHasRunFlag=false;
function switchTab(id){
  document.querySelectorAll('.tab-content').forEach(el=>el.classList.remove('active'));
  document.getElementById('tab-'+id).classList.add('active');
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  ['single','ranking','compare','pref'].forEach((t,i)=>{
    if(t===id) document.querySelectorAll('.nav-btn')[i]?.classList.add('active');
  });
  document.querySelectorAll('.mobile-nav-btn').forEach(b=>b.classList.remove('active'));
  const mb=document.getElementById('mnav-'+id); if(mb) mb.classList.add('active');
  if(id==='compare'&&!compareHasRunFlag){compareHasRunFlag=true;runCompare();}
  if(id==='pref') loadPrefData();
}

function resetFilters(){
  document.getElementById('yearSelect').value='2025';
  document.getElementById('columnSelect').value='song';
  document.getElementById('chartTypeSelect').value='bar';
  document.getElementById('startDate').value='';
  document.getElementById('endDate').value='';
  document.getElementById('limitSelect').value='10';
  document.getElementById('statsRow').style.display='none';
  document.getElementById('emptyState').style.display='flex';
  document.getElementById('chartTitleText').textContent='åˆ†æçµæœ';
  document.getElementById('chartSubtitle').textContent='åˆ†æè¨­å®šã‚’é¸æŠã—ã¦ã€Œåˆ†æã‚’é–‹å§‹ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„';
  mainChartInst=destroyChart(mainChartInst);
}

function showLoading(show){document.getElementById('loading').classList.toggle('show',show);}

// ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
document.getElementById('drillModal').addEventListener('click',e=>{if(e.target===document.getElementById('drillModal')) closeDrill();});
</script>
</body>
</html>
