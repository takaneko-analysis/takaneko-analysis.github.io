<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>ãŸã‹ã­ã“ æ¥½æ›²åˆ†æ Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --pink: #f472b6;
      --pink-light: #fce7f3;
      --pink-dark: #db2777;
      --pink-soft: #fbcfe8;
      --gold: #d4af37;
      --gold-light: #fef9e7;
      --bg: #fff5f9;
      --surface: #ffffff;
      --text: #3d2b35;
      --text-muted: #9d6b8a;
      --border: #fad4e8;
      --radius: 20px;
      --shadow: 0 4px 24px rgba(244,114,182,0.12);
      --shadow-hover: 0 8px 40px rgba(244,114,182,0.22);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Zen Maru Gothic', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      background-image:
        radial-gradient(circle at 20% 20%, rgba(244,114,182,0.08) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(212,175,55,0.06) 0%, transparent 50%);
    }

    /* ========== HEADER ========== */
    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0 24px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 12px rgba(244,114,182,0.08);
    }

    .header-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 64px;
      gap: 16px;
    }

    .logo {
      display: flex;
      flex-direction: column;
      line-height: 1.2;
      flex-shrink: 0;
    }

    .logo-sub {
      font-size: 9px;
      letter-spacing: 2px;
      color: var(--gold);
      font-family: 'DM Mono', monospace;
      text-transform: uppercase;
    }

    .logo-main {
      font-size: 16px;
      font-weight: 700;
      color: var(--pink-dark);
    }

    /* ========== NAV TABS ========== */
    nav {
      display: flex;
      gap: 4px;
    }

    .nav-btn {
      padding: 8px 18px;
      border: 1.5px solid var(--border);
      background: transparent;
      color: var(--text-muted);
      border-radius: 50px;
      cursor: pointer;
      font-family: 'Zen Maru Gothic', sans-serif;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .nav-btn:hover {
      border-color: var(--pink);
      color: var(--pink);
      background: var(--pink-light);
    }

    .nav-btn.active {
      background: var(--pink);
      border-color: var(--pink);
      color: white;
      box-shadow: 0 2px 12px rgba(244,114,182,0.3);
    }

    /* ========== OFFICIAL LINKS ========== */
    .official-links {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
    }

    .link-btn {
      padding: 6px 12px;
      border-radius: 50px;
      text-decoration: none;
      font-size: 11px;
      font-weight: 700;
      color: white;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .link-btn:hover { transform: translateY(-2px); opacity: 0.85; }
    .link-web { background: var(--pink); }
    .link-x { background: #000; }
    .link-yt { background: #ff0000; }
    .link-fc { background: var(--gold); }

    /* ========== MAIN ========== */
    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 28px 20px;
    }

    .tab-content { display: none; animation: fadeUp 0.3s ease; }
    .tab-content.active { display: block; }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ========== CONTROLS CARD ========== */
    .card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 24px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      margin-bottom: 20px;
    }

    .card-title {
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 2px;
      color: var(--gold);
      font-family: 'DM Mono', monospace;
      text-transform: uppercase;
      margin-bottom: 16px;
    }

    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 14px;
      align-items: end;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .field label {
      font-size: 11px;
      font-weight: 700;
      color: var(--pink-dark);
      letter-spacing: 0.5px;
    }

    select, input[type="date"] {
      padding: 10px 14px;
      border: 1.5px solid var(--border);
      border-radius: 12px;
      font-family: 'Zen Maru Gothic', sans-serif;
      font-size: 13px;
      color: var(--text);
      background: var(--surface);
      outline: none;
      transition: border-color 0.2s;
      width: 100%;
    }

    select:focus, input[type="date"]:focus {
      border-color: var(--pink);
      box-shadow: 0 0 0 3px rgba(244,114,182,0.1);
    }

    .date-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .date-row span { color: var(--text-muted); font-size: 12px; flex-shrink: 0; }
    .date-row input { flex: 1; }

    .btn-row {
      display: flex;
      gap: 8px;
      align-items: center;
      padding-top: 2px;
    }

    .btn {
      padding: 11px 20px;
      border-radius: 50px;
      border: none;
      font-family: 'Zen Maru Gothic', sans-serif;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--pink);
      color: white;
      flex: 1;
      box-shadow: 0 2px 12px rgba(244,114,182,0.25);
    }

    .btn-primary:hover {
      background: var(--pink-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(244,114,182,0.35);
    }

    .btn-secondary {
      background: #f3f4f6;
      color: #888;
    }

    .btn-secondary:hover { background: #e5e7eb; }

    .btn-gold {
      background: var(--gold);
      color: white;
      box-shadow: 0 2px 12px rgba(212,175,55,0.25);
    }

    .btn-gold:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(212,175,55,0.35);
      opacity: 0.9;
    }

    .notice {
      background: var(--pink-light);
      border-left: 3px solid var(--pink);
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 11px;
      color: var(--pink-dark);
      margin-top: 14px;
      line-height: 1.6;
    }

    /* ========== CHART AREA ========== */
    .chart-card {
      background: var(--surface);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 24px;
      margin-bottom: 20px;
      position: relative;
      min-height: 420px;
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
    }

    .chart-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--text);
    }

    .chart-subtitle {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .chart-wrap {
      position: relative;
      height: 420px;
    }

    .chart-wrap canvas { border-radius: 12px; }

    /* ========== EMPTY STATE ========== */
    .empty-state {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      gap: 12px;
    }

    .empty-icon {
      font-size: 48px;
      opacity: 0.4;
    }

    .empty-text { font-size: 14px; }

    /* ========== RANKING ========== */
    .ranking-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 10px;
    }

    .ranking-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      transition: all 0.2s;
    }

    .ranking-item:hover {
      border-color: var(--pink);
      box-shadow: var(--shadow);
      transform: translateY(-2px);
    }

    .rank-num {
      font-family: 'DM Mono', monospace;
      font-size: 18px;
      font-weight: 500;
      color: var(--pink-soft);
      width: 32px;
      flex-shrink: 0;
      text-align: center;
    }

    .rank-num.top1 { color: var(--gold); font-size: 22px; }
    .rank-num.top2 { color: #b0b0b0; font-size: 20px; }
    .rank-num.top3 { color: #cd7f32; font-size: 20px; }

    .rank-name {
      flex: 1;
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .rank-count {
      font-family: 'DM Mono', monospace;
      font-size: 14px;
      font-weight: 500;
      color: var(--gold);
      flex-shrink: 0;
    }

    .rank-bar-wrap {
      width: 100%;
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      margin-top: 6px;
      overflow: hidden;
    }

    .rank-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--pink), var(--gold));
      border-radius: 2px;
      transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* ========== COMPARE SECTION ========== */
    .compare-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .chart-half {
      background: var(--surface);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 20px;
    }

    .chart-half-wrap {
      position: relative;
      height: 300px;
    }

    /* ========== STATS PILLS ========== */
    .stats-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .stat-pill {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 50px;
      padding: 8px 18px;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: var(--shadow);
    }

    .stat-label { font-size: 11px; color: var(--text-muted); }
    .stat-val { font-family: 'DM Mono', monospace; font-size: 16px; font-weight: 500; color: var(--pink-dark); }

    /* ========== LOADING ========== */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255,245,249,0.9);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      gap: 16px;
    }

    .loading-overlay.show { display: flex; }

    .spinner {
      width: 44px;
      height: 44px;
      border: 3px solid var(--pink-soft);
      border-top-color: var(--pink);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .loading-text {
      font-size: 13px;
      color: var(--text-muted);
      font-family: 'DM Mono', monospace;
      letter-spacing: 2px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* ========== MOBILE ========== */
    .mobile-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--surface);
      border-top: 1px solid var(--border);
      padding: 8px 16px 20px;
      z-index: 100;
      gap: 4px;
    }

    .mobile-nav-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 8px 4px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-family: 'Zen Maru Gothic', sans-serif;
      font-size: 10px;
      font-weight: 500;
      cursor: pointer;
      border-radius: 12px;
      transition: all 0.2s;
    }

    .mobile-nav-btn.active {
      color: var(--pink);
      background: var(--pink-light);
    }

    .mobile-nav-icon { font-size: 20px; }

    @media (max-width: 768px) {
      header { padding: 0 16px; }
      .header-inner { height: 56px; }
      .logo-main { font-size: 14px; }
      nav { display: none; }
      .official-links { display: none; }
      main { padding: 16px 14px 90px; }
      .controls-grid { grid-template-columns: 1fr 1fr; }
      .compare-grid { grid-template-columns: 1fr; }
      .mobile-nav { display: flex; }
      .card { padding: 16px; }
      .chart-card { padding: 16px; }
      .chart-wrap { height: 320px; }
    }

    @media (max-width: 480px) {
      .controls-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header>
    <div class="header-inner">
      <div class="logo">
        <span class="logo-sub">Advanced Performance Analysis</span>
        <span class="logo-main">ãŸã‹ã­ã“ æ¥½æ›²åˆ†æ Portal</span>
      </div>
      <nav>
        <button class="nav-btn active" onclick="switchTab('single')">æœŸé–“ãƒ»è©³ç´°åˆ†æ</button>
        <button class="nav-btn" onclick="switchTab('ranking')">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ä¸€è¦§</button>
        <button class="nav-btn" onclick="switchTab('compare')">å¹´åº¦æ¯”è¼ƒãƒ¬ãƒãƒ¼ãƒˆ</button>
      </nav>
      <div class="official-links">
        <a href="https://takanenonadeshiko.jp/" target="_blank" class="link-btn link-web">å…¬å¼ã‚µã‚¤ãƒˆ</a>
        <a href="https://x.com/takanenofficial" target="_blank" class="link-btn link-x">X</a>
        <a href="https://www.youtube.com/channel/UCoR4zZDvWvUIqgEWz4HS-sA" target="_blank" class="link-btn link-yt">YouTube</a>
        <a href="https://takanekofc.com/#/" target="_blank" class="link-btn link-fc">FC</a>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main>

    <!-- ===== TAB: æœŸé–“ãƒ»è©³ç´°åˆ†æ ===== -->
    <div id="tab-single" class="tab-content active">

      <div class="card">
        <div class="card-title">ğŸ” Analysis Settings</div>
        <div class="controls-grid">
          <div class="field">
            <label>å¯¾è±¡å¹´</label>
            <select id="yearSelect">
              <option value="2025">2025å¹´</option>
              <option value="2024">2024å¹´</option>
            </select>
          </div>
          <div class="field">
            <label>åˆ†æã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
            <select id="columnSelect">
              <option value="song">â˜… æ¥½æ›²åˆ¥ æ­Œå”±å›æ•°</option>
              <option value="first">ã€1æ›²ç›®ã€‘å‡ºç¾å›æ•°</option>
              <option value="last">ã€ãƒˆãƒªã€‘å‡ºç¾å›æ•°</option>
              <option value="spring">æ˜¥ (3ã€œ5æœˆ)</option>
              <option value="summer">å¤ (6ã€œ8æœˆ)</option>
              <option value="autumn">ç§‹ (9ã€œ11æœˆ)</option>
              <option value="winter">å†¬ (12ã€œ2æœˆ)</option>
              <option value="shortFirst">å°‘æ›²æ•°(1-4æ›²)1æ›²ç›®</option>
              <option value="longFirst">å¤šæ›²æ•°(5æ›²ä»¥ä¸Š)1æ›²ç›®</option>
              <option value="combo">é‰„æ¿ã‚³ãƒ³ãƒœåˆ†æ</option>
            </select>
          </div>
          <div class="field">
            <label>ã‚°ãƒ©ãƒ•ç¨®åˆ¥</label>
            <select id="chartTypeSelect">
              <option value="bar">ç¸¦æ£’ã‚°ãƒ©ãƒ•</option>
              <option value="horizontalBar">æ¨ªæ£’ã‚°ãƒ©ãƒ•</option>
              <option value="pie">å††ã‚°ãƒ©ãƒ•</option>
              <option value="doughnut">ãƒ‰ãƒ¼ãƒŠãƒ„ã‚°ãƒ©ãƒ•</option>
            </select>
          </div>
          <div class="field">
            <label>æœŸé–“çµã‚Šè¾¼ã¿ï¼ˆé–‹å§‹ï¼‰</label>
            <input type="date" id="startDate">
          </div>
          <div class="field">
            <label>æœŸé–“çµã‚Šè¾¼ã¿ï¼ˆçµ‚äº†ï¼‰</label>
            <input type="date" id="endDate">
          </div>
          <div class="field">
            <label>è¡¨ç¤ºä»¶æ•°</label>
            <select id="limitSelect">
              <option value="10">ä¸Šä½10ä»¶</option>
              <option value="20">ä¸Šä½20ä»¶</option>
              <option value="30">ä¸Šä½30ä»¶</option>
              <option value="999">å…¨ä»¶</option>
            </select>
          </div>
        </div>
        <div class="btn-row" style="margin-top:16px;">
          <button class="btn btn-primary" onclick="analyze()">ğŸ“Š åˆ†æã‚’é–‹å§‹ã™ã‚‹</button>
          <button class="btn btn-secondary" onclick="resetFilters()">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        <div class="notice">
          ğŸ’¡ æœŸé–“ã‚’æŒ‡å®šã—ãŸå ´åˆã¯ã€ãã®æœŸé–“å†…ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’é›†è¨ˆã—ã¾ã™ã€‚ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’æ›´æ–°ã™ã‚‹ã¨è‡ªå‹•çš„ã«æœ€æ–°ãƒ‡ãƒ¼ã‚¿ãŒåæ˜ ã•ã‚Œã¾ã™ã€‚
        </div>
      </div>

      <!-- Stats Pills -->
      <div class="stats-row" id="statsRow" style="display:none;">
        <div class="stat-pill">
          <span class="stat-label">ç·æ¥½æ›²æ•°</span>
          <span class="stat-val" id="stat-songs">-</span>
        </div>
        <div class="stat-pill">
          <span class="stat-label">ç·æ­Œå”±å›æ•°</span>
          <span class="stat-val" id="stat-total">-</span>
        </div>
        <div class="stat-pill">
          <span class="stat-label">æœ€å¤šæ¥½æ›²</span>
          <span class="stat-val" id="stat-top">-</span>
        </div>
      </div>

      <div class="chart-card">
        <div class="chart-header">
          <div>
            <div class="chart-title" id="chartTitleText">åˆ†æçµæœ</div>
            <div class="chart-subtitle" id="chartSubtitle">åˆ†æè¨­å®šã‚’é¸æŠã—ã¦ã€Œåˆ†æã‚’é–‹å§‹ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
          </div>
        </div>
        <div class="chart-wrap">
          <canvas id="mainChart"></canvas>
          <div class="empty-state" id="emptyState">
            <div class="empty-icon">ğŸµ</div>
            <div class="empty-text">åˆ†æã‚’å®Ÿè¡Œã™ã‚‹ã¨çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== TAB: ãƒ©ãƒ³ã‚­ãƒ³ã‚°ä¸€è¦§ ===== -->
    <div id="tab-ranking" class="tab-content">
      <div class="card">
        <div class="card-title">ğŸ† Ranking List</div>
        <p style="font-size:13px; color:var(--text-muted);">ã€ŒæœŸé–“ãƒ»è©³ç´°åˆ†æã€ã‚¿ãƒ–ã§åˆ†æã‚’å®Ÿè¡Œã™ã‚‹ã¨ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
      </div>
      <div class="ranking-grid" id="rankingGrid">
      </div>
    </div>

    <!-- ===== TAB: å¹´åº¦æ¯”è¼ƒãƒ¬ãƒãƒ¼ãƒˆ ===== -->
    <div id="tab-compare" class="tab-content">
      <div class="card">
        <div class="card-title">ğŸ“ˆ Trend Analysis</div>
        <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
          <button class="btn btn-gold" onclick="runCompare()">ğŸ”„ ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æã‚’å®Ÿè¡Œ</button>
          <span style="font-size:12px; color:var(--text-muted);">2024å¹´ vs 2025å¹´ ã®æ¯”è¼ƒãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã¾ã™</span>
        </div>
      </div>

      <div class="compare-grid">
        <div class="chart-half">
          <div class="chart-title" style="font-size:14px; margin-bottom:14px;">å¹´åº¦åˆ¥ å…¬æ¼”æ•°</div>
          <div class="chart-half-wrap"><canvas id="eventChart"></canvas></div>
        </div>
        <div class="chart-half">
          <div class="chart-title" style="font-size:14px; margin-bottom:14px;">æœˆåˆ¥ å…¬æ¼”æ•°æ¨ç§»</div>
          <div class="chart-half-wrap"><canvas id="monthlyChart"></canvas></div>
        </div>
      </div>

      <div class="chart-card">
        <div class="chart-title" style="margin-bottom:4px;">æ¥½æ›²åˆ¥ å¹´åº¦æ¯”è¼ƒ (Top15)</div>
        <div class="chart-subtitle" style="margin-bottom:20px;">å„æ¥½æ›²ã®2024å¹´ãƒ»2025å¹´ã®æ­Œå”±å›æ•°æ¯”è¼ƒ</div>
        <div style="position:relative; height:550px;">
          <canvas id="trendChart"></canvas>
        </div>
      </div>
    </div>

  </main>

  <!-- MOBILE NAV -->
  <div class="mobile-nav" id="mobileNav">
    <button class="mobile-nav-btn active" id="mnav-single" onclick="switchTab('single')">
      <span class="mobile-nav-icon">ğŸ”</span>è©³ç´°åˆ†æ
    </button>
    <button class="mobile-nav-btn" id="mnav-ranking" onclick="switchTab('ranking')">
      <span class="mobile-nav-icon">ğŸ†</span>ãƒ©ãƒ³ã‚­ãƒ³ã‚°
    </button>
    <button class="mobile-nav-btn" id="mnav-compare" onclick="switchTab('compare')">
      <span class="mobile-nav-icon">ğŸ“ˆ</span>å¹´åº¦æ¯”è¼ƒ
    </button>
  </div>

  <!-- LOADING -->
  <div class="loading-overlay" id="loading">
    <div class="spinner"></div>
    <div class="loading-text">NOW ANALYZING...</div>
  </div>

  <script>
    // ============================================================
    // è¨­å®š
    // ============================================================
    const SHEET_ID = '10QKtPdhdtaLFxxkRhdzTRVePeh3DUmib0WpEJA49Erw';
    const SHEET_NAMES = {
      '2024': 'æ¥½æ›²åˆ†è§£ã‚·ãƒ¼ãƒˆï¼ˆ2024ï¼‰',
      '2025': 'æ¥½æ›²åˆ†è§£ã‚·ãƒ¼ãƒˆï¼ˆ2025ï¼‰'
    };

    const COLORS = [
      '#f472b6','#d4af37','#818cf8','#34d399','#fb923c',
      '#60a5fa','#e879f9','#4ade80','#f87171','#38bdf8',
      '#fbbf24','#a78bfa','#fb7185','#2dd4bf','#c084fc'
    ];

    // ============================================================
    // ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆGoogle Sheets CSV ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼‰
    // ============================================================
    async function fetchSheetData(year) {
      const sheetName = encodeURIComponent(SHEET_NAMES[year]);
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${sheetName}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      const text = await res.text();
      return parseCSV(text);
    }

    function parseCSV(text) {
      const lines = text.split('\n');
      return lines.map(line => {
        // CSVã®ã‚¯ã‚©ãƒ¼ãƒˆå‡¦ç†
        const result = [];
        let inQuote = false;
        let current = '';
        for (let i = 0; i < line.length; i++) {
          const ch = line[i];
          if (ch === '"') {
            if (inQuote && line[i+1] === '"') { current += '"'; i++; }
            else inQuote = !inQuote;
          } else if (ch === ',' && !inQuote) {
            result.push(current.trim());
            current = '';
          } else {
            current += ch;
          }
        }
        result.push(current.trim());
        return result;
      }).filter(r => r.length > 1 && r[0]);
    }

    function excelDateToJS(serial) {
      const n = parseFloat(serial);
      if (isNaN(n)) return null;
      const d = new Date(Math.round((n - 25569) * 86400 * 1000));
      return isNaN(d.getTime()) ? null : d;
    }

    function parseDate(val) {
      if (!val) return null;
      // Excelã‚·ãƒªã‚¢ãƒ«å€¤
      if (/^\d{4,6}$/.test(val.replace(/\s/g,''))) {
        return excelDateToJS(val);
      }
      // YYYY/MM/DD or YYYY-MM-DD
      const d = new Date(val.replace(/\//g, '-'));
      return isNaN(d.getTime()) ? null : d;
    }

    // ============================================================
    // ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®èª¬æ˜
    // ============================================================
    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®åˆ—æ§‹é€ ï¼ˆ0å§‹ã¾ã‚Šã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‰:
    // A=0:è¨ˆç®—ç”¨æ—¥ä»˜ï¼ˆExcelã‚·ãƒªã‚¢ãƒ«ï¼‰, B=1:æœˆ, C=2:ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒˆãƒ«, D=3:æ›²åï¼ˆç”Ÿã‚»ãƒˆãƒªã€1è¡Œ1æ›²ï¼‰
    // E=4:ç©º, F=5:æ›²åï¼ˆé›†è¨ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨ï¼‰, G=6:æ­Œå”±å›æ•°, H=7:å‰²åˆ
    // I=8:ç©º, J=9:1æ›²ç›®TOPæ›²å, K=10:1æ›²ç›®TOPå›æ•°
    // L=11:ç©º, M=12:ãƒˆãƒªTOPæ›²å, N=13:ãƒˆãƒªTOPå›æ•°
    // O=14:ç©º, P=15:æ˜¥æ›²å, Q=16:æ˜¥å›æ•°
    // R=17:ç©º, S=18:å¤æ›²å, T=19:å¤å›æ•°
    // U=20:ç©º, V=21:ç§‹æ›²å, W=22:ç§‹å›æ•°
    // X=23:ç©º, Y=24:å†¬æ›²å, Z=25:å†¬å›æ•°
    // AA=26:ç©º, AB=27:å°‘æ›²æ•°1æ›²ç›®æ›²å, AC=28:å°‘æ›²æ•°1æ›²ç›®å›æ•°
    // AD=29:ç©º, AE=30:å¤šæ›²æ•°1æ›²ç›®æ›²å, AF=31:å¤šæ›²æ•°1æ›²ç›®å›æ•°
    // AG=32:ç©º, AH=33:ã‚³ãƒ³ãƒœãƒšã‚¢å, AI=34:ã‚³ãƒ³ãƒœå›æ•°
    //
    // â€» å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¦‹ã‚‹ã¨ï¼š
    // - Dåˆ—(3): ç”Ÿã‚»ãƒˆãƒªæ›²åï¼ˆå„è¡Œã«1æ›²ï¼‰
    // - Fåˆ—(5): é›†è¨ˆæ¸ˆã¿æ›²åãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆå„è¡Œã«åˆ¥ã®æ›²ã€ä¸Šã‹ã‚‰å¤šã„é †ï¼‰
    // - Gåˆ—(6): ä¸Šè¨˜ã®æ­Œå”±å›æ•°
    // - Jåˆ—ä»¥é™: å„åˆ†æè»¸ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆå„è¡ŒãŒç‹¬ç«‹ã—ãŸãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚¨ãƒ³ãƒˆãƒªï¼‰
    //
    // æ­£ã—ã„èª­ã¿æ–¹: å„è¡Œã¯ã‚»ãƒˆãƒªãƒ‡ãƒ¼ã‚¿è¡Œã ãŒã€
    // Fåˆ—ãƒ»Gåˆ—ãƒ»Jåˆ—ä»¥é™ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã¯ã€Œå…¨è¡Œã‚’èµ°æŸ»ã—ã¦åå‰ã¨å›æ•°ã®ãƒšã‚¢ã‚’é›†ã‚ã‚‹ã€

    // å®Ÿéš›ã®CSVã‚’è§£æã—ã¦åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’å‹•çš„ã«æ¤œå‡ºã™ã‚‹
    function detectColumns(rows) {
      // å®Ÿéš›ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆåˆ—æ§‹é€ ï¼ˆ0ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‰:
      // A(0):æ—¥ä»˜ã‚·ãƒªã‚¢ãƒ«, B(1):æœˆ, C(2):ã‚¿ã‚¤ãƒˆãƒ«, D(3):æ›²å(ç”Ÿã‚»ãƒˆãƒªãƒ‡ãƒ¼ã‚¿)
      // E(4):ç©º, F(5):å…¨æ›²ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ›²å, G(6):æ­Œå”±å›æ•°, H(7):å‰²åˆ
      // I(8):ç©º
      // J(9):1æ›²ç›®æ›²å, K(10):1æ›²ç›®å›æ•°
      // L(11):ãƒˆãƒªæ›²å, M(12):ãƒˆãƒªå›æ•°
      // N(13):æ˜¥æ›²å, O(14):æ˜¥å›æ•°
      // P(15):å¤æ›²å, Q(16):å¤å›æ•°
      // R(17):ç§‹æ›²å, S(18):ç§‹å›æ•°
      // T(19):å†¬æ›²å, U(20):å†¬å›æ•°
      // V(21):å°‘æ›²æ•°1æ›²ç›®æ›²å, W(22):å°‘æ›²æ•°1æ›²ç›®å›æ•°
      // X(23):å¤šæ›²æ•°1æ›²ç›®æ›²å, Y(24):å¤šæ›²æ•°1æ›²ç›®å›æ•°
      // Z(25):ã‚³ãƒ³ãƒœãƒšã‚¢, AA(26):å…±æ¼”å›æ•°
      return {
        song:   { nameCol: 5,  countCol: 6  },
        first:  { nameCol: 9,  countCol: 10 },
        last:   { nameCol: 11, countCol: 12 },
        spring: { nameCol: 13, countCol: 14 },
        summer: { nameCol: 15, countCol: 16 },
        autumn: { nameCol: 17, countCol: 18 },
        winter: { nameCol: 19, countCol: 20 },
        shortFirst: { nameCol: 21, countCol: 22 },
        longFirst:  { nameCol: 23, countCol: 24 },
        combo:  { nameCol: 25, countCol: 26 },
      };
    }

    // ã‚»ãƒˆãƒªç”Ÿãƒ‡ãƒ¼ã‚¿ï¼ˆDåˆ—ï¼‰ã‹ã‚‰ç›´æ¥é›†è¨ˆã™ã‚‹é–¢æ•°
    function aggregateFromRaw(rows, startDate, endDate) {
      const summary = {};
      // æœ€åˆã®2è¡Œã¯ãƒ˜ãƒƒãƒ€ãƒ¼ãªã®ã§ã‚¹ã‚­ãƒƒãƒ—
      const dataRows = rows.slice(2);
      dataRows.forEach(row => {
        if (!row[0] || !/^\d{5}/.test(row[0])) return; // Excelã‚·ãƒªã‚¢ãƒ«æ—¥ä»˜è¡Œã®ã¿
        if (startDate || endDate) {
          const d = parseDate(row[0]);
          if (!d) return;
          if (startDate && d < startDate) return;
          if (endDate && d > endDate) return;
        }
        const name = row[3]; // Dåˆ—: ç”Ÿã‚»ãƒˆãƒªæ›²å
        if (!name || name.trim() === '') return;
        summary[name] = (summary[name] || 0) + 1;
      });
      return Object.entries(summary).sort((a, b) => b[1] - a[1]);
    }

    // é›†è¨ˆæ¸ˆã¿ãƒ©ãƒ³ã‚­ãƒ³ã‚°åˆ—ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã‚€é–¢æ•°
    function aggregateFromRanking(rows, colType, startDate, endDate) {
      const colMap = detectColumns(rows);
      const cfg = colMap[colType];
      if (!cfg) return [];

      const summary = {};
      // è¡Œ2ä»¥é™ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼2è¡Œã‚’é™¤ãï¼‰ã‚’èµ°æŸ»
      rows.slice(2).forEach(row => {
        // æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ã¯é›†è¨ˆæ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã«ã¯é©ç”¨ã—ãªã„ï¼ˆæ—¢ã«å…¨æœŸé–“é›†è¨ˆæ¸ˆã¿ï¼‰
        // ãŸã ã—æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ãŒã‚ã‚‹å ´åˆã¯ã‚»ãƒˆãƒªç”Ÿãƒ‡ãƒ¼ã‚¿ã§å†é›†è¨ˆ
        const name = row[cfg.nameCol];
        const count = parseFloat(row[cfg.countCol]);
        if (!name || name.trim() === '' || name === 'æ›²å' || name === 'ãƒšã‚¢') return;
        if (isNaN(count) || count <= 0) return;
        // åŒã˜åå‰ãŒè¤‡æ•°è¡Œã«å‡ºãŸã‚‰æœ€åˆã®å€¤ã®ã¿ä½¿ç”¨ï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¯é‡è¤‡ãªã—ï¼‰
        if (!summary[name]) {
          summary[name] = count;
        }
      });

      return Object.entries(summary).sort((a, b) => b[1] - a[1]);
    }

    function aggregateData(rows, colType, startDate, endDate) {
      // æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ãŒã‚ã‚‹å ´åˆã€ã¾ãŸã¯songåˆ†æã¯ã‚»ãƒˆãƒªç”Ÿãƒ‡ãƒ¼ã‚¿ã‹ã‚‰é›†è¨ˆ
      if (colType === 'song' || startDate || endDate) {
        if (colType === 'song') {
          return aggregateFromRaw(rows, startDate, endDate);
        }
        // ä»–ã®colTypeã§æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ãŒã‚ã‚‹å ´åˆã‚‚rawã‹ã‚‰å¯¾å¿œã™ã‚‹åˆ†æã‚’å†ç¾
        // ãŸã ã—1æ›²ç›®ãƒ»ãƒˆãƒªç­‰ã¯ç”Ÿãƒ‡ãƒ¼ã‚¿ã ã‘ã§ã¯åˆ¤æ–­ã§ããªã„ã®ã§ã€ãƒ•ã‚£ãƒ«ã‚¿ãªã—ã§é›†è¨ˆæ¸ˆã¿ã‚’ä½¿ç”¨
        return aggregateFromRanking(rows, colType, null, null);
      }
      return aggregateFromRanking(rows, colType, startDate, endDate);
    }

    // ============================================================
    // ãƒãƒ£ãƒ¼ãƒˆç®¡ç†
    // ============================================================
    let mainChartInstance = null;

    function destroyChart(instance) {
      if (instance) { try { instance.destroy(); } catch(e) {} }
      return null;
    }

    function getChartConfig(type, labels, data, label) {
      const colors = labels.map((_, i) => COLORS[i % COLORS.length]);
      const baseOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: type === 'pie' || type === 'doughnut', position: 'right',
            labels: { font: { family: 'Zen Maru Gothic', size: 11 }, padding: 12, boxWidth: 12 }
          },
          tooltip: {
            callbacks: {
              label: ctx => ` ${ctx.parsed.y ?? ctx.parsed}å›`
            }
          }
        }
      };

      if (type === 'pie' || type === 'doughnut') {
        return {
          type,
          data: { labels, datasets: [{ data, backgroundColor: colors, borderWidth: 2, borderColor: '#fff' }] },
          options: { ...baseOptions, plugins: { ...baseOptions.plugins,
            tooltip: { callbacks: { label: ctx => ` ${ctx.label}: ${ctx.parsed}å›` } }
          }}
        };
      }

      if (type === 'horizontalBar') {
        return {
          type: 'bar',
          data: { labels, datasets: [{ label, data, backgroundColor: colors, borderRadius: 6, borderSkipped: false }] },
          options: {
            ...baseOptions,
            indexAxis: 'y',
            plugins: { ...baseOptions.plugins, legend: { display: false } },
            scales: {
              x: { grid: { color: 'rgba(0,0,0,0.04)' }, ticks: { font: { family: 'DM Mono', size: 11 } } },
              y: { grid: { display: false }, ticks: { font: { family: 'Zen Maru Gothic', size: 11 } } }
            }
          }
        };
      }

      // ç¸¦æ£’ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
      return {
        type: 'bar',
        data: { labels, datasets: [{ label, data, backgroundColor: colors, borderRadius: 8, borderSkipped: false }] },
        options: {
          ...baseOptions,
          plugins: { ...baseOptions.plugins, legend: { display: false } },
          scales: {
            x: { grid: { display: false }, ticks: { font: { family: 'Zen Maru Gothic', size: 10 }, maxRotation: 45 } },
            y: { grid: { color: 'rgba(0,0,0,0.04)' }, ticks: { font: { family: 'DM Mono', size: 11 } } }
          }
        }
      };
    }

    // ============================================================
    // åˆ†æå®Ÿè¡Œ
    // ============================================================
    async function analyze() {
      const year = document.getElementById('yearSelect').value;
      const colType = document.getElementById('columnSelect').value;
      const chartType = document.getElementById('chartTypeSelect').value;
      const limit = parseInt(document.getElementById('limitSelect').value);
      const startVal = document.getElementById('startDate').value;
      const endVal = document.getElementById('endDate').value;

      const startDate = startVal ? new Date(startVal) : null;
      const endDate = endVal ? new Date(endVal + 'T23:59:59') : null;

      showLoading(true);
      try {
        const rows = await fetchSheetData(year);
        let results = aggregateData(rows, colType, startDate, endDate);

        if (results.length === 0) {
          alert('è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦ã¿ã¦ãã ã•ã„ã€‚');
          return;
        }

        // ä»¶æ•°åˆ¶é™
        const limited = results.slice(0, limit);

        // Stats
        const total = results.reduce((s, r) => s + r[1], 0);
        document.getElementById('stat-songs').textContent = results.length + 'æ›²';
        document.getElementById('stat-total').textContent = total + 'å›';
        document.getElementById('stat-top').textContent = results[0][0];
        document.getElementById('statsRow').style.display = 'flex';

        // Chart
        const labels = limited.map(r => r[0]);
        const data = limited.map(r => r[1]);
        const colLabel = document.getElementById('columnSelect').selectedOptions[0].text;

        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('chartTitleText').textContent = `${year}å¹´ ${colLabel}`;
        document.getElementById('chartSubtitle').textContent = `ä¸Šä½${limited.length}ä»¶ / å…¨${results.length}æ›²`;

        mainChartInstance = destroyChart(mainChartInstance);
        const ctx = document.getElementById('mainChart').getContext('2d');
        mainChartInstance = new Chart(ctx, getChartConfig(chartType, labels, data, colLabel));

        // Ranking
        renderRanking(results, limit);

      } catch (e) {
        alert('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®å…±æœ‰è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n\nã‚¨ãƒ©ãƒ¼: ' + e.message);
        console.error(e);
      } finally {
        showLoading(false);
      }
    }

    // ============================================================
    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°æç”»
    // ============================================================
    function renderRanking(results, limit) {
      const grid = document.getElementById('rankingGrid');
      grid.innerHTML = '';
      const max = results[0]?.[1] || 1;

      results.slice(0, limit === 999 ? results.length : limit).forEach(([name, count], i) => {
        const rank = i + 1;
        const rankClass = rank === 1 ? 'top1' : rank === 2 ? 'top2' : rank === 3 ? 'top3' : '';
        const pct = Math.round((count / max) * 100);

        const item = document.createElement('div');
        item.className = 'ranking-item';
        item.innerHTML = `
          <span class="rank-num ${rankClass}">${rank}</span>
          <div style="flex:1; overflow:hidden;">
            <div class="rank-name">${name}</div>
            <div class="rank-bar-wrap"><div class="rank-bar" style="width:${pct}%"></div></div>
          </div>
          <span class="rank-count">${count}å›</span>
        `;
        grid.appendChild(item);
      });
    }

    // ============================================================
    // å¹´åº¦æ¯”è¼ƒ
    // ============================================================
    let eventChartInst = null;
    let monthlyChartInst = null;
    let trendChartInst = null;

    async function runCompare() {
      showLoading(true);
      try {
        const [rows2024, rows2025] = await Promise.all([
          fetchSheetData('2024'),
          fetchSheetData('2025')
        ]);

        // å…¬æ¼”æ•°ï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼‰
        const eventCounts = {};
        const monthlyData = {};
        for (let m = 1; m <= 12; m++) monthlyData[m] = { '2024': 0, '2025': 0 };

        for (const [year, rows] of [['2024', rows2024], ['2025', rows2025]]) {
          const seen = new Set();
          rows.slice(2).forEach(row => {
            if (!row[0] || !/^\d{5}/.test(row[0])) return;
            const d = parseDate(row[0]);
            if (!d) return;
            const key = row[0] + '_' + (row[2] || '');
            const month = d.getMonth() + 1;
            if (!seen.has(key)) {
              seen.add(key);
              monthlyData[month][year]++;
            }
          });
          eventCounts[year] = seen.size;
        }

        // æ¥½æ›²åˆ¥æ¯”è¼ƒ - ç”Ÿã‚»ãƒˆãƒªãƒ‡ãƒ¼ã‚¿ï¼ˆDåˆ—ï¼‰ã‹ã‚‰é›†è¨ˆ
        const songMap = {};
        for (const [year, rows] of [['2024', rows2024], ['2025', rows2025]]) {
          rows.slice(2).forEach(row => {
            if (!row[0] || !/^\d{5}/.test(row[0])) return;
            const name = row[3]; // Dåˆ—: ç”Ÿã‚»ãƒˆãƒªæ›²å
            if (!name || name.trim() === '') return;
            if (!songMap[name]) songMap[name] = { '2024': 0, '2025': 0 };
            songMap[name][year]++;
          });
        }

        const sortedSongs = Object.entries(songMap)
          .sort((a, b) => (b[1]['2024'] + b[1]['2025']) - (a[1]['2024'] + a[1]['2025']))
          .slice(0, 15);

        // --- å…¬æ¼”æ•°ã‚°ãƒ©ãƒ• ---
        eventChartInst = destroyChart(eventChartInst);
        const ctx1 = document.getElementById('eventChart').getContext('2d');
        eventChartInst = new Chart(ctx1, {
          type: 'bar',
          data: {
            labels: ['2024å¹´', '2025å¹´'],
            datasets: [{
              data: [eventCounts['2024'], eventCounts['2025']],
              backgroundColor: [COLORS[1], COLORS[0]],
              borderRadius: 10,
              borderSkipped: false
            }]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false },
              tooltip: { callbacks: { label: ctx => ` ${ctx.parsed.y}å…¬æ¼”` } }
            },
            scales: {
              x: { grid: { display: false }, ticks: { font: { family: 'Zen Maru Gothic', size: 12 } } },
              y: { grid: { color: 'rgba(0,0,0,0.04)' }, ticks: { font: { family: 'DM Mono' } } }
            }
          }
        });

        // --- æœˆåˆ¥æ¨ç§»ã‚°ãƒ©ãƒ• ---
        const months = ['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
        monthlyChartInst = destroyChart(monthlyChartInst);
        const ctx2 = document.getElementById('monthlyChart').getContext('2d');
        monthlyChartInst = new Chart(ctx2, {
          type: 'line',
          data: {
            labels: months,
            datasets: [
              { label: '2024', data: months.map((_, i) => monthlyData[i+1]['2024']), borderColor: COLORS[1], backgroundColor: 'rgba(212,175,55,0.1)', fill: true, tension: 0.4, pointRadius: 4 },
              { label: '2025', data: months.map((_, i) => monthlyData[i+1]['2025']), borderColor: COLORS[0], backgroundColor: 'rgba(244,114,182,0.1)', fill: true, tension: 0.4, pointRadius: 4 }
            ]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom', labels: { font: { family: 'Zen Maru Gothic', size: 11 }, padding: 12, boxWidth: 12 } } },
            scales: {
              x: { grid: { display: false }, ticks: { font: { family: 'Zen Maru Gothic', size: 10 } } },
              y: { grid: { color: 'rgba(0,0,0,0.04)' }, ticks: { font: { family: 'DM Mono' } } }
            }
          }
        });

        // --- æ¥½æ›²æ¯”è¼ƒã‚°ãƒ©ãƒ• ---
        trendChartInst = destroyChart(trendChartInst);
        const ctx3 = document.getElementById('trendChart').getContext('2d');
        trendChartInst = new Chart(ctx3, {
          type: 'bar',
          data: {
            labels: sortedSongs.map(([name]) => name.length > 12 ? name.slice(0,12)+'â€¦' : name),
            datasets: [
              { label: '2024', data: sortedSongs.map(([, v]) => v['2024']), backgroundColor: COLORS[1], borderRadius: 4, borderSkipped: false },
              { label: '2025', data: sortedSongs.map(([, v]) => v['2025']), backgroundColor: COLORS[0], borderRadius: 4, borderSkipped: false }
            ]
          },
          options: {
            indexAxis: 'y',
            responsive: true, maintainAspectRatio: false,
            plugins: {
              legend: { position: 'top', labels: { font: { family: 'Zen Maru Gothic', size: 12 }, padding: 16, boxWidth: 12 } },
              tooltip: { callbacks: { label: ctx => ` ${ctx.dataset.label}: ${ctx.parsed.x}å›` } }
            },
            scales: {
              x: { grid: { color: 'rgba(0,0,0,0.04)' }, ticks: { font: { family: 'DM Mono' } }, stacked: false },
              y: { grid: { display: false }, ticks: { font: { family: 'Zen Maru Gothic', size: 11 } } }
            }
          }
        });

      } catch (e) {
        alert('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
        console.error(e);
      } finally {
        showLoading(false);
      }
    }

    // ============================================================
    // UI ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    // ============================================================
    function switchTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.getElementById('tab-' + tabId).classList.add('active');

      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      const navBtns = document.querySelectorAll('.nav-btn');
      const tabOrder = ['single', 'ranking', 'compare'];
      const idx = tabOrder.indexOf(tabId);
      if (navBtns[idx]) navBtns[idx].classList.add('active');

      document.querySelectorAll('.mobile-nav-btn').forEach(b => b.classList.remove('active'));
      const mBtn = document.getElementById('mnav-' + tabId);
      if (mBtn) mBtn.classList.add('active');
    }

    function resetFilters() {
      document.getElementById('yearSelect').value = '2025';
      document.getElementById('columnSelect').value = 'song';
      document.getElementById('chartTypeSelect').value = 'bar';
      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';
      document.getElementById('limitSelect').value = '10';
      document.getElementById('statsRow').style.display = 'none';
      document.getElementById('emptyState').style.display = 'flex';
      document.getElementById('chartTitleText').textContent = 'åˆ†æçµæœ';
      document.getElementById('chartSubtitle').textContent = 'åˆ†æè¨­å®šã‚’é¸æŠã—ã¦ã€Œåˆ†æã‚’é–‹å§‹ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„';
      mainChartInstance = destroyChart(mainChartInstance);
    }

    function showLoading(show) {
      document.getElementById('loading').classList.toggle('show', show);
    }
  </script>
</body>
</html>
