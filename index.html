<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãŸã‹ã­ã“ æ¥½æ›²åˆ†æ Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
  <style>
    :root {
      --pink:#f472b6; --pink-light:#fce7f3; --pink-dark:#db2777; --pink-soft:#fbcfe8;
      --gold:#d4af37; --gold-light:#fef9e7;
      --bg:#fff5f9; --surface:#ffffff; --text:#3d2b35; --text-muted:#9d6b8a;
      --border:#fad4e8; --radius:20px;
      --shadow:0 4px 24px rgba(244,114,182,0.12);
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:'Zen Maru Gothic',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;
      background-image:radial-gradient(circle at 20% 20%,rgba(244,114,182,0.08) 0%,transparent 50%),
      radial-gradient(circle at 80% 80%,rgba(212,175,55,0.06) 0%,transparent 50%);}

    /* HEADER */
    header{background:var(--surface);border-bottom:1px solid var(--border);padding:0 20px;position:sticky;top:0;z-index:100;box-shadow:0 2px 12px rgba(244,114,182,0.08);}
    .header-inner{max-width:1280px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;height:64px;gap:10px;}
    .logo{display:flex;flex-direction:column;line-height:1.2;flex-shrink:0;}
    .logo-sub{font-size:9px;letter-spacing:2px;color:var(--gold);font-family:'DM Mono',monospace;text-transform:uppercase;}
    .logo-main{font-size:15px;font-weight:700;color:var(--pink-dark);}
    nav{display:flex;gap:4px;flex-shrink:0;}
    .nav-btn{padding:7px 13px;border:1.5px solid var(--border);background:transparent;color:var(--text-muted);border-radius:50px;cursor:pointer;font-family:'Zen Maru Gothic',sans-serif;font-size:12px;font-weight:500;transition:all .2s;white-space:nowrap;}
    .nav-btn:hover{border-color:var(--pink);color:var(--pink);background:var(--pink-light);}
    .nav-btn.active{background:var(--pink);border-color:var(--pink);color:#fff;box-shadow:0 2px 12px rgba(244,114,182,0.3);}
    .official-links{display:flex;gap:5px;flex-shrink:0;}
    .link-btn{padding:5px 10px;border-radius:50px;text-decoration:none;font-size:10px;font-weight:700;color:#fff;transition:all .2s;white-space:nowrap;}
    .link-btn:hover{transform:translateY(-2px);opacity:.85;}
    .link-web{background:var(--pink);} .link-x{background:#000;} .link-yt{background:#f00;} .link-fc{background:var(--gold);}

    /* MAIN */
    main{max-width:1280px;margin:0 auto;padding:22px 18px;}
    .tab-content{display:none;animation:fadeUp .3s ease;}
    .tab-content.active{display:block;}
    @keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

    /* CARDS */
    .card{background:var(--surface);border-radius:var(--radius);padding:18px;border:1px solid var(--border);box-shadow:var(--shadow);margin-bottom:16px;}
    .card-title{font-size:11px;font-weight:700;letter-spacing:2px;color:var(--gold);font-family:'DM Mono',monospace;text-transform:uppercase;margin-bottom:12px;}
    .chart-card{background:var(--surface);border-radius:var(--radius);border:1px solid var(--border);box-shadow:var(--shadow);padding:18px;margin-bottom:16px;position:relative;min-height:380px;}
    .chart-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px;flex-wrap:wrap;gap:8px;}
    .chart-title{font-size:15px;font-weight:700;color:var(--text);}
    .chart-subtitle{font-size:11px;color:var(--text-muted);margin-top:2px;}
    .chart-wrap{position:relative;height:380px;}

    /* CONTROLS */
    .controls-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(155px,1fr));gap:10px;align-items:end;}
    .field{display:flex;flex-direction:column;gap:4px;}
    .field label{font-size:11px;font-weight:700;color:var(--pink-dark);}
    select,input[type=date],input[type=month]{padding:8px 30px 8px 11px;border:1.5px solid var(--border);border-radius:11px;font-family:'Zen Maru Gothic',sans-serif;font-size:13px;color:var(--text);background:var(--surface);outline:none;transition:border-color .2s;width:100%;appearance:none;-webkit-appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%239d6b8a' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;}
    input[type=date],input[type=month]{background-image:none;padding-right:11px;}
    select:focus,input:focus{border-color:var(--pink);box-shadow:0 0 0 3px rgba(244,114,182,0.1);}
    .btn-row{display:flex;gap:8px;align-items:center;padding-top:2px;}
    .btn{padding:9px 16px;border-radius:50px;border:none;font-family:'Zen Maru Gothic',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:all .2s;white-space:nowrap;}
    .btn-primary{background:var(--pink);color:#fff;flex:1;box-shadow:0 2px 12px rgba(244,114,182,0.25);}
    .btn-primary:hover{background:var(--pink-dark);transform:translateY(-2px);}
    .btn-secondary{background:#f3f4f6;color:#888;}
    .btn-secondary:hover{background:#e5e7eb;}
    .btn-gold{background:var(--gold);color:#fff;box-shadow:0 2px 12px rgba(212,175,55,0.25);}
    .btn-gold:hover{transform:translateY(-2px);opacity:.9;}
    .notice{background:var(--pink-light);border-left:3px solid var(--pink);padding:8px 12px;border-radius:8px;font-size:11px;color:var(--pink-dark);margin-top:10px;line-height:1.6;}

    /* ZOOM HINT */
    .zoom-hint{display:inline-flex;align-items:center;gap:4px;font-size:10px;color:var(--text-muted);background:var(--pink-light);padding:3px 9px;border-radius:20px;font-family:'DM Mono',monospace;}
    .zoom-reset-btn{padding:3px 9px;border-radius:20px;border:1.5px solid var(--border);background:var(--surface);color:var(--text-muted);font-size:11px;cursor:pointer;font-family:'Zen Maru Gothic',sans-serif;font-weight:700;transition:all .2s;}
    .zoom-reset-btn:hover{border-color:var(--pink);color:var(--pink);}

    /* EMPTY STATE */
    .empty-state{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--text-muted);gap:12px;}
    .empty-icon{font-size:48px;opacity:.4;} .empty-text{font-size:14px;}

    /* STATS PILLS */
    .stats-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;}
    .stat-pill{background:var(--surface);border:1px solid var(--border);border-radius:50px;padding:6px 14px;display:flex;align-items:center;gap:7px;box-shadow:var(--shadow);}
    .stat-label{font-size:10px;color:var(--text-muted);}
    .stat-val{font-family:'DM Mono',monospace;font-size:14px;font-weight:500;color:var(--pink-dark);}

    /* RANKING */
    .ranking-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(255px,1fr));gap:7px;}
    .ranking-item{display:flex;align-items:center;gap:11px;padding:11px 13px;background:var(--surface);border:1px solid var(--border);border-radius:13px;transition:all .2s;cursor:pointer;}
    .ranking-item:hover{border-color:var(--pink);box-shadow:var(--shadow);transform:translateY(-2px);}
    .rank-num{font-family:'DM Mono',monospace;font-size:16px;font-weight:500;color:var(--pink-soft);width:28px;flex-shrink:0;text-align:center;}
    .rank-num.top1{color:var(--gold);font-size:20px;} .rank-num.top2{color:#b0b0b0;font-size:18px;} .rank-num.top3{color:#cd7f32;font-size:18px;}
    .rank-name{flex:1;font-size:13px;font-weight:700;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .rank-count{font-family:'DM Mono',monospace;font-size:13px;font-weight:500;color:var(--gold);flex-shrink:0;}
    .rank-bar-wrap{width:100%;height:3px;background:var(--border);border-radius:2px;margin-top:5px;overflow:hidden;}
    .rank-bar{height:100%;background:linear-gradient(90deg,var(--pink),var(--gold));border-radius:2px;transition:width .8s cubic-bezier(.4,0,.2,1);}

    /* COMPARE */
    .compare-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;}
    .chart-half{background:var(--surface);border-radius:var(--radius);border:1px solid var(--border);box-shadow:var(--shadow);padding:16px;}
    .chart-half-wrap{position:relative;height:260px;}
    .stat-badge{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:12px 16px;box-shadow:var(--shadow);}

    /* CATEGORY BTNS */
    .cat-btn{padding:5px 11px;border:1.5px solid var(--border);border-radius:20px;background:var(--surface);color:var(--text-muted);font-family:'Zen Maru Gothic',sans-serif;font-size:11px;font-weight:700;cursor:pointer;transition:all .18s;white-space:nowrap;}
    .cat-btn:hover{border-color:var(--pink);color:var(--pink-dark);background:var(--pink-light);}
    .cat-btn.active{background:linear-gradient(135deg,var(--pink),var(--pink-dark));border-color:var(--pink-dark);color:#fff;box-shadow:0 3px 12px rgba(244,114,182,0.35);}
    .cat-group{display:flex;gap:5px;flex-wrap:wrap;}

    /* YEAR CHECKBOX */
    .year-check-label{display:flex;align-items:center;gap:5px;font-size:12px;font-weight:700;color:var(--text-muted);cursor:pointer;padding:5px 10px;border:1.5px solid var(--border);border-radius:20px;transition:all .15s;user-select:none;}
    .year-check-label:hover{border-color:var(--pink);color:var(--pink-dark);background:var(--pink-light);}
    .year-check-label input[type=checkbox]{width:14px;height:14px;accent-color:var(--pink);cursor:pointer;}
    .year-check-label:has(input:checked){border-color:var(--pink-dark);background:var(--pink-light);color:var(--pink-dark);}

    /* PREF */
    .pref-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(125px,1fr));gap:7px;}
    .pref-card{background:var(--surface);border:1px solid var(--border);border-radius:13px;padding:11px;text-align:center;transition:all .2s;cursor:pointer;}
    .pref-card:hover{border-color:var(--pink);transform:translateY(-2px);box-shadow:var(--shadow);}
    .pref-name{font-size:11px;font-weight:700;color:var(--text);margin-bottom:3px;}
    .pref-count{font-family:'DM Mono',monospace;font-size:20px;font-weight:500;color:var(--pink-dark);}
    .pref-sub{font-size:9px;color:var(--text-muted);}
    .pref-top{font-size:9px;color:var(--gold);font-weight:700;margin-top:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

    /* LOADING */
    .loading-overlay{position:fixed;inset:0;background:rgba(255,245,249,0.92);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:9999;gap:16px;backdrop-filter:blur(4px);}
    .loading-overlay.show{display:flex;}
    .spinner{width:44px;height:44px;border:3px solid var(--pink-soft);border-top-color:var(--pink);border-radius:50%;animation:spin .8s linear infinite;}
    .loading-text{font-size:13px;color:var(--text-muted);font-family:'DM Mono',monospace;letter-spacing:2px;}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* MOBILE NAV */
    .mobile-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--surface);border-top:1px solid var(--border);padding:7px 12px env(safe-area-inset-bottom,10px);z-index:100;gap:3px;}
    .mobile-nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px 3px;border:none;background:transparent;color:var(--text-muted);font-family:'Zen Maru Gothic',sans-serif;font-size:9px;font-weight:500;cursor:pointer;border-radius:11px;transition:all .2s;}
    .mobile-nav-btn.active{color:var(--pink);background:var(--pink-light);}
    .mobile-nav-icon{font-size:18px;}

    /* DRILL MODAL */
    .drill-modal{display:none;position:fixed;inset:0;z-index:1000;background:rgba(61,43,53,0.55);backdrop-filter:blur(6px);overflow-y:auto;padding:18px 14px;}
    .drill-inner{max-width:760px;margin:0 auto;background:var(--surface);border-radius:var(--radius);box-shadow:0 20px 80px rgba(244,114,182,0.25);overflow:hidden;}
    .drill-head{background:linear-gradient(135deg,var(--pink),var(--pink-dark));padding:20px 24px;display:flex;justify-content:space-between;align-items:center;}
    .drill-close{background:rgba(255,255,255,0.2);border:none;border-radius:50%;width:34px;height:34px;cursor:pointer;font-size:17px;color:#fff;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:background .2s;}
    .drill-close:hover{background:rgba(255,255,255,0.35);}
    .drill-body{padding:20px 24px;}

    /* RESPONSIVE */
    @media(max-width:900px){.compare-grid{grid-template-columns:1fr;}}
    @media(max-width:768px){
      header{padding:0 12px;} .header-inner{height:52px;} .logo-main{font-size:13px;}
      nav{display:none;} .official-links{display:none;}
      main{padding:12px 10px 80px;}
      .controls-grid{grid-template-columns:1fr 1fr;}
      .mobile-nav{display:flex;}
      .card{padding:13px;} .chart-card{padding:13px;min-height:300px;}
      .chart-wrap{height:280px;} .chart-half-wrap{height:210px;}
      .ranking-grid{grid-template-columns:1fr;}
      .drill-body{padding:14px;} .drill-head{padding:14px 16px;}
      .pref-grid{grid-template-columns:repeat(auto-fill,minmax(100px,1fr));}
    }
    @media(max-width:480px){
      .controls-grid{grid-template-columns:1fr;}
      .stats-row{gap:5px;} .cat-btn{font-size:10px;padding:4px 9px;}
    }

    /* ===== EVENT SEARCH TAB ===== */
    .event-search-box{position:relative;margin-bottom:12px;}
    .event-search-input{width:100%;padding:10px 40px 10px 14px;border:1.5px solid var(--border);border-radius:12px;font-family:'Zen Maru Gothic',sans-serif;font-size:13px;color:var(--text);background:var(--surface);outline:none;transition:border-color .2s;}
    .event-search-input:focus{border-color:var(--pink);box-shadow:0 0 0 3px rgba(244,114,182,0.1);}
    .event-search-icon{position:absolute;right:12px;top:50%;transform:translateY(-50%);font-size:16px;pointer-events:none;}
    .event-year-section{margin-bottom:10px;}
    .event-year-header{display:flex;align-items:center;gap:8px;padding:6px 10px;background:var(--pink-light);border-radius:10px;cursor:pointer;user-select:none;margin-bottom:5px;}
    .event-year-label{font-size:11px;font-weight:700;color:var(--pink-dark);font-family:'DM Mono',monospace;}
    .event-year-count{font-size:10px;color:var(--text-muted);margin-left:auto;}
    .event-group-section{margin-bottom:7px;margin-left:10px;}
    .event-group-header{display:flex;align-items:center;gap:8px;padding:5px 10px;background:var(--bg);border:1px solid var(--border);border-radius:9px;cursor:pointer;user-select:none;margin-bottom:3px;}
    .event-group-label{font-size:12px;font-weight:700;color:var(--text);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .event-group-count{font-size:10px;color:var(--text-muted);flex-shrink:0;}
    .event-group-toggle{font-size:10px;color:var(--text-muted);flex-shrink:0;transition:transform .2s;}
    .event-items{display:none;flex-direction:column;gap:2px;margin-left:10px;margin-bottom:4px;}
    .event-items.open{display:flex;}
    .event-item{display:flex;align-items:center;gap:8px;padding:5px 10px;border-radius:8px;cursor:pointer;transition:background .15s;}
    .event-item:hover{background:var(--pink-light);}
    .event-item input[type=checkbox]{width:14px;height:14px;accent-color:var(--pink);cursor:pointer;flex-shrink:0;}
    .event-item-name{font-size:11px;color:var(--text);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .event-item-date{font-size:10px;color:var(--text-muted);flex-shrink:0;font-family:'DM Mono',monospace;}
    .selected-tags{display:flex;flex-wrap:wrap;gap:5px;min-height:24px;margin-bottom:10px;}
    .sel-tag{display:flex;align-items:center;gap:4px;padding:3px 10px;background:var(--pink);color:#fff;border-radius:20px;font-size:11px;font-weight:700;}
    .sel-tag-x{cursor:pointer;font-size:12px;opacity:.8;transition:opacity .15s;background:none;border:none;color:#fff;padding:0;}
    .sel-tag-x:hover{opacity:1;}
    .ev-compare-panel{display:none;margin-top:10px;}
    .ev-slot{background:var(--surface);border:2px dashed var(--border);border-radius:14px;padding:14px;margin-bottom:10px;}
    .ev-slot.has-data{border-style:solid;border-color:var(--pink);}
    .ev-slot-label{font-size:11px;font-weight:700;color:var(--gold);font-family:'DM Mono',monospace;text-transform:uppercase;margin-bottom:8px;}
    .ev-slot-tags{display:flex;flex-wrap:wrap;gap:5px;min-height:22px;}

    /* ===== æ¥½æ›²åˆ†æãƒ»ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ ===== */
    .mode-btn{padding:7px 14px;border:1.5px solid var(--border);background:transparent;color:var(--text-muted);border-radius:50px;cursor:pointer;font-family:'Zen Maru Gothic',sans-serif;font-size:12px;font-weight:700;transition:all .2s;white-space:nowrap;}
    .mode-btn:hover{border-color:var(--pink);color:var(--pink);background:var(--pink-light);}
    .mode-btn.active{background:var(--pink);border-color:var(--pink);color:#fff;box-shadow:0 2px 10px rgba(244,114,182,0.3);}

    /* ===== ã‚»ãƒˆãƒªè¡¨ç¤º ===== */
    .setlist-song{display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--bg);border-radius:10px;border-left:3px solid transparent;transition:all .15s;}
    .setlist-song.is-first{border-left-color:var(--gold);}
    .setlist-song.is-last{border-left-color:var(--pink);}
    .setlist-num{font-family:'DM Mono',monospace;font-size:11px;color:var(--text-muted);width:22px;flex-shrink:0;text-align:right;}
    .setlist-name{flex:1;font-size:13px;font-weight:600;color:var(--text);}
    .setlist-tag{font-size:9px;font-weight:700;padding:1px 6px;border-radius:10px;flex-shrink:0;}
    .setlist-tag.first{background:var(--gold-light);color:var(--gold);}
    .setlist-tag.last{background:var(--pink-light);color:var(--pink-dark);}

    /* ===== æ¥½æ›²ã‚µãƒãƒªãƒ¼ ===== */
    .song-sum-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;box-shadow:var(--shadow);}
    .song-sum-label{font-size:10px;color:var(--text-muted);font-family:'DM Mono',monospace;letter-spacing:1px;margin-bottom:5px;}
    .song-sum-val{font-size:20px;font-weight:700;color:var(--pink-dark);}
    .song-sum-sub{font-size:10px;color:var(--text-muted);margin-top:2px;}

    /* ===== ãƒ¢ãƒã‚¤ãƒ«å…¬æ¼”ãƒ‘ãƒãƒ« ===== */
    @media(max-width:900px){
      #eventMainGrid{grid-template-columns:1fr!important;}
    }
  </style>
</head>
<body>

<header>
  <div class="header-inner">
    <div class="logo">
      <span class="logo-sub">Advanced Performance Analysis</span>
      <span class="logo-main">ãŸã‹ã­ã“ æ¥½æ›²åˆ†æ Portal</span>
    </div>
    <nav>
      <button class="nav-btn active" onclick="switchTab('analyze')">ğŸµ æ¥½æ›²åˆ†æ</button>
      <button class="nav-btn" onclick="switchTab('compare')">ğŸ“ˆ å¹´åº¦æ¯”è¼ƒ</button>
      <button class="nav-btn" onclick="switchTab('event')">ğŸ¤ å…¬æ¼”åˆ¥</button>
      <button class="nav-btn" onclick="switchTab('pref')">ğŸ—¾ éƒ½é“åºœçœŒ</button>
    </nav>
    <div class="official-links">
      <a href="https://takanenonadeshiko.jp/" target="_blank" class="link-btn link-web">å…¬å¼</a>
      <a href="https://x.com/takanenofficial" target="_blank" class="link-btn link-x">X</a>
      <a href="https://www.youtube.com/channel/UCoR4zZDvWvUIqgEWz4HS-sA" target="_blank" class="link-btn link-yt">YT</a>
      <a href="https://takanekofc.com/#/" target="_blank" class="link-btn link-fc">FC</a>
    </div>
  </div>
</header>

<main>

  <!-- ===== TAB: æ¥½æ›²åˆ†æ ===== -->
  <div id="tab-analyze" class="tab-content active">

    <!-- ä¸Šæ®µã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
    <div class="card" style="margin-bottom:14px;">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:12px;">
        <div class="card-title" style="margin-bottom:0;">ğŸµ æ¥½æ›²åˆ†æ</div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;" id="analyzeYearBtns">
          <span style="font-size:11px;color:var(--text-muted);font-weight:700;">å¯¾è±¡å¹´ï¼š</span>
          <label class="year-check-label"><input type="checkbox" class="an-year-cb" value="2023" onchange="onAnalyzeYearChange()"> 2023</label>
          <label class="year-check-label"><input type="checkbox" class="an-year-cb" value="2024" onchange="onAnalyzeYearChange()"> 2024</label>
          <label class="year-check-label"><input type="checkbox" class="an-year-cb" value="2025" checked onchange="onAnalyzeYearChange()"> 2025</label>
          <label class="year-check-label"><input type="checkbox" class="an-year-cb" value="2026" onchange="onAnalyzeYearChange()"> 2026</label>
        </div>
      </div>

      <!-- ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ -->
      <div style="display:flex;gap:6px;margin-bottom:14px;border-bottom:1px solid var(--border);padding-bottom:12px;">
        <button class="mode-btn active" id="modeBtnCategory" onclick="setAnalyzeMode('category')">ğŸ“Š ã‚«ãƒ†ã‚´ãƒªåˆ†æ</button>
        <button class="mode-btn" id="modeBtnSong" onclick="setAnalyzeMode('song')">ğŸµ æ¥½æ›²ã‚’é¸ã‚“ã§åˆ†æ</button>
      </div>

      <!-- ã‚«ãƒ†ã‚´ãƒªãƒ¢ãƒ¼ãƒ‰ -->
      <div id="panelCategory">
        <div class="controls-grid">
          <div class="field">
            <label>åˆ†æã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
            <select id="columnSelect">
              <optgroup label="åŸºæœ¬">
                <option value="song">â˜… æ¥½æ›²åˆ¥ æ­Œå”±å›æ•°</option>
                <option value="first">ã€1æ›²ç›®ã€‘å‡ºç¾å›æ•°</option>
                <option value="last">ã€ãƒˆãƒªã€‘å‡ºç¾å›æ•°</option>
                <option value="combo">é‰„æ¿ã‚³ãƒ³ãƒœåˆ†æ</option>
              </optgroup>
              <optgroup label="å­£ç¯€åˆ¥">
                <option value="spring">æ˜¥ (3ã€œ5æœˆ)</option>
                <option value="summer">å¤ (6ã€œ8æœˆ)</option>
                <option value="autumn">ç§‹ (9ã€œ11æœˆ)</option>
                <option value="winter">å†¬ (12ã€œ2æœˆ)</option>
              </optgroup>
              <optgroup label="ã‚»ãƒƒãƒˆè¦æ¨¡åˆ¥">
                <option value="shortFirst">å°‘æ›²æ•°(1-4æ›²)1æ›²ç›®</option>
                <option value="longFirst">å¤šæ›²æ•°(5æ›²ä»¥ä¸Š)1æ›²ç›®</option>
              </optgroup>
              <optgroup label="âœ¨ ã‚¤ãƒ™ãƒ³ãƒˆç¨®åˆ¥">
                <option value="fesFirst">ãƒ•ã‚§ã‚¹/å¯¾ãƒãƒ³é™å®š 1æ›²ç›®</option>
                <option value="fesSong">ãƒ•ã‚§ã‚¹/å¯¾ãƒãƒ³é™å®š TOPæ›²</option>
                <option value="onemanFirst">ãƒ¯ãƒ³ãƒãƒ³é™å®š 1æ›²ç›®</option>
                <option value="onemanSong">ãƒ¯ãƒ³ãƒãƒ³é™å®š TOPæ›²</option>
                <option value="multiFirst">äºŒéƒ¨åˆ¶é™å®š 1æ›²ç›®</option>
              </optgroup>
            </select>
          </div>
          <div class="field">
            <label>ã‚°ãƒ©ãƒ•ç¨®åˆ¥</label>
            <select id="chartTypeSelect">
              <option value="horizontalBar">æ¨ªæ£’ã‚°ãƒ©ãƒ•</option>
              <option value="bar">ç¸¦æ£’ã‚°ãƒ©ãƒ•</option>
              <option value="pie">å††ã‚°ãƒ©ãƒ•</option>
              <option value="doughnut">ãƒ‰ãƒ¼ãƒŠãƒ„ã‚°ãƒ©ãƒ•</option>
            </select>
          </div>
          <div class="field">
            <label>æœŸé–“ï¼ˆé–‹å§‹ï¼‰</label>
            <input type="date" id="startDate">
          </div>
          <div class="field">
            <label>æœŸé–“ï¼ˆçµ‚äº†ï¼‰</label>
            <input type="date" id="endDate">
          </div>
          <div class="field">
            <label>è¡¨ç¤ºä»¶æ•°</label>
            <select id="limitSelect">
              <option value="10">ä¸Šä½10ä»¶</option>
              <option value="20" selected>ä¸Šä½20ä»¶</option>
              <option value="30">ä¸Šä½30ä»¶</option>
              <option value="999">å…¨ä»¶</option>
            </select>
          </div>
        </div>
        <div class="btn-row" style="margin-top:12px;">
          <button class="btn btn-primary" onclick="analyze()">ğŸ“Š åˆ†æã‚’é–‹å§‹ã™ã‚‹</button>
          <button class="btn btn-secondary" onclick="resetFilters()">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        <div class="notice">ğŸ’¡ ã‚°ãƒ©ãƒ•ã¯ãƒ‰ãƒ©ãƒƒã‚°ã§ç¯„å›²ã‚ºãƒ¼ãƒ ãƒ»ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ãƒªã‚»ãƒƒãƒˆã€‚ãƒãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨æ›²ã®è©³ç´°ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚è¤‡æ•°å¹´ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã¨å¹´åº¦æ¯”è¼ƒã‚‚å¯èƒ½ã€‚</div>
      </div>

      <!-- æ¥½æ›²é¸æŠãƒ¢ãƒ¼ãƒ‰ -->
      <div id="panelSong" style="display:none;">
        <div style="display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap;">
          <div class="field" style="flex:1;min-width:200px;">
            <label>ğŸ” æ¥½æ›²åã‚’é¸æŠãƒ»æ¤œç´¢</label>
            <input type="text" id="songSearchInput" placeholder="æ›²åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." list="songDatalist" oninput="onSongInputChange()" style="padding:8px 12px;border:1.5px solid var(--border);border-radius:11px;font-family:inherit;font-size:13px;color:var(--text);background:var(--surface);outline:none;transition:border-color .2s;width:100%;">
            <datalist id="songDatalist"></datalist>
          </div>
          <button class="btn btn-primary" onclick="analyzeSong()" style="flex-shrink:0;height:40px;">ğŸµ ã“ã®æ›²ã‚’åˆ†æ</button>
          <button class="btn btn-secondary" onclick="clearSongAnalysis()" style="flex-shrink:0;height:40px;">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        <div id="songQuickPicks" style="display:flex;gap:6px;flex-wrap:wrap;margin-top:10px;"></div>
        <div class="notice">ğŸ’¡ æ›²åã‚’å…¥åŠ›ã™ã‚‹ã¨ã™ã¹ã¦ã®å¹´ã‹ã‚‰ãã®æ›²ã®å‚¾å‘ã‚’åˆ†æã—ã¾ã™ã€‚æœ€çµ‚æ­Œå”±æ—¥ãƒ»å¹´åˆ¥æ¨ç§»ãƒ»å‡ºæ¼”ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ãŒç¢ºèªã§ãã¾ã™ã€‚</div>
      </div>
    </div>

    <!-- çµ±è¨ˆãƒãƒ¼ -->
    <div class="stats-row" id="statsRow" style="display:none;">
      <div class="stat-pill"><span class="stat-label">ç·æ¥½æ›²æ•°</span><span class="stat-val" id="stat-songs">-</span></div>
      <div class="stat-pill"><span class="stat-label">ç·æ­Œå”±å›æ•°</span><span class="stat-val" id="stat-total">-</span></div>
      <div class="stat-pill"><span class="stat-label">æœ€å¤šæ¥½æ›²</span><span class="stat-val" id="stat-top">-</span></div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚°ãƒ©ãƒ• -->
    <div class="chart-card" id="mainChartCard">
      <div class="chart-header">
        <div>
          <div class="chart-title" id="chartTitleText">åˆ†æçµæœ</div>
          <div class="chart-subtitle" id="chartSubtitle">åˆ†æè¨­å®šã‚’é¸æŠã—ã¦ã€Œåˆ†æã‚’é–‹å§‹ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
        </div>
        <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
          <span class="zoom-hint">ğŸ” ãƒ‰ãƒ©ãƒƒã‚°ã§ã‚ºãƒ¼ãƒ </span>
          <button class="zoom-reset-btn" onclick="resetMainZoom()">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
      </div>
      <div class="chart-wrap">
        <canvas id="mainChart"></canvas>
        <div class="empty-state" id="emptyState">
          <div class="empty-icon">ğŸµ</div>
          <div class="empty-text">åˆ†æã‚’å®Ÿè¡Œã™ã‚‹ã¨çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
        </div>
      </div>
    </div>

    <!-- æ¥½æ›²åˆ†æè©³ç´°ãƒ‘ãƒãƒ«ï¼ˆæ¥½æ›²é¸æŠãƒ¢ãƒ¼ãƒ‰æ™‚ã«è¡¨ç¤ºï¼‰ -->
    <div id="songAnalysisPanel" style="display:none;">
      <!-- æ¥½æ›²ã‚µãƒãƒªãƒ¼ -->
      <div id="songSummaryGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;margin-bottom:14px;"></div>

      <!-- å¹´åˆ¥æ¨ç§»ã‚°ãƒ©ãƒ• -->
      <div class="chart-card">
        <div class="chart-header">
          <div>
            <div class="chart-title" id="songTrendTitle">å¹´åˆ¥ æ­Œå”±å›æ•°æ¨ç§»</div>
            <div class="chart-subtitle" id="songTrendSub"></div>
          </div>
        </div>
        <div style="position:relative;height:240px;"><canvas id="songTrendChart"></canvas></div>
      </div>

      <!-- æœˆåˆ¥åˆ†å¸ƒã‚°ãƒ©ãƒ• -->
      <div class="chart-card">
        <div class="chart-header">
          <div>
            <div class="chart-title">æœˆåˆ¥ æ­Œå”±åˆ†å¸ƒï¼ˆå…¨å¹´åˆè¨ˆï¼‰</div>
            <div class="chart-subtitle" id="songMonthSub"></div>
          </div>
        </div>
        <div style="position:relative;height:220px;"><canvas id="songMonthChart"></canvas></div>
      </div>

      <!-- å‡ºæ¼”ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ -->
      <div class="card">
        <div class="card-title" id="songEventListTitle">ğŸ“‹ å‡ºæ¼”ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§</div>
        <div id="songEventList" style="display:flex;flex-direction:column;gap:5px;max-height:400px;overflow-y:auto;"></div>
      </div>
    </div>

    <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆã‚«ãƒ†ã‚´ãƒªãƒ¢ãƒ¼ãƒ‰ã®ã¿ï¼‰ -->
    <div id="rankingSection" style="display:none;">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
        <div class="card-title" style="margin-bottom:0;">ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°ä¸€è¦§</div>
        <span style="font-size:11px;color:var(--text-muted);">å„é …ç›®ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°</span>
      </div>
      <div class="ranking-grid" id="rankingGrid"></div>
    </div>

  </div>

  <!-- ===== TAB: å¹´åº¦æ¯”è¼ƒ ===== -->
  <div id="tab-compare" class="tab-content">
    <div class="card">
      <div class="card-title">ğŸ“ˆ Year Comparison</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;">
        <div style="display:flex;flex-direction:column;gap:4px;flex:1;min-width:200px;">
          <label style="font-size:11px;color:var(--text-muted);font-weight:700;">ã‚«ãƒ†ã‚´ãƒª</label>
          <div class="cat-group">
            <button class="cat-btn active" data-cat="song" onclick="setCompareCategory(this,'song')">ğŸµ å…¨æ›²</button>
            <button class="cat-btn" data-cat="first" onclick="setCompareCategory(this,'first')">ğŸ¤ 1æ›²ç›®</button>
            <button class="cat-btn" data-cat="last" onclick="setCompareCategory(this,'last')">ğŸ† ãƒˆãƒª</button>
            <button class="cat-btn" data-cat="spring" onclick="setCompareCategory(this,'spring')">ğŸŒ¸ æ˜¥</button>
            <button class="cat-btn" data-cat="summer" onclick="setCompareCategory(this,'summer')">â˜€ï¸ å¤</button>
            <button class="cat-btn" data-cat="autumn" onclick="setCompareCategory(this,'autumn')">ğŸ‚ ç§‹</button>
            <button class="cat-btn" data-cat="winter" onclick="setCompareCategory(this,'winter')">â„ï¸ å†¬</button>
            <button class="cat-btn" data-cat="combo" onclick="setCompareCategory(this,'combo')">ğŸ”— ã‚³ãƒ³ãƒœ</button>
            <button class="cat-btn" data-cat="fesFirst" onclick="setCompareCategory(this,'fesFirst')">ğŸª ãƒ•ã‚§ã‚¹1æ›²ç›®</button>
            <button class="cat-btn" data-cat="onemanFirst" onclick="setCompareCategory(this,'onemanFirst')">ğŸŸ ãƒ¯ãƒ³ãƒãƒ³1æ›²ç›®</button>
          </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:6px;">
          <label style="font-size:11px;color:var(--text-muted);font-weight:700;">æ¯”è¼ƒå¯¾è±¡å¹´</label>
          <div style="display:flex;gap:8px;flex-wrap:wrap;" id="yearCheckboxes">
            <label class="year-check-label"><input type="checkbox" class="year-cb" value="2023" checked onchange="runCompare()"> 2023</label>
            <label class="year-check-label"><input type="checkbox" class="year-cb" value="2024" checked onchange="runCompare()"> 2024</label>
            <label class="year-check-label"><input type="checkbox" class="year-cb" value="2025" checked onchange="runCompare()"> 2025</label>
            <label class="year-check-label"><input type="checkbox" class="year-cb" value="2026" checked onchange="runCompare()"> 2026</label>
          </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:4px;">
          <label style="font-size:11px;color:var(--text-muted);font-weight:700;">è¡¨ç¤ºä»¶æ•°</label>
          <select id="compareLimit" style="height:36px;padding:0 28px 0 10px;" onchange="runCompare()">
            <option value="10">Top 10</option><option value="15" selected>Top 15</option>
            <option value="20">Top 20</option><option value="30">Top 30</option>
          </select>
        </div>
        <div style="display:flex;flex-direction:column;gap:4px;">
          <label style="font-size:11px;color:var(--text-muted);font-weight:700;">æœŸé–“ï¼ˆé–‹å§‹ï¼‰</label>
          <input type="month" id="compareStart" style="height:36px;padding:0 10px;" onchange="runCompare()">
        </div>
        <div style="display:flex;flex-direction:column;gap:4px;">
          <label style="font-size:11px;color:var(--text-muted);font-weight:700;">æœŸé–“ï¼ˆçµ‚äº†ï¼‰</label>
          <input type="month" id="compareEnd" style="height:36px;padding:0 10px;" onchange="runCompare()">
        </div>
        <button class="btn btn-gold" onclick="runCompare()">ğŸ”„ åˆ†æå®Ÿè¡Œ</button>
        <button class="btn" style="background:var(--pink-light);color:var(--pink-dark);" onclick="resetCompare()">âœ• ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>

    <div id="compareSummary" style="display:none;margin-bottom:14px;">
      <div id="compareSummaryGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;"></div>
    </div>

    <div class="compare-grid">
      <div class="chart-half">
        <div class="chart-title" style="font-size:13px;margin-bottom:10px;">å¹´åº¦åˆ¥ å…¬æ¼”æ•°</div>
        <div class="chart-half-wrap"><canvas id="eventChart"></canvas></div>
      </div>
      <div class="chart-half">
        <div class="chart-title" style="font-size:13px;margin-bottom:10px;">æœˆåˆ¥ å…¬æ¼”æ•°æ¨ç§»</div>
        <div class="chart-half-wrap"><canvas id="monthlyChart"></canvas></div>
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-header">
        <div>
          <div class="chart-title" id="compareChartTitle">æ¥½æ›²åˆ¥ å¹´åº¦æ¯”è¼ƒ</div>
          <div class="chart-subtitle" id="compareChartSub">ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã‚“ã§åˆ†æå®Ÿè¡Œã—ã¦ãã ã•ã„</div>
        </div>
        <div style="display:flex;gap:5px;align-items:center;flex-wrap:wrap;">
          <span class="zoom-hint">ğŸ” ãƒ‰ãƒ©ãƒƒã‚°ã§ã‚ºãƒ¼ãƒ </span>
          <button class="zoom-reset-btn" onclick="resetTrendZoom()">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
      </div>
      <div style="position:relative;height:520px;"><canvas id="trendChart"></canvas></div>
    </div>

    <div class="chart-card" id="monthlyTrendCard" style="display:none;">
      <div class="chart-header">
        <div>
          <div class="chart-title">æœˆåˆ¥ æ­Œå”±å›æ•°æ¨ç§»</div>
          <div class="chart-subtitle">å„æœˆã®æ­Œå”±å›æ•°ï¼ˆå…¨æ¥½æ›²åˆè¨ˆï¼‰</div>
        </div>
        <div style="display:flex;gap:5px;">
          <span class="zoom-hint">ğŸ” ãƒ‰ãƒ©ãƒƒã‚°ã§ã‚ºãƒ¼ãƒ </span>
          <button class="zoom-reset-btn" onclick="resetMonthlyZoom()">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
      </div>
      <div style="position:relative;height:280px;"><canvas id="monthlyCountChart"></canvas></div>
    </div>
  </div>

  <!-- ===== TAB: å…¬æ¼”åˆ¥ ===== -->
  <div id="tab-event" class="tab-content">

    <!-- ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ -->
    <div class="card" style="margin-bottom:12px;">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:space-between;">
        <div style="display:flex;gap:6px;">
          <button class="mode-btn active" id="evModeBtnSetlist" onclick="setEventMode('setlist')">ğŸ“‹ ã‚»ãƒˆãƒªç¢ºèª</button>
          <button class="mode-btn" id="evModeBtnAnalyze" onclick="setEventMode('analyze')">ğŸ“Š å…¬æ¼”åˆ†æ</button>
          <button class="mode-btn" id="evModeBtnCompare" onclick="setEventMode('compare')">ğŸ†š ã‚°ãƒ«ãƒ¼ãƒ—æ¯”è¼ƒ</button>
        </div>
        <div style="font-size:11px;color:var(--text-muted);" id="evModeDesc">å…¬æ¼”ã‚’é¸ã‚“ã§ã‚»ãƒˆãƒªã‚’ç¢ºèªã—ã¾ã™</div>
      </div>
    </div>

    <!-- å·¦å³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
    <div style="display:grid;grid-template-columns:340px 1fr;gap:14px;" id="eventMainGrid">

      <!-- å·¦ï¼šå…¬æ¼”é¸æŠ -->
      <div class="card" style="margin-bottom:0;display:flex;flex-direction:column;max-height:700px;">
        <div class="card-title" style="flex-shrink:0;">ğŸ¤ å…¬æ¼”ã‚’é¸æŠ</div>

        <!-- å¹´ãƒ•ã‚£ãƒ«ã‚¿ -->
        <div style="display:flex;gap:5px;flex-wrap:wrap;margin-bottom:8px;flex-shrink:0;" id="evYearFilter">
          <label class="year-check-label"><input type="checkbox" class="ev-year-filter" value="2023" checked onchange="filterEventList()"> 2023</label>
          <label class="year-check-label"><input type="checkbox" class="ev-year-filter" value="2024" checked onchange="filterEventList()"> 2024</label>
          <label class="year-check-label"><input type="checkbox" class="ev-year-filter" value="2025" checked onchange="filterEventList()"> 2025</label>
          <label class="year-check-label"><input type="checkbox" class="ev-year-filter" value="2026" checked onchange="filterEventList()"> 2026</label>
        </div>

        <!-- æ¤œç´¢ -->
        <div class="event-search-box" style="flex-shrink:0;">
          <input class="event-search-input" id="eventSearch" placeholder="å…¬æ¼”åã§æ¤œç´¢..." oninput="filterEventList()">
          <span class="event-search-icon">ğŸ”</span>
        </div>

        <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
        <div style="display:flex;gap:5px;margin-bottom:8px;flex-shrink:0;">
          <button class="btn" style="flex:1;padding:5px;font-size:11px;background:var(--pink-light);color:var(--pink-dark);" onclick="selectAllVisible()">å…¨ã¦é¸æŠ</button>
          <button class="btn" style="flex:1;padding:5px;font-size:11px;background:#f3f4f6;color:#888;" onclick="clearAllSelection()">å…¨ã¦è§£é™¤</button>
        </div>

        <!-- é¸æŠä¸­ãƒãƒƒã‚¸ -->
        <div id="evSelCount" style="font-size:11px;color:var(--pink-dark);font-weight:700;margin-bottom:6px;flex-shrink:0;min-height:16px;"></div>

        <!-- ãƒªã‚¹ãƒˆï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰ -->
        <div id="eventList" style="flex:1;overflow-y:auto;"></div>
      </div>

      <!-- å³ï¼šãƒ¢ãƒ¼ãƒ‰åˆ¥ãƒ‘ãƒãƒ« -->
      <div id="evRightPanel">

        <!-- ã‚»ãƒˆãƒªç¢ºèªãƒ‘ãƒãƒ« -->
        <div id="evPanelSetlist">
          <div class="card" style="margin-bottom:12px;">
            <div class="card-title">ğŸ“‹ ã‚»ãƒˆãƒªç¢ºèª</div>
            <p style="font-size:12px;color:var(--text-muted);margin-bottom:10px;">å·¦ã‹ã‚‰å…¬æ¼”ã‚’é¸æŠã™ã‚‹ã¨ã€ãã®ã‚»ãƒˆãƒªãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
            <div id="setlistDisplay" style="display:none;">
              <div style="font-size:14px;font-weight:700;color:var(--pink-dark);margin-bottom:4px;" id="setlistTitle"></div>
              <div style="font-size:11px;color:var(--text-muted);margin-bottom:12px;" id="setlistMeta"></div>
              <div id="setlistSongs" style="display:flex;flex-direction:column;gap:4px;"></div>
            </div>
            <div id="setlistEmpty" style="color:var(--text-muted);font-size:12px;padding:20px 0;text-align:center;">
              <div style="font-size:32px;margin-bottom:8px;">ğŸµ</div>
              å…¬æ¼”ã‚’1ã¤é¸æŠã—ã¦ãã ã•ã„
            </div>
          </div>
        </div>

        <!-- å…¬æ¼”åˆ†æãƒ‘ãƒãƒ« -->
        <div id="evPanelAnalyze" style="display:none;">
          <div class="card" style="margin-bottom:12px;">
            <div class="card-title">âš™ï¸ åˆ†æè¨­å®š</div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;">
              <div class="field"><label>åˆ†æã‚«ãƒ†ã‚´ãƒª</label>
                <select id="evColumnSelect">
                  <option value="song">â˜… æ¥½æ›²åˆ¥ æ­Œå”±å›æ•°</option>
                  <option value="first">ã€1æ›²ç›®ã€‘å‡ºç¾å›æ•°</option>
                  <option value="last">ã€ãƒˆãƒªã€‘å‡ºç¾å›æ•°</option>
                  <option value="combo">é‰„æ¿ã‚³ãƒ³ãƒœ</option>
                </select>
              </div>
              <div class="field"><label>ã‚°ãƒ©ãƒ•ç¨®åˆ¥</label>
                <select id="evChartTypeSelect">
                  <option value="horizontalBar">æ¨ªæ£’ã‚°ãƒ©ãƒ•</option>
                  <option value="bar">ç¸¦æ£’ã‚°ãƒ©ãƒ•</option>
                  <option value="pie">å††ã‚°ãƒ©ãƒ•</option>
                  <option value="doughnut">ãƒ‰ãƒ¼ãƒŠãƒ„ã‚°ãƒ©ãƒ•</option>
                </select>
              </div>
              <div class="field"><label>è¡¨ç¤ºä»¶æ•°</label>
                <select id="evLimitSelect">
                  <option value="10">ä¸Šä½10ä»¶</option>
                  <option value="20" selected>ä¸Šä½20ä»¶</option>
                  <option value="30">ä¸Šä½30ä»¶</option>
                  <option value="999">å…¨ä»¶</option>
                </select>
              </div>
            </div>
            <div class="btn-row" style="margin-top:10px;">
              <button class="btn btn-primary" onclick="analyzeEvents()">ğŸ“Š åˆ†æå®Ÿè¡Œ</button>
            </div>
          </div>
          <div class="chart-card" id="evChartCard" style="display:none;">
            <div class="chart-header">
              <div>
                <div class="chart-title" id="evChartTitle">å…¬æ¼”åˆ¥åˆ†æçµæœ</div>
                <div class="chart-subtitle" id="evChartSub"></div>
              </div>
              <div style="display:flex;gap:5px;align-items:center;">
                <span class="zoom-hint">ğŸ” ãƒ‰ãƒ©ãƒƒã‚°ã§ã‚ºãƒ¼ãƒ </span>
                <button class="zoom-reset-btn" onclick="resetEvZoom()">ãƒªã‚»ãƒƒãƒˆ</button>
              </div>
            </div>
            <div style="position:relative;height:460px;"><canvas id="evChart"></canvas></div>
          </div>
        </div>

        <!-- ã‚°ãƒ«ãƒ¼ãƒ—æ¯”è¼ƒãƒ‘ãƒãƒ« -->
        <div id="evPanelCompare" style="display:none;">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;">
            <div class="card" style="margin-bottom:0;">
              <div class="card-title" style="color:var(--pink-dark);">ğŸ…° Group A</div>
              <div class="ev-slot-tags" id="evTagsA"><span style="font-size:11px;color:var(--text-muted);">å…¬æ¼”ã‚’é¸æŠã—ã¦ã€ŒAã«è¿½åŠ ã€</span></div>
              <button class="btn" style="width:100%;margin-top:8px;padding:6px;font-size:12px;background:rgba(244,114,182,0.15);color:var(--pink-dark);" onclick="addToSlot('A')">âœš Aã«è¿½åŠ </button>
            </div>
            <div class="card" style="margin-bottom:0;">
              <div class="card-title" style="color:#a07c00;">ğŸ…± Group B</div>
              <div class="ev-slot-tags" id="evTagsB"><span style="font-size:11px;color:var(--text-muted);">å…¬æ¼”ã‚’é¸æŠã—ã¦ã€ŒBã«è¿½åŠ ã€</span></div>
              <button class="btn" style="width:100%;margin-top:8px;padding:6px;font-size:12px;background:rgba(212,175,55,0.15);color:#a07c00;" onclick="addToSlot('B')">âœš Bã«è¿½åŠ </button>
            </div>
          </div>
          <div style="display:flex;gap:8px;margin-bottom:12px;align-items:center;flex-wrap:wrap;">
            <button class="btn btn-gold" onclick="compareSlots()">ğŸ†š ã‚°ãƒ«ãƒ¼ãƒ—æ¯”è¼ƒå®Ÿè¡Œ</button>
            <button class="btn btn-secondary" onclick="clearSlots()" style="padding:7px 14px;font-size:12px;">ã‚¯ãƒªã‚¢</button>
            <div class="field" style="margin-bottom:0;min-width:120px;">
              <select id="evCompareCat">
                <option value="song">å…¨æ¥½æ›²</option>
                <option value="first">1æ›²ç›®</option>
                <option value="last">ãƒˆãƒª</option>
              </select>
            </div>
          </div>
          <div class="chart-card" id="evCompareCard" style="display:none;">
            <div class="chart-header">
              <div>
                <div class="chart-title" id="evCompareTitle">ã‚°ãƒ«ãƒ¼ãƒ—æ¯”è¼ƒ</div>
                <div class="chart-subtitle" id="evCompareSub"></div>
              </div>
              <div style="display:flex;gap:5px;align-items:center;">
                <span class="zoom-hint">ğŸ” ãƒ‰ãƒ©ãƒƒã‚°ã§ã‚ºãƒ¼ãƒ </span>
                <button class="zoom-reset-btn" onclick="resetEvCompareZoom()">ãƒªã‚»ãƒƒãƒˆ</button>
              </div>
            </div>
            <div style="position:relative;height:500px;"><canvas id="evCompareChart"></canvas></div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- ===== TAB: éƒ½é“åºœçœŒ ===== -->
  <div id="tab-pref" class="tab-content">
    <div class="card">
      <div class="card-title">ğŸ—¾ Prefecture Analysis</div>
      <div class="controls-grid" style="grid-template-columns:repeat(auto-fit,minmax(155px,1fr));">
        <div class="field">
          <label>å¯¾è±¡å¹´</label>
          <select id="prefYearSelect" onchange="loadPrefData()">
            <option value="2026">2026å¹´</option>
            <option value="2025">2025å¹´</option>
            <option value="2024">2024å¹´</option>
            <option value="2023">2023å¹´</option>
          </select>
        </div>
      </div>
    </div>

    <div id="prefSummary" style="display:none;margin-bottom:14px;">
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(125px,1fr));gap:10px;">
        <div class="stat-badge" id="ps-visited"></div>
        <div class="stat-badge" id="ps-events"></div>
        <div class="stat-badge" id="ps-top"></div>
        <div class="stat-badge" id="ps-abroad"></div>
      </div>
    </div>

    <div class="chart-card" style="min-height:auto;">
      <div class="chart-title" style="margin-bottom:12px;">éƒ½é“åºœçœŒåˆ¥ è¨ªå•å›æ•°</div>
      <div id="prefGrid" class="pref-grid"></div>
    </div>

    <div class="chart-card">
      <div class="chart-header">
        <div>
          <div class="chart-title" id="prefChartTitle">éƒ½é“åºœçœŒåˆ¥ TOPæ›²</div>
          <div class="chart-subtitle" id="prefChartSub">éƒ½é“åºœçœŒã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è©³ç´°ã‚’è¡¨ç¤º</div>
        </div>
        <div style="display:flex;gap:5px;">
          <span class="zoom-hint">ğŸ” ãƒ‰ãƒ©ãƒƒã‚°ã§ã‚ºãƒ¼ãƒ </span>
          <button class="zoom-reset-btn" onclick="resetPrefZoom()">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
      </div>
      <div style="position:relative;height:360px;">
        <canvas id="prefChart"></canvas>
        <div class="empty-state" id="prefEmptyState">
          <div class="empty-icon">ğŸ—¾</div>
          <div class="empty-text">éƒ½é“åºœçœŒã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</div>
        </div>
      </div>
    </div>
  </div>


</main>

<!-- MOBILE NAV -->
<div class="mobile-nav" id="mobileNav">
  <button class="mobile-nav-btn active" id="mnav-analyze" onclick="switchTab('analyze')"><span class="mobile-nav-icon">ğŸµ</span>æ¥½æ›²åˆ†æ</button>
  <button class="mobile-nav-btn" id="mnav-compare" onclick="switchTab('compare')"><span class="mobile-nav-icon">ğŸ“ˆ</span>å¹´åº¦æ¯”è¼ƒ</button>
  <button class="mobile-nav-btn" id="mnav-event" onclick="switchTab('event')"><span class="mobile-nav-icon">ğŸ¤</span>å…¬æ¼”åˆ¥</button>
  <button class="mobile-nav-btn" id="mnav-pref" onclick="switchTab('pref')"><span class="mobile-nav-icon">ğŸ—¾</span>éƒ½é“åºœçœŒ</button>
</div>

<!-- LOADING -->
<div class="loading-overlay" id="loading">
  <div class="spinner"></div>
  <div class="loading-text">NOW ANALYZING...</div>
</div>

<!-- DRILL MODAL -->
<div id="drillModal" class="drill-modal">
  <div class="drill-inner">
    <div class="drill-head">
      <div>
        <div id="drillSongName" style="font-size:18px;font-weight:700;color:#fff;"></div>
        <div id="drillSongSub" style="font-size:11px;color:rgba(255,255,255,0.75);margin-top:3px;"></div>
      </div>
      <button class="drill-close" onclick="closeDrill()">âœ•</button>
    </div>
    <div class="drill-body">
      <div id="drillYearGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:10px;margin-bottom:18px;"></div>
      <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:9px;">ğŸ“… æœˆåˆ¥ æ­Œå”±æ¨ç§»ï¼ˆå…¨å¹´é‡ã­åˆã‚ã›ï¼‰</div>
      <div style="position:relative;height:200px;margin-bottom:16px;"><canvas id="drillMonthChart"></canvas></div>
      <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:8px;">ğŸ“‹ å‡ºæ¼”ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæœ€å¤§20ä»¶ï¼‰</div>
      <div id="drillEventList" style="display:flex;flex-direction:column;gap:5px;max-height:240px;overflow-y:auto;"></div>
    </div>
  </div>
</div>

<script>
// ============================================================
// è¨­å®š
// ============================================================
const SHEET_ID = '10QKtPdhdtaLFxxkRhdzTRVePeh3DUmib0WpEJA49Erw';
const SHEET_NAMES = {
  '2023':'æ¥½æ›²åˆ†è§£ã‚·ãƒ¼ãƒˆï¼ˆ2023ï¼‰',
  '2024':'æ¥½æ›²åˆ†è§£ã‚·ãƒ¼ãƒˆï¼ˆ2024ï¼‰',
  '2025':'æ¥½æ›²åˆ†è§£ã‚·ãƒ¼ãƒˆï¼ˆ2025ï¼‰',
  '2026':'æ¥½æ›²åˆ†è§£ã‚·ãƒ¼ãƒˆï¼ˆ2026ï¼‰',
};
const ALL_YEARS = ['2023','2024','2025','2026'];
const COLORS = [
  '#f472b6','#d4af37','#818cf8','#34d399','#fb923c',
  '#60a5fa','#e879f9','#4ade80','#f87171','#38bdf8',
  '#fbbf24','#a78bfa','#fb7185','#2dd4bf','#c084fc',
  '#f9a8d4','#86efac','#93c5fd','#fcd34d','#6ee7b7'
];

// æ¥½æ›²åˆ†è§£ã‚·ãƒ¼ãƒˆ v4 åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆ0å§‹ã¾ã‚Šï¼‰
// Aã€œK: è©³ç´°ãƒ‡ãƒ¼ã‚¿è¡Œ
const C = {
  date:0, month:1, title:2, rawSong:3, song:4, count:5, ratio:6,
  venue:7, pref:8, isFirst:9, isLast:10,
  // Lã€œ é›†è¨ˆãƒ–ãƒ­ãƒƒã‚¯ï¼ˆå„ãƒ–ãƒ­ãƒƒã‚¯2åˆ—ï¼‰
  b1n:11,b1c:12, // 1æ›²ç›®
  b2n:13,b2c:14, // ãƒˆãƒª
  b3n:15,b3c:16, // æ˜¥
  b4n:17,b4c:18, // å¤
  b5n:19,b5c:20, // ç§‹
  b6n:21,b6c:22, // å†¬
  b7n:23,b7c:24, // å°‘æ›²æ•°1æ›²ç›®
  b8n:25,b8c:26, // å¤šæ›²æ•°1æ›²ç›®
  b9n:27,b9c:28, // ã‚³ãƒ³ãƒœ
  prefRankN:29,prefRankC:30, // éƒ½é“åºœçœŒè¨ªå•ãƒ©ãƒ³ã‚­ãƒ³ã‚°
  prefTopStart:31, // éƒ½é“åºœçœŒåˆ¥TOPæ›²ï¼ˆå¯å¤‰åˆ—ï¼‰
};

const CAT_COL = {
  song:{n:C.song,c:C.count},       first:{n:C.b1n,c:C.b1c},
  last:{n:C.b2n,c:C.b2c},          spring:{n:C.b3n,c:C.b3c},
  summer:{n:C.b4n,c:C.b4c},        autumn:{n:C.b5n,c:C.b5c},
  winter:{n:C.b6n,c:C.b6c},        shortFirst:{n:C.b7n,c:C.b7c},
  longFirst:{n:C.b8n,c:C.b8c},     combo:{n:C.b9n,c:C.b9c},
};

const CAT_LABEL = {
  song:'å…¨æ¥½æ›²',first:'1æ›²ç›®',last:'ãƒˆãƒª',spring:'æ˜¥(3-5æœˆ)',summer:'å¤(6-8æœˆ)',
  autumn:'ç§‹(9-11æœˆ)',winter:'å†¬(12-2æœˆ)',shortFirst:'å°‘æ›²æ•°1æ›²ç›®',longFirst:'å¤šæ›²æ•°1æ›²ç›®',
  combo:'é‰„æ¿ã‚³ãƒ³ãƒœ',fesFirst:'ãƒ•ã‚§ã‚¹1æ›²ç›®',fesSong:'ãƒ•ã‚§ã‚¹TOPæ›²',
  onemanFirst:'ãƒ¯ãƒ³ãƒãƒ³1æ›²ç›®',onemanSong:'ãƒ¯ãƒ³ãƒãƒ³TOPæ›²',multiFirst:'äºŒéƒ¨åˆ¶1æ›²ç›®',
};

// ============================================================
// ãƒ‡ãƒ¼ã‚¿å–å¾—
// ============================================================
const sheetCache = {};
async function fetchSheet(year) {
  if (sheetCache[year]) return sheetCache[year];
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAMES[year])}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error('å–å¾—å¤±æ•—: '+year);
  const rows = parseCSV(await res.text());
  sheetCache[year] = rows;
  return rows;
}

function parseCSV(text) {
  return text.split('\n').map(line => {
    const r=[]; let q=false,cur='';
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch==='"'){if(q&&line[i+1]==='"'){cur+='"';i++;}else q=!q;}
      else if(ch===','&&!q){r.push(cur.trim());cur='';}
      else cur+=ch;
    }
    r.push(cur.trim()); return r;
  }).filter(r=>r.length>1&&r[0]);
}

function parseDate(v) {
  if (!v) return null;
  const s = String(v).trim();
  if (/^\d{5}/.test(s)) {
    const n=parseFloat(s); if(isNaN(n)) return null;
    const d=new Date(Math.round((n-25569)*86400*1000));
    return isNaN(d.getTime())?null:d;
  }
  const d=new Date(s.replace(/\//g,'-'));
  return isNaN(d.getTime())?null:d;
}

function isDataRow(row) {
  const v = String(row[C.date]||'').trim();
  return /^\d{5}/.test(v) || /^\d{4}[\/\-]/.test(v);
}

// éƒ½é“åºœçœŒãƒ–ãƒ­ãƒƒã‚¯å¾Œã®åˆ—ã‚’å‹•çš„æ¤œå‡º
function detectNewCols(rows) {
  const h = rows[0]||[];
  let prefCols=0, col=C.prefTopStart;
  while(col<h.length && h[col] && String(h[col]).indexOf('TOPæ›²')!==-1){prefCols++;col+=2;}
  const m12 = C.prefTopStart + prefCols*2; // æœˆåˆ¥ãƒ–ãƒ­ãƒƒã‚¯
  const b13  = m12 + 14;                   // ãƒ•ã‚§ã‚¹ç­‰ãƒ–ãƒ­ãƒƒã‚¯
  return {
    prefTopStart:C.prefTopStart, prefTopCols:prefCols,
    fesFirstN:b13,fesFirstC:b13+1,
    fesSongN:b13+2,fesSongC:b13+3,
    onemanFirstN:b13+4,onemanFirstC:b13+5,
    onemanSongN:b13+6,onemanSongC:b13+7,
    multiFirstN:b13+8,multiFirstC:b13+9,
  };
}

// ============================================================
// é›†è¨ˆ
// ============================================================
function aggRaw(rows, startDate, endDate) {
  const m={};
  rows.slice(2).forEach(row=>{
    if(!isDataRow(row)) return;
    if(startDate||endDate){const d=parseDate(row[C.date]);if(!d)return;if(startDate&&d<startDate)return;if(endDate&&d>endDate)return;}
    const n=row[C.rawSong]; if(!n||!n.trim()) return;
    m[n]=(m[n]||0)+1;
  });
  return Object.entries(m).sort((a,b)=>b[1]-a[1]);
}

function aggRanking(rows, nameCol, cntCol) {
  const m={};
  rows.slice(2).forEach(row=>{
    const n=row[nameCol],c=parseFloat(row[cntCol]);
    if(!n||!n.trim()||n==='æ›²å'||n==='ãƒšã‚¢'||n==='éƒ½é“åºœçœŒ'||n==='è¨ªå•éƒ½é“åºœçœŒãƒ©ãƒ³ã‚­ãƒ³ã‚°'||n==='è¨ªå•éƒ½é“åºœçœŒæ•°') return;
    if(isNaN(c)||c<=0) return;
    if(!m[n]) m[n]=c;
  });
  return Object.entries(m).sort((a,b)=>b[1]-a[1]);
}

function aggData(rows, cat, startDate, endDate) {
  if(cat==='song') return aggRaw(rows,startDate,endDate);
  const nc=detectNewCols(rows);
  const extra={
    fesFirst:{n:nc.fesFirstN,c:nc.fesFirstC},
    fesSong:{n:nc.fesSongN,c:nc.fesSongC},
    onemanFirst:{n:nc.onemanFirstN,c:nc.onemanFirstC},
    onemanSong:{n:nc.onemanSongN,c:nc.onemanSongC},
    multiFirst:{n:nc.multiFirstN,c:nc.multiFirstC},
  };
  const cfg=CAT_COL[cat]||extra[cat]; if(!cfg) return [];
  return aggRanking(rows,cfg.n,cfg.c);
}

function getSongDetails(rows, songName) {
  const monthly={}; for(let m=1;m<=12;m++) monthly[m]=0;
  const events=[]; const seen=new Set();
  rows.slice(2).forEach(row=>{
    if(!isDataRow(row)) return;
    if(row[C.rawSong]!==songName) return;
    const d=parseDate(row[C.date]); if(!d) return;
    monthly[d.getMonth()+1]++;
    const key=row[C.date]+'_'+(row[C.title]||'');
    if(!seen.has(key)){seen.add(key);events.push({date:d,title:row[C.title]||'ä¸æ˜',venue:row[C.venue]||'',pref:row[C.pref]||''});}
  });
  events.sort((a,b)=>b.date-a.date);
  return {monthly,events:events.slice(0,20)};
}

// ============================================================
// ãƒãƒ£ãƒ¼ãƒˆãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// ============================================================
Chart.register(ChartDataLabels);

function resetCanvas(id) {
  const el=document.getElementById(id); if(!el) return null;
  const p=el.parentNode;
  const nc=document.createElement('canvas'); nc.id=id; nc.style.cssText=el.style.cssText||'';
  p.replaceChild(nc,el);
  return document.getElementById(id).getContext('2d');
}

function destroyChart(inst) { if(inst){try{inst.destroy();}catch(e){}} return null; }

const ZoomPlugin = { zoom:{drag:{enabled:true,backgroundColor:'rgba(244,114,182,0.12)',borderColor:'rgba(244,114,182,0.4)',borderWidth:1},mode:'x'},pan:{enabled:false} };
const ZoomPluginY = { zoom:{drag:{enabled:true,backgroundColor:'rgba(244,114,182,0.12)',borderColor:'rgba(244,114,182,0.4)',borderWidth:1},mode:'y'},pan:{enabled:false} };

function datalabelCfg(type) {
  if(type==='pie'||type==='doughnut') return {color:'#fff',font:{family:'DM Mono',size:11,weight:'bold'},formatter:v=>v>0?v+'å›':''};
  if(type==='horizontalBar') return {anchor:'end',align:'end',color:'#3d2b35',font:{family:'DM Mono',size:10,weight:'bold'},formatter:v=>v>0?v+'å›':'',padding:{left:3}};
  return {anchor:'end',align:'end',color:'#3d2b35',font:{family:'DM Mono',size:10,weight:'bold'},formatter:v=>v>0?v+'å›':'',padding:{bottom:3}};
}

function buildChart(type, labels, data, label, onClickFn) {
  const colors=labels.map((_,i)=>COLORS[i%COLORS.length]);
  const isH=type==='horizontalBar';
  if(type==='pie'||type==='doughnut') {
    return {type,data:{labels,datasets:[{data,backgroundColor:colors,borderWidth:2,borderColor:'#fff'}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true,position:'right',labels:{font:{family:'Zen Maru Gothic',size:11},padding:10,boxWidth:10}},tooltip:{callbacks:{label:ctx=>` ${ctx.label}: ${ctx.parsed}å›`}},datalabels:datalabelCfg(type)}}};
  }
  return {
    type:'bar',
    data:{labels,datasets:[{label,data,backgroundColor:colors,borderRadius:isH?5:7,borderSkipped:false}]},
    options:{
      responsive:true,maintainAspectRatio:false,
      ...(isH?{indexAxis:'y'}:{}),
      onClick:onClickFn||undefined,
      plugins:{
        legend:{display:false},
        tooltip:{callbacks:{label:ctx=>` ${isH?ctx.parsed.x:ctx.parsed.y}å›`}},
        datalabels:datalabelCfg(type),
        zoom:isH?ZoomPluginY:ZoomPlugin,
      },
      scales:{
        x:{grid:{display:!isH,color:'rgba(0,0,0,0.04)'},ticks:{font:{family:isH?'DM Mono':'Zen Maru Gothic',size:10},maxRotation:isH?0:35}},
        y:{grid:{display:isH,color:'rgba(0,0,0,0.04)'},ticks:{font:{family:isH?'Zen Maru Gothic':'DM Mono',size:isH?11:10}},beginAtZero:true}
      }
    }
  };
}

// ============================================================
// åˆ†æå®Ÿè¡Œ
// ============================================================
let mainChartInst=null;

async function analyze() {
  const years=[...document.querySelectorAll('.an-year-cb:checked')].map(cb=>cb.value);
  if(!years.length){alert('å¯¾è±¡å¹´ã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„');return;}
  const cat=document.getElementById('columnSelect').value;
  const chartType=document.getElementById('chartTypeSelect').value;
  const limit=parseInt(document.getElementById('limitSelect').value);
  const sd=document.getElementById('startDate').value?new Date(document.getElementById('startDate').value):null;
  const ed=document.getElementById('endDate').value?new Date(document.getElementById('endDate').value+'T23:59:59'):null;

  showLoading(true);
  try {
    // å…¨é¸æŠå¹´ã®ãƒ‡ãƒ¼ã‚¿å–å¾—
    const rowsMap={};
    for(const yr of years){ rowsMap[yr]=await fetchSheet(yr); }

    let results;
    if(years.length===1){
      results=aggData(rowsMap[years[0]],cat,sd,ed);
    } else {
      const merged={};
      for(const yr of years){
        aggData(rowsMap[yr],cat,sd,ed).forEach(([name,cnt])=>{ merged[name]=(merged[name]||0)+cnt; });
      }
      results=Object.entries(merged).sort((a,b)=>b[1]-a[1]);
    }

    if(!results.length){alert('è©²å½“ãƒ‡ãƒ¼ã‚¿ãªã—ã€‚æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚');return;}

    const limited=results.slice(0,limit===999?results.length:limit);
    const total=results.reduce((s,r)=>s+r[1],0);

    document.getElementById('stat-songs').textContent=results.length+'æ›²';
    document.getElementById('stat-total').textContent=total+'å›';
    document.getElementById('stat-top').textContent=results[0][0];
    document.getElementById('statsRow').style.display='flex';

    const labels=limited.map(r=>r[0]);
    const data=limited.map(r=>r[1]);
    const colLabel=document.getElementById('columnSelect').selectedOptions[0].text;
    const yearLabel=years.length===1?years[0]+'å¹´':years.join('ãƒ»')+'å¹´';

    document.getElementById('emptyState').style.display='none';
    document.getElementById('chartTitleText').textContent=`${yearLabel} ${colLabel}`;
    document.getElementById('chartSubtitle').textContent=`ä¸Šä½${limited.length}ä»¶ / å…¨${results.length}æ›² â€” ãƒãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°`;

    mainChartInst=destroyChart(mainChartInst);
    const ctx=resetCanvas('mainChart');

    const onClickFn=(cat!=='combo')?(evt,els)=>{
      if(els.length>0){
        const r=limited[els[0].index];
        const sd_={total:r[1]}; years.forEach(yr=>sd_['v'+yr]=0);
        openDrillMulti(r[0],rowsMap,sd_,years);
      }
    }:null;

    mainChartInst=new Chart(ctx,buildChart(chartType,labels,data,colLabel,onClickFn));
    if(cat!=='combo') document.getElementById('mainChart').style.cursor='pointer';

    if(currentAnalyzeMode==='category'){
      document.getElementById('rankingSection').style.display='block';
      renderRanking(results,limit,rowsMap,years);
    }
  } catch(e){alert('ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—: '+e.message);console.error(e);}
  finally{showLoading(false);}
}

function resetMainZoom(){if(mainChartInst) mainChartInst.resetZoom();}

// ============================================================
// ãƒ©ãƒ³ã‚­ãƒ³ã‚°
// ============================================================
function renderRanking(results,limit,rowsMap,years) {
  const grid=document.getElementById('rankingGrid'); grid.innerHTML='';
  const max=results[0]?.[1]||1;
  const count=limit===999?results.length:limit;
  results.slice(0,count).forEach(([name,cnt],i)=>{
    const rank=i+1; const rc=rank===1?'top1':rank===2?'top2':rank===3?'top3':'';
    const pct=Math.round((cnt/max)*100);
    const el=document.createElement('div'); el.className='ranking-item';
    el.onclick=()=>{
      const sd={total:cnt}; years.forEach(yr=>sd['v'+yr]=0);
      openDrillMulti(name,rowsMap,sd,years);
    };
    el.innerHTML=`<span class="rank-num ${rc}">${rank}</span>
      <div style="flex:1;overflow:hidden;">
        <div class="rank-name">${name}</div>
        <div class="rank-bar-wrap"><div class="rank-bar" style="width:${pct}%"></div></div>
      </div><span class="rank-count">${cnt}å›</span>`;
    grid.appendChild(el);
  });
}

// ============================================================
// ãƒ‰ãƒªãƒ«ãƒ€ã‚¦ãƒ³ï¼ˆå˜ä½“å¹´ãƒ»è¤‡æ•°å¹´å¯¾å¿œï¼‰
// ============================================================
let drillInst=null;

// å˜ä½“åˆ†æã‚¿ãƒ–ã‹ã‚‰ã®ãƒ‰ãƒªãƒ«ãƒ€ã‚¦ãƒ³ï¼ˆã‚¯ãƒªãƒƒã‚¯ã—ãŸå¹´ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿è¡¨ç¤ºï¼‰
function openDrill(songName,rows,songData,year) {
  // å˜ä½“å¹´ã®å ´åˆã¯å…¨å¹´ãƒ‡ãƒ¼ã‚¿ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰è£œå®Œ
  const allYears=Object.keys(sheetCache).sort();
  const rowsMap={};
  allYears.forEach(yr=>{ if(sheetCache[yr]) rowsMap[yr]=sheetCache[yr]; });
  // ç¾åœ¨ã® year ã¯å¿…ãšå«ã‚ã‚‹
  rowsMap[year]=rows;

  // å„å¹´ã®åˆè¨ˆã‚’é›†è¨ˆ
  const yearTotals={};
  Object.keys(rowsMap).forEach(yr=>{
    let cnt=0;
    rowsMap[yr].slice(2).forEach(r=>{
      if(!isDataRow(r)) return;
      if(r[C.rawSong]===songName) cnt++;
    });
    yearTotals[yr]=cnt;
  });

  // songData ã«æ­£ã—ã„å¹´åˆ¥å€¤ã‚’è£œå®Œ
  const enriched={...songData};
  Object.keys(yearTotals).forEach(yr=>{ enriched['v'+yr]=yearTotals[yr]; });
  enriched.total=Object.values(yearTotals).reduce((a,b)=>a+b,0);

  _openDrillModal(songName, rowsMap, enriched, Object.keys(rowsMap).sort(), year);
}

// å¹´åº¦æ¯”è¼ƒã‚¿ãƒ–ã‹ã‚‰ã®ãƒ‰ãƒªãƒ«ãƒ€ã‚¦ãƒ³ï¼ˆè¤‡æ•°å¹´å¯¾å¿œï¼‰
function openDrillMulti(songName,rowsMap,songData,years) {
  _openDrillModal(songName, rowsMap, songData, years, null);
}

function _openDrillModal(songName, rowsMap, songData, years, focusYear) {
  document.getElementById('drillSongName').textContent=songName;
  const total=songData.total||years.reduce((s,yr)=>s+(songData['v'+yr]||0),0);
  const yearStr=focusYear?focusYear+'å¹´':years.join('ãƒ»')+'å¹´';
  document.getElementById('drillSongSub').textContent=`${yearStr} åˆè¨ˆ: ${total}å›`;

  // å¹´åˆ¥ã‚µãƒãƒªãƒ¼ãƒãƒƒã‚¸ï¼ˆå‹•çš„ç”Ÿæˆï¼‰
  const yrGrid=document.getElementById('drillYearGrid');
  yrGrid.innerHTML='';
  const sortedYears=[...years].sort();
  sortedYears.forEach((yr,i)=>{
    const cnt=songData['v'+yr]||0;
    const yc=YEAR_COLORS[yr]||{border:'#888'};
    const div=document.createElement('div'); div.className='stat-badge';
    let html=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:3px;">${yr}å¹´</div>
      <div style="font-size:24px;font-weight:700;color:${yc.border};">${cnt}å›</div>`;
    if(i>0){
      const prevYr=sortedYears[i-1];
      const prev=songData['v'+prevYr]||0;
      const delta=cnt-prev;
      const growth=prev>0?((delta/prev)*100).toFixed(1):'â€”';
      html+=`<div style="font-size:10px;color:${delta>=0?'#34d399':'#f87171'};font-weight:700;margin-top:2px;">${delta>=0?'â–²':'â–¼'}${Math.abs(delta)} (${delta>=0?'+':''}${growth}%)</div>`;
    }
    div.innerHTML=html;
    yrGrid.appendChild(div);
  });

  // æœˆåˆ¥ã‚°ãƒ©ãƒ•ï¼ˆå…¨æ¯”è¼ƒå¹´ or å˜ä½“å¹´ï¼‰
  drillInst=destroyChart(drillInst);
  const mths=['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
  const dctx=resetCanvas('drillMonthChart');

  const datasets=sortedYears.map(yr=>{
    const det=getSongDetails(rowsMap[yr]||[],songName);
    const yc=YEAR_COLORS[yr]||{border:'#f472b6',bg:'rgba(244,114,182,0.8)'};
    return {
      label:yr+'å¹´',data:mths.map((_,i)=>det.monthly[i+1]),
      backgroundColor:yc.bg,borderColor:yc.border,borderRadius:5
    };
  });

  drillInst=new Chart(dctx,{
    type:'bar',
    data:{labels:mths,datasets},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{position:'bottom',display:sortedYears.length>1,labels:{font:{family:'Zen Maru Gothic',size:10},padding:8,boxWidth:10}},tooltip:{callbacks:{label:ctx=>` ${ctx.dataset.label}: ${ctx.parsed.y}å›`}},datalabels:{anchor:'end',align:'end',color:'#3d2b35',font:{family:'DM Mono',size:9,weight:'bold'},formatter:v=>v>0?v+'å›':''}},
      scales:{x:{grid:{display:false},ticks:{font:{family:'Zen Maru Gothic',size:10}}},y:{grid:{color:'rgba(0,0,0,0.04)'},ticks:{font:{family:'DM Mono',size:10}},beginAtZero:true}}}
  });

  // ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ï¼ˆå…¨å¹´ã¾ã¨ã‚ã¦ã€æœ€æ–°20ä»¶ï¼‰
  const allEvents=[];
  sortedYears.forEach(yr=>{
    const det=getSongDetails(rowsMap[yr]||[],songName);
    det.events.forEach(e=>allEvents.push({...e,year:yr}));
  });
  allEvents.sort((a,b)=>b.date-a.date);
  const top20=allEvents.slice(0,20);

  const evHtml=top20.map(e=>{
    const ds=`${e.date.getFullYear()}/${String(e.date.getMonth()+1).padStart(2,'0')}/${String(e.date.getDate()).padStart(2,'0')}`;
    const yc=YEAR_COLORS[e.year]||{border:'#888'};
    return `<div style="display:flex;gap:7px;align-items:flex-start;padding:6px 10px;background:var(--bg);border-radius:9px;">
      <span style="font-size:9px;font-weight:700;color:#fff;background:${yc.border};padding:2px 6px;border-radius:20px;flex-shrink:0;margin-top:2px;">${e.year}</span>
      <div style="flex:1;overflow:hidden;">
        <div style="font-size:12px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${e.title}</div>
        <div style="font-size:10px;color:var(--text-muted);">${ds}${e.venue?' Â· '+e.venue:''}${e.pref?' ğŸ“'+e.pref:''}</div>
      </div></div>`;
  }).join('');
  document.getElementById('drillEventList').innerHTML=evHtml||'<div style="color:var(--text-muted);font-size:13px;">ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ãªã—</div>';

  document.getElementById('drillModal').style.display='block';
  document.body.style.overflow='hidden';
}

function closeDrill(){document.getElementById('drillModal').style.display='none';document.body.style.overflow='';drillInst=destroyChart(drillInst);}



// ============================================================
// å¹´åº¦æ¯”è¼ƒï¼ˆå…¨å¹´ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹å¯¾å¿œï¼‰
// ============================================================
let evChartInst=null,moChartInst=null,trChartInst=null,mcChartInst=null;
let compareCategory='song';

const YEAR_COLORS = {
  '2023':{ border:'#a78bfa', bg:'rgba(167,139,250,0.85)', bgFill:'rgba(167,139,250,0.1)' },
  '2024':{ border:'#d4af37', bg:'rgba(212,175,55,0.85)',   bgFill:'rgba(212,175,55,0.1)'  },
  '2025':{ border:'#f472b6', bg:'rgba(244,114,182,0.85)', bgFill:'rgba(244,114,182,0.1)' },
  '2026':{ border:'#34d399', bg:'rgba(52,211,153,0.85)',  bgFill:'rgba(52,211,153,0.1)'  },
};

function getCheckedYears(){
  return [...document.querySelectorAll('.year-cb:checked')].map(cb=>cb.value);
}

function setCompareCategory(btn,cat){
  document.querySelectorAll('.cat-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active'); compareCategory=cat; runCompare();
}

function resetCompare(){
  document.getElementById('compareStart').value='';
  document.getElementById('compareEnd').value='';
  document.getElementById('compareLimit').value='15';
  compareCategory='song';
  document.querySelectorAll('.cat-btn').forEach(b=>b.classList.remove('active'));
  document.querySelector('.cat-btn[data-cat="song"]').classList.add('active');
  document.querySelectorAll('.year-cb').forEach(cb=>{ cb.checked=true; });
  Object.keys(sheetCache).forEach(k=>delete sheetCache[k]);
  runCompare();
}

function buildMap(rows,cat,sd,ed){
  if(cat==='song'){
    const m={};
    rows.slice(2).forEach(row=>{
      if(!isDataRow(row)) return;
      if(sd||ed){const d=parseDate(row[C.date]);if(!d)return;if(sd&&d<sd)return;if(ed&&d>ed)return;}
      const n=row[C.rawSong]; if(!n||!n.trim()) return; m[n]=(m[n]||0)+1;
    });
    return m;
  }
  const nc=detectNewCols(rows);
  const extra={
    fesFirst:{n:nc.fesFirstN,c:nc.fesFirstC},fesSong:{n:nc.fesSongN,c:nc.fesSongC},
    onemanFirst:{n:nc.onemanFirstN,c:nc.onemanFirstC},onemanSong:{n:nc.onemanSongN,c:nc.onemanSongC},
    multiFirst:{n:nc.multiFirstN,c:nc.multiFirstC}
  };
  const cfg=CAT_COL[cat]||extra[cat]; if(!cfg) return {};
  const m={};
  rows.slice(2).forEach(row=>{
    const n=row[cfg.n],c=parseFloat(row[cfg.c]);
    if(!n||!n.trim()||n==='æ›²å'||n==='ãƒšã‚¢') return;
    if(isNaN(c)||c<=0) return;
    if(!m[n]) m[n]=c;
  });
  return m;
}

async function runCompare(){
  const years=getCheckedYears();
  if(years.length===0){alert('æ¯”è¼ƒå¯¾è±¡å¹´ã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„ã€‚');return;}
  showLoading(true);
  try {
    const sv=document.getElementById('compareStart').value;
    const ev_=document.getElementById('compareEnd').value;
    const sd=sv?new Date(sv+'-01'):null;
    const ed=ev_?new Date(ev_+'-01T23:59:59'):null;
    if(ed) ed.setMonth(ed.getMonth()+1);
    const limit=parseInt(document.getElementById('compareLimit').value)||15;
    const cat=compareCategory;
    const mths=['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];

    // å…¨é¸æŠå¹´ã®ãƒ‡ãƒ¼ã‚¿å–å¾—
    const rowsMap={};
    for(const yr of years){ rowsMap[yr]=await fetchSheet(yr); }

    // å…¬æ¼”æ•° + æœˆåˆ¥å…¬æ¼”æ•°
    const evCnt={};
    const moEv={}; for(let m=1;m<=12;m++){moEv[m]={}; years.forEach(yr=>moEv[m][yr]=0);}
    for(const yr of years){
      const rows=rowsMap[yr]; const seen=new Set();
      rows.slice(2).forEach(row=>{
        if(!isDataRow(row)) return;
        const d=parseDate(row[C.date]); if(!d) return;
        if(sd&&d<sd) return; if(ed&&d>ed) return;
        const key=row[C.date]+'_'+(row[C.title]||'');
        if(!seen.has(key)){seen.add(key);moEv[d.getMonth()+1][yr]++;}
      });
      evCnt[yr]=seen.size;
    }

    // ã‚«ãƒ†ã‚´ãƒªé›†è¨ˆ
    const maps={};
    for(const yr of years){ maps[yr]=buildMap(rowsMap[yr],cat,sd,ed); }

    const allNames=[...new Set(years.flatMap(yr=>Object.keys(maps[yr])))];
    const combined=allNames.map(name=>{
      const obj={name}; let total=0;
      years.forEach(yr=>{ const v=maps[yr][name]||0; obj['v'+yr]=v; total+=v; });
      obj.total=total; return obj;
    }).sort((a,b)=>b.total-a.total).slice(0,limit);

    const catL=CAT_LABEL[cat]||cat;
    document.getElementById('compareChartTitle').textContent=`${catL} å¹´åº¦æ¯”è¼ƒ (Top${limit})`;
    document.getElementById('compareChartSub').textContent=`${years.join('ãƒ»')}å¹´ / ãƒãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´° / ãƒ‰ãƒ©ãƒƒã‚°ã§ã‚ºãƒ¼ãƒ `;

    // ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ï¼ˆå¹´ã”ã¨å‹•çš„ç”Ÿæˆï¼‰
    document.getElementById('compareSummary').style.display='block';
    const sgrid=document.getElementById('compareSummaryGrid');
    sgrid.innerHTML='';
    years.forEach(yr=>{
      const total=Object.values(maps[yr]).reduce((a,b)=>a+b,0);
      const yc=YEAR_COLORS[yr]||{border:'#888'};
      const div=document.createElement('div'); div.className='stat-badge';
      div.innerHTML=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:2px;">${yr}å¹´ ç·æ­Œå”±æ•°</div>
        <div style="font-size:22px;font-weight:700;color:${yc.border};">${total.toLocaleString()}</div>
        <div style="font-size:10px;color:var(--text-muted);">${evCnt[yr]}å…¬æ¼”</div>`;
      sgrid.appendChild(div);
    });
    if(years.length>=2){
      const sorted=[...years].sort();
      const first=sorted[0],last=sorted[sorted.length-1];
      const tf=Object.values(maps[first]).reduce((a,b)=>a+b,0);
      const tl=Object.values(maps[last]).reduce((a,b)=>a+b,0);
      const delta=tl-tf; const growth=tf>0?((delta/tf)*100).toFixed(1):'â€”';
      const div2=document.createElement('div'); div2.className='stat-badge';
      div2.innerHTML=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:2px;">${first}â†’${last} æˆé•·ç‡</div>
        <div style="font-size:22px;font-weight:700;color:${delta>=0?'#34d399':'#f87171'};">${tf>0?(delta>=0?'+':'')+growth+'%':'N/A'}</div>
        <div style="font-size:10px;color:var(--text-muted);">${delta>=0?'+':''} ${delta.toLocaleString()}å›</div>`;
      sgrid.appendChild(div2);
    }

    // å…¬æ¼”æ•°ã‚°ãƒ©ãƒ•
    evChartInst=destroyChart(evChartInst);
    evChartInst=new Chart(resetCanvas('eventChart'),{
      type:'bar',
      data:{labels:years.map(y=>y+'å¹´'),datasets:[{data:years.map(yr=>evCnt[yr]),backgroundColor:years.map(yr=>(YEAR_COLORS[yr]||{bg:'#888'}).bg),borderRadius:10,borderSkipped:false}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>` ${ctx.parsed.y}å…¬æ¼”`}},datalabels:{anchor:'end',align:'end',color:'#3d2b35',font:{family:'DM Mono',size:11,weight:'bold'},formatter:v=>v+'å…¬æ¼”'}},scales:{x:{grid:{display:false},ticks:{font:{family:'Zen Maru Gothic',size:11}}},y:{grid:{color:'rgba(0,0,0,0.04)'},ticks:{font:{family:'DM Mono'}},beginAtZero:true}}}
    });

    // æœˆåˆ¥å…¬æ¼”ã‚°ãƒ©ãƒ•
    moChartInst=destroyChart(moChartInst);
    moChartInst=new Chart(resetCanvas('monthlyChart'),{
      type:'line',
      data:{labels:mths,datasets:years.map(yr=>({
        label:yr,data:mths.map((_,i)=>moEv[i+1][yr]),
        borderColor:(YEAR_COLORS[yr]||{border:'#888'}).border,
        backgroundColor:(YEAR_COLORS[yr]||{bgFill:'rgba(0,0,0,0.05)'}).bgFill,
        fill:true,tension:0.4,pointRadius:4,pointHoverRadius:7
      }))},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font:{family:'Zen Maru Gothic',size:10},padding:8,boxWidth:10}},tooltip:{callbacks:{label:ctx=>` ${ctx.dataset.label}: ${ctx.parsed.y}å…¬æ¼”`}},datalabels:{display:false}},scales:{x:{grid:{display:false},ticks:{font:{family:'Zen Maru Gothic',size:10}}},y:{grid:{color:'rgba(0,0,0,0.04)'},ticks:{font:{family:'DM Mono'}},beginAtZero:true}}}
    });

    // ãƒ¡ã‚¤ãƒ³ãƒˆãƒ¬ãƒ³ãƒ‰ã‚°ãƒ©ãƒ•ï¼ˆæ¨ªæ£’ï¼‰
    const isCombo=cat==='combo';
    trChartInst=destroyChart(trChartInst);
    trChartInst=new Chart(resetCanvas('trendChart'),{
      type:'bar',
      data:{
        labels:combined.map(d=>d.name.length>16?d.name.slice(0,16)+'â€¦':d.name),
        datasets:years.map(yr=>({
          label:yr+'å¹´',data:combined.map(d=>d['v'+yr]||0),
          backgroundColor:(YEAR_COLORS[yr]||{bg:'#888'}).bg,borderRadius:4,borderSkipped:false
        }))
      },
      options:{
        indexAxis:'y',responsive:true,maintainAspectRatio:false,
        onClick:(evt,els)=>{
          if(els.length>0&&!isCombo){
            const d=combined[els[0].index];
            openDrillMulti(d.name,rowsMap,d,years);
          }
        },
        plugins:{
          legend:{position:'top',labels:{font:{family:'Zen Maru Gothic',size:11},padding:12,boxWidth:10}},
          tooltip:{callbacks:{label:ctx=>` ${ctx.dataset.label}: ${ctx.parsed.x}å›`}},
          datalabels:{anchor:'end',align:'end',color:'#3d2b35',font:{family:'DM Mono',size:9,weight:'bold'},formatter:v=>v>0?v+'å›':''},
          zoom:ZoomPluginY,
        },
        scales:{x:{grid:{color:'rgba(0,0,0,0.04)'},ticks:{font:{family:'DM Mono'}}},y:{grid:{display:false},ticks:{font:{family:'Zen Maru Gothic',size:11}}}}
      }
    });
    if(!isCombo) document.getElementById('trendChart').style.cursor='pointer';

    // æœˆåˆ¥æ­Œå”±æ¨ç§»
    const mcCard=document.getElementById('monthlyTrendCard');
    if(cat==='song'){
      mcCard.style.display='block';
      const mc={}; for(let m=1;m<=12;m++){mc[m]={}; years.forEach(yr=>mc[m][yr]=0);}
      for(const yr of years){
        rowsMap[yr].slice(2).forEach(row=>{
          if(!isDataRow(row)) return;
          const d=parseDate(row[C.date]); if(!d) return;
          if(sd&&d<sd) return; if(ed&&d>ed) return;
          const n=row[C.rawSong]; if(!n||!n.trim()) return;
          mc[d.getMonth()+1][yr]++;
        });
      }
      mcChartInst=destroyChart(mcChartInst);
      mcChartInst=new Chart(resetCanvas('monthlyCountChart'),{
        type:'line',
        data:{labels:mths,datasets:years.map(yr=>({
          label:yr,data:mths.map((_,i)=>mc[i+1][yr]),
          borderColor:(YEAR_COLORS[yr]||{border:'#888'}).border,
          backgroundColor:(YEAR_COLORS[yr]||{bgFill:'rgba(0,0,0,0.05)'}).bgFill,
          fill:true,tension:0.4,pointRadius:5,pointHoverRadius:8
        }))},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font:{family:'Zen Maru Gothic',size:11},padding:10,boxWidth:10}},tooltip:{callbacks:{label:ctx=>` ${ctx.dataset.label}: ${ctx.parsed.y}å›`}},datalabels:{display:false},zoom:ZoomPlugin},scales:{x:{grid:{display:false},ticks:{font:{family:'Zen Maru Gothic',size:10}}},y:{grid:{color:'rgba(0,0,0,0.04)'},ticks:{font:{family:'DM Mono'}},beginAtZero:true}}}
      });
    } else { mcCard.style.display='none'; }

  } catch(e){alert('ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—: '+e.message);console.error(e);}
  finally{showLoading(false);}
}

function resetTrendZoom(){if(trChartInst) trChartInst.resetZoom();}
function resetMonthlyZoom(){if(mcChartInst) mcChartInst.resetZoom();}

// ============================================================
// éƒ½é“åºœçœŒåˆ†æ
// ============================================================
let prefChartInst=null;

async function loadPrefData(){
  const year=document.getElementById('prefYearSelect').value;
  showLoading(true);
  try {
    const rows=await fetchSheet(year);
    const nc=detectNewCols(rows);

    // è¨ªå•å›æ•°ï¼ˆãƒ–ãƒ­ãƒƒã‚¯10ï¼‰
    const prefMap={};
    rows.slice(2).forEach(row=>{
      const n=row[C.prefRankN],c=parseFloat(row[C.prefRankC]);
      if(!n||!n.trim()||n==='éƒ½é“åºœçœŒ'||n==='è¨ªå•éƒ½é“åºœçœŒãƒ©ãƒ³ã‚­ãƒ³ã‚°'||n==='è¨ªå•éƒ½é“åºœçœŒæ•°') return;
      if(isNaN(c)||c<=0) return;
      if(!prefMap[n]) prefMap[n]=c;
    });
    const prefSorted=Object.entries(prefMap).sort((a,b)=>b[1]-a[1]);

    // éƒ½é“åºœçœŒåˆ¥TOPæ›²ï¼ˆãƒ–ãƒ­ãƒƒã‚¯11ï¼‰
    const prefTopMap={};
    if(nc.prefTopCols>0){
      const h=rows[0]||[];
      for(let p=0;p<nc.prefTopCols;p++){
        const nc_=nc.prefTopStart+p*2, cc_=nc.prefTopStart+p*2+1;
        const pname=String(h[nc_]||'').replace('TOPæ›²','').trim();
        if(!pname) continue;
        const songs={};
        rows.slice(2).forEach(row=>{
          const sn=row[nc_],sc=parseFloat(row[cc_]);
          if(!sn||!sn.trim()||sn==='æ›²å') return;
          if(isNaN(sc)||sc<=0) return;
          if(!songs[sn]) songs[sn]=sc;
        });
        prefTopMap[pname]=Object.entries(songs).sort((a,b)=>b[1]-a[1]);
      }
    }

    // ã‚µãƒãƒªãƒ¼
    const totalEv=prefSorted.reduce((s,r)=>s+r[1],0);
    const abroad=prefSorted.filter(p=>['ä¸­å›½ï¼ˆä¸Šæµ·ï¼‰','éŸ“å›½','å°æ¹¾'].includes(p[0]));
    document.getElementById('prefSummary').style.display='block';
    document.getElementById('ps-visited').innerHTML=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:2px;">è¨ªå•ãƒµæ‰€æ•°</div><div style="font-size:26px;font-weight:700;color:var(--pink-dark);">${prefSorted.length}<span style="font-size:12px;font-weight:400;">ãƒµæ‰€</span></div>`;
    document.getElementById('ps-events').innerHTML=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:2px;">ç·ã‚¤ãƒ™ãƒ³ãƒˆæ•°</div><div style="font-size:26px;font-weight:700;color:var(--gold);">${totalEv}<span style="font-size:12px;font-weight:400;">å…¬æ¼”</span></div>`;
    document.getElementById('ps-top').innerHTML=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:2px;">æœ€å¤šè¨ªå•åœ°</div><div style="font-size:16px;font-weight:700;color:var(--text);">${prefSorted[0]?.[0]||'â€”'}</div><div style="font-size:10px;color:var(--text-muted);">${prefSorted[0]?.[1]||0}å…¬æ¼”</div>`;
    document.getElementById('ps-abroad').innerHTML=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:2px;">æµ·å¤–å…¬æ¼”</div><div style="font-size:16px;font-weight:700;color:var(--text);">${abroad.length}<span style="font-size:11px;font-weight:400;">ãƒµå›½</span></div><div style="font-size:10px;color:var(--text-muted);">${abroad.map(a=>a[0]).join(' / ')||'ãªã—'}</div>`;

    // éƒ½é“åºœçœŒã‚«ãƒ¼ãƒ‰
    const grid=document.getElementById('prefGrid'); grid.innerHTML='';
    prefSorted.forEach(([pref,cnt])=>{
      const tops=prefTopMap[pref]||[];
      const top1=tops[0]?.[0]||'â€”';
      const card=document.createElement('div'); card.className='pref-card';
      card.onclick=()=>renderPrefChart(pref,tops,year);
      card.innerHTML=`<div class="pref-name">${pref}</div><div class="pref-count">${cnt}<span style="font-size:10px;font-weight:400;color:var(--text-muted);">å…¬æ¼”</span></div><div class="pref-top">ğŸµ ${top1}</div>`;
      grid.appendChild(card);
    });

  } catch(e){alert('éƒ½é“åºœçœŒãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—: '+e.message);console.error(e);}
  finally{showLoading(false);}
}

function renderPrefChart(pref,songs,year){
  document.getElementById('prefEmptyState').style.display='none';
  document.getElementById('prefChartSub').textContent=`${pref} â€” ${year}å¹´ TOPæ›² (${songs.length}æ›²)`;
  const top20=songs.slice(0,20);
  prefChartInst=destroyChart(prefChartInst);
  prefChartInst=new Chart(resetCanvas('prefChart'),{
    type:'bar',
    data:{labels:top20.map(s=>s[0].length>12?s[0].slice(0,12)+'â€¦':s[0]),datasets:[{label:pref,data:top20.map(s=>s[1]),backgroundColor:COLORS.map(c=>c+'bb'),borderRadius:7,borderSkipped:false}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>` ${ctx.parsed.y}å›`}},datalabels:{anchor:'end',align:'end',color:'#3d2b35',font:{family:'DM Mono',size:10,weight:'bold'},formatter:v=>v>0?v+'å›':''},zoom:ZoomPlugin},scales:{x:{grid:{display:false},ticks:{font:{family:'Zen Maru Gothic',size:10},maxRotation:35}},y:{grid:{color:'rgba(0,0,0,0.04)'},ticks:{font:{family:'DM Mono',size:10}},beginAtZero:true}}}
  });
}

function resetPrefZoom(){if(prefChartInst) prefChartInst.resetZoom();}

// ============================================================
// UI
// ============================================================
let compareHasRunFlag=false;
function switchTab(id){
  document.querySelectorAll('.tab-content').forEach(el=>el.classList.remove('active'));
  document.getElementById('tab-'+id).classList.add('active');
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  ['analyze','compare','event','pref'].forEach((t,i)=>{
    if(t===id) document.querySelectorAll('.nav-btn')[i]?.classList.add('active');
  });
  document.querySelectorAll('.mobile-nav-btn').forEach(b=>b.classList.remove('active'));
  const mb=document.getElementById('mnav-'+id); if(mb) mb.classList.add('active');
  if(id==='compare'&&!compareHasRunFlag){compareHasRunFlag=true;runCompare();}
  if(id==='pref') loadPrefData();
  if(id==='event') initEventTab();
  if(id==='analyze') initAnalyzeTab();
}

function resetFilters(){
  document.getElementById('columnSelect').value='song';
  document.getElementById('chartTypeSelect').value='horizontalBar';
  document.getElementById('startDate').value='';
  document.getElementById('endDate').value='';
  document.getElementById('limitSelect').value='20';
  document.getElementById('statsRow').style.display='none';
  document.getElementById('emptyState').style.display='flex';
  document.getElementById('chartTitleText').textContent='åˆ†æçµæœ';
  document.getElementById('chartSubtitle').textContent='åˆ†æè¨­å®šã‚’é¸æŠã—ã¦ã€Œåˆ†æã‚’é–‹å§‹ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„';
  document.getElementById('rankingSection').style.display='none';
  mainChartInst=destroyChart(mainChartInst);
}

function showLoading(show){document.getElementById('loading').classList.toggle('show',show);}


// ============================================================
// å…¬æ¼”åˆ¥åˆ†æ
// ============================================================
let evAllEvents = [];      // {year, date, title, key}
let evGrouped = {};        // {year: {groupName: [events]}}
let evSelected = new Set();// é¸æŠä¸­ã®å…¬æ¼”key Set
let evSlotA = new Set();
let evSlotB = new Set();
let evChartInst2 = null;
let evCompareChartInst = null;
let evTabInited = false;

// ã‚¤ãƒ™ãƒ³ãƒˆã‚­ãƒ¼ç”Ÿæˆ
function evKey(year, title, date) {
  return year + '||' + date + '||' + title;
}

// ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰ã‚°ãƒ«ãƒ¼ãƒ—åã‚’æ¨å®šï¼ˆå…±é€šãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ï¼‰
function inferGroup(title) {
  return title
    .replace(/[(ï¼ˆã€ã€”ã€Œ][^)ï¼‰ã€‘ã€•ã€]*[)ï¼‰ã€‘ã€•ã€]/g, '')
    .replace(/\s*(Vol\.?\d+|ç¬¬\d+å¼¾|#\d+|\d+æ—¥ç›®|\d+å…¬æ¼”ç›®|PART\d+|DAY\d+|æ˜¼|å¤œ|â‘ â‘¡â‘¢|\d+éƒ¨)\s*/gi, '')
    .replace(/\s+/g, ' ')
    .trim() || title;
}

async function initEventTab() {
  if (evTabInited) return;
  evTabInited = true;
  showLoading(true);
  try {
    evAllEvents = [];
    evGrouped = {};

    for (const yr of ALL_YEARS) {
      try {
        const rows = await fetchSheet(yr);
        const seen = new Set();
        rows.slice(2).forEach(row => {
          if (!isDataRow(row)) return;
          const title = row[C.title] || '';
          const dateRaw = row[C.date];
          if (!title.trim() || !dateRaw) return;
          const d = parseDate(dateRaw); if (!d) return;
          const ds = d.toISOString().slice(0, 10);
          const k = evKey(yr, title, ds);
          if (!seen.has(k)) {
            seen.add(k);
            evAllEvents.push({ year: yr, date: d, dateStr: ds, title, key: k });
          }
        });
      } catch(e) { /* å¹´ãƒ‡ãƒ¼ã‚¿ãªã‘ã‚Œã°ã‚¹ã‚­ãƒƒãƒ— */ }
    }

    // å¹´åˆ¥ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ï¼ˆåŒã˜ã‚°ãƒ«ãƒ¼ãƒ—åãŒ2å…¬æ¼”ä»¥ä¸Šã®ã¨ãã ã‘ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ï¼‰
    evAllEvents.sort((a, b) => b.date - a.date);
    evGrouped = {};
    // ã¾ãšå…¨å¹´ã§ã‚°ãƒ«ãƒ¼ãƒ—å€™è£œã‚’æ•°ãˆã‚‹ï¼ˆå¹´ã‚’ã¾ãŸã„ã§åŒåãƒ„ã‚¢ãƒ¼ã‚‚ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ï¼‰
    const groupCount = {};
    evAllEvents.forEach(ev => {
      const g = inferGroup(ev.title);
      // ã‚¿ã‚¤ãƒˆãƒ«ã¨æ¨å®šã‚°ãƒ«ãƒ¼ãƒ—åãŒåŒã˜ï¼ˆå¤‰åŒ–ãªã—ï¼‰ã¯ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ä¸è¦å€™è£œ
      if (g !== ev.title) groupCount[g] = (groupCount[g]||0) + 1;
    });
    evAllEvents.forEach(ev => {
      if (!evGrouped[ev.year]) evGrouped[ev.year] = {};
      const g = inferGroup(ev.title);
      // 2å…¬æ¼”ä»¥ä¸Šã‚ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—åã ã‘ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã€ãã‚Œä»¥å¤–ã¯ã‚¿ã‚¤ãƒˆãƒ«ã‚’ãã®ã¾ã¾ã‚°ãƒ«ãƒ¼ãƒ—åã«
      const groupKey = (g !== ev.title && groupCount[g] >= 2) ? g : ev.title;
      if (!evGrouped[ev.year][groupKey]) evGrouped[ev.year][groupKey] = [];
      evGrouped[ev.year][groupKey].push(ev);
    });

    renderEventList();
  } catch(e) { alert('å…¬æ¼”ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—: ' + e.message); console.error(e); }
  finally { showLoading(false); }
}

function filterEventList() {
  renderEventList();
}

function renderEventList() {
  const query = (document.getElementById('eventSearch').value || '').toLowerCase();
  const checkedYears = new Set([...document.querySelectorAll('.ev-year-filter:checked')].map(c => c.value));
  const list = document.getElementById('eventList');
  list.innerHTML = '';

  const years = Object.keys(evGrouped).sort((a,b) => b-a);
  years.forEach(yr => {
    if (!checkedYears.has(yr)) return;
    const groups = evGrouped[yr];
    const yrSection = document.createElement('div');
    yrSection.className = 'event-year-section';

    let yrTotal = 0;
    const groupEls = [];

    Object.entries(groups).sort((a,b) => {
      // æœ€æ–°å…¬æ¼”æ—¥ã§ã‚½ãƒ¼ãƒˆ
      const latestA = Math.max(...a[1].map(e => e.date));
      const latestB = Math.max(...b[1].map(e => e.date));
      return latestB - latestA;
    }).forEach(([groupName, events]) => {
      // ã‚¯ã‚¨ãƒªãƒ•ã‚£ãƒ«ã‚¿
      const matched = events.filter(ev =>
        !query || ev.title.toLowerCase().includes(query) || groupName.toLowerCase().includes(query)
      );
      if (!matched.length) return;
      yrTotal += matched.length;

      const groupSec = document.createElement('div');
      groupSec.className = 'event-group-section';

      // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ˜ãƒƒãƒ€ãƒ¼
      const gh = document.createElement('div');
      gh.className = 'event-group-header';
      const allChecked = matched.every(ev => evSelected.has(ev.key));
      const someChecked = matched.some(ev => evSelected.has(ev.key));
      gh.innerHTML = `
        <input type="checkbox" style="width:14px;height:14px;accent-color:var(--pink);flex-shrink:0;"
          ${allChecked ? 'checked' : someChecked ? 'indeterminate' : ''}
          onchange="toggleGroup(this,'${groupName}','${yr}')">
        <span class="event-group-label" title="${groupName}">${groupName}</span>
        <span class="event-group-count">${matched.length}å…¬æ¼”</span>
        <span class="event-group-toggle">â–¼</span>`;
      if (someChecked && !allChecked) {
        gh.querySelector('input').indeterminate = true;
      }

      const itemsDiv = document.createElement('div');
      itemsDiv.className = 'event-items';
      // ã‚¯ã‚¨ãƒªã‚ã‚‹ã¨ãã¯è‡ªå‹•å±•é–‹
      if (query || matched.length <= 3) itemsDiv.classList.add('open');

      gh.addEventListener('click', e => {
        if (e.target.tagName === 'INPUT') return;
        itemsDiv.classList.toggle('open');
        gh.querySelector('.event-group-toggle').style.transform =
          itemsDiv.classList.contains('open') ? 'rotate(180deg)' : '';
      });

      matched.sort((a,b) => b.date - a.date).forEach(ev => {
        const item = document.createElement('div');
        item.className = 'event-item';
        const checked = evSelected.has(ev.key);
        item.innerHTML = `
          <input type="checkbox" ${checked ? 'checked' : ''} onchange="toggleEvent(this,'${ev.key}')">
          <span class="event-item-name" title="${ev.title}">${ev.title}</span>
          <span class="event-item-date">${ev.dateStr}</span>`;
        itemsDiv.appendChild(item);
      });

      groupSec.appendChild(gh);
      groupSec.appendChild(itemsDiv);
      groupEls.push(groupSec);
    });

    if (!groupEls.length) return;

    // å¹´ãƒ˜ãƒƒãƒ€ãƒ¼
    const yh = document.createElement('div');
    yh.className = 'event-year-header';
    const allYrChecked = evAllEvents.filter(e=>e.year===yr).every(e=>evSelected.has(e.key));
    yh.innerHTML = `
      <input type="checkbox" style="width:14px;height:14px;accent-color:var(--pink);flex-shrink:0;"
        ${allYrChecked?'checked':''} onchange="toggleYear(this,'${yr}')">
      <span class="event-year-label">${yr}å¹´</span>
      <span class="event-year-count">${yrTotal}å…¬æ¼”</span>`;

    yrSection.appendChild(yh);
    groupEls.forEach(el => yrSection.appendChild(el));
    list.appendChild(yrSection);
  });

  if (!list.children.length) {
    list.innerHTML = '<div style="color:var(--text-muted);font-size:13px;padding:12px;text-align:center;">è©²å½“å…¬æ¼”ãªã—</div>';
  }
  updateSelectedTags();
}

function toggleEvent(cb, key) {
  if (cb.checked) evSelected.add(key);
  else evSelected.delete(key);
  updateSelectedTags();
  // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ˜ãƒƒãƒ€ãƒ¼ã®indeterminateæ›´æ–°ï¼ˆå†æç”»ã§å¯¾å¿œï¼‰
  renderEventList();
}

function toggleGroup(cb, groupName, yr) {
  const events = (evGrouped[yr]||{})[groupName]||[];
  events.forEach(ev => { if(cb.checked) evSelected.add(ev.key); else evSelected.delete(ev.key); });
  updateSelectedTags();
  renderEventList();
}

function toggleYear(cb, yr) {
  evAllEvents.filter(e=>e.year===yr).forEach(ev => {
    if(cb.checked) evSelected.add(ev.key); else evSelected.delete(ev.key);
  });
  updateSelectedTags();
  renderEventList();
}

function selectAllVisible() {
  const query = (document.getElementById('eventSearch').value||'').toLowerCase();
  const checkedYears = new Set([...document.querySelectorAll('.ev-year-filter:checked')].map(c=>c.value));
  evAllEvents.forEach(ev => {
    if (!checkedYears.has(ev.year)) return;
    if (query && !ev.title.toLowerCase().includes(query)) return;
    evSelected.add(ev.key);
  });
  updateSelectedTags();
  renderEventList();
}

function clearAllSelection() {
  evSelected.clear();
  updateSelectedTags();
  renderEventList();
}

function updateSelectedTags() {
  // é¸æŠæ•°ã‚’å·¦ãƒ‘ãƒãƒ«ã«è¡¨ç¤º
  const countEl = document.getElementById('evSelCount');
  if (countEl) countEl.textContent = evSelected.size ? `${evSelected.size}å…¬æ¼”é¸æŠä¸­` : '';

  // å…¬æ¼”åˆ†æãƒ‘ãƒãƒ«ã®ã‚¿ã‚°ã‚‚æ›´æ–°
  const container = document.getElementById('selectedTags');
  if (!container) {
    onEvSelectionChange();
    return;
  }
  container.innerHTML = '';
  if (!evSelected.size) {
    container.innerHTML = '<span style="font-size:12px;color:var(--text-muted);">å…¬æ¼”ã‚’é¸æŠã—ã¦ãã ã•ã„</span>';
    const el2 = document.getElementById('evSelCount2'); if(el2) el2.textContent = '';
    onEvSelectionChange();
    return;
  }
  const selected = evAllEvents.filter(ev => evSelected.has(ev.key)).sort((a,b)=>b.date-a.date);
  const showMax = 10;
  selected.slice(0, showMax).forEach(ev => {
    const tag = document.createElement('div'); tag.className = 'sel-tag';
    const label = ev.title.length > 16 ? ev.title.slice(0,16)+'â€¦' : ev.title;
    tag.innerHTML = `<span>${label}</span><button class="sel-tag-x" onclick="deselectEvent('${ev.key.replace(/'/g,"\\'")}')">âœ•</button>`;
    container.appendChild(tag);
  });
  if (selected.length > showMax) {
    const more = document.createElement('span');
    more.style.cssText = 'font-size:11px;color:var(--text-muted);padding:3px 8px;';
    more.textContent = `â€¦ä»–${selected.length - showMax}å…¬æ¼”`;
    container.appendChild(more);
  }
  const el2 = document.getElementById('evSelCount2');
  if (el2) el2.textContent = `è¨ˆ${selected.length}å…¬æ¼”é¸æŠä¸­`;
  onEvSelectionChange();
}

function deselectEvent(key) {
  evSelected.delete(key);
  updateSelectedTags();
  renderEventList();
}

// â”€â”€ åˆ†æå®Ÿè¡Œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function analyzeEvents() {
  if (!evSelected.size) { alert('å…¬æ¼”ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  const cat = document.getElementById('evColumnSelect').value;
  const chartType = document.getElementById('evChartTypeSelect').value;
  const limit = parseInt(document.getElementById('evLimitSelect').value);

  showLoading(true);
  try {
    const results = await buildEventResults(evSelected, cat);
    const limited = results.slice(0, limit === 999 ? results.length : limit);
    if (!limited.length) { alert('ãƒ‡ãƒ¼ã‚¿ãªã—'); return; }

    const selectedEvents = evAllEvents.filter(ev => evSelected.has(ev.key));
    const evTitle = summarizeEventSelection(selectedEvents);

    document.getElementById('evChartCard').style.display = 'block';
    document.getElementById('evCompareCard').style.display = 'none';
    document.getElementById('evChartTitle').textContent = evTitle;
    document.getElementById('evChartSub').textContent = `${CAT_LABEL[cat]||cat} / ä¸Šä½${limited.length}æ›² (${selectedEvents.length}å…¬æ¼”ã®ãƒ‡ãƒ¼ã‚¿)`;

    evChartInst2 = destroyChart(evChartInst2);
    const ctx = resetCanvas('evChart');
    const onClickFn = (cat !== 'combo') ? (evt, els) => {
      if (els.length > 0) {
        const name = limited[els[0].index][0];
        // é¸æŠå…¬æ¼”ã«çµã£ãŸãƒ‰ãƒªãƒ«ãƒ€ã‚¦ãƒ³
        const fakeRowsMap = buildFakeRowsMap(evSelected);
        const sd = {}; sd['vAll'] = limited[els[0].index][1]; sd.total = sd['vAll'];
        openDrillForEvents(name, fakeRowsMap, limited[els[0].index][1], selectedEvents);
      }
    } : null;
    evChartInst2 = new Chart(ctx, buildChart(chartType,
      limited.map(r => r[0]), limited.map(r => r[1]),
      CAT_LABEL[cat]||cat, onClickFn));
    if (cat !== 'combo') document.getElementById('evChart').style.cursor = 'pointer';

  } catch(e) { alert('åˆ†æå¤±æ•—: ' + e.message); console.error(e); }
  finally { showLoading(false); }
}

// â”€â”€ ã‚°ãƒ«ãƒ¼ãƒ—æ¯”è¼ƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function compareSlots() {
  if (!evSlotA.size && !evSlotB.size) { alert('ã‚°ãƒ«ãƒ¼ãƒ—Aãƒ»Bã«å…¬æ¼”ã‚’è¿½åŠ ã—ã¦ãã ã•ã„'); return; }
  if (!evSlotA.size || !evSlotB.size) { alert('ã‚°ãƒ«ãƒ¼ãƒ—Aã¨Bã®ä¸¡æ–¹ã«å…¬æ¼”ã‚’è¿½åŠ ã—ã¦ãã ã•ã„'); return; }
  const cat = document.getElementById('evCompareCat').value;
  const limit = 30;

  showLoading(true);
  try {
    const [rA, rB] = await Promise.all([buildEventResults(evSlotA, cat), buildEventResults(evSlotB, cat)]);
    const mapA = Object.fromEntries(rA), mapB = Object.fromEntries(rB);
    const names = [...new Set([...Object.keys(mapA), ...Object.keys(mapB)])];
    const combined = names.map(n => ({ name:n, vA:mapA[n]||0, vB:mapB[n]||0, total:(mapA[n]||0)+(mapB[n]||0) }))
      .sort((a,b) => b.total - a.total).slice(0, limit===999?names.length:limit);

    const evA = evAllEvents.filter(e => evSlotA.has(e.key));
    const evB = evAllEvents.filter(e => evSlotB.has(e.key));
    const titleA = summarizeEventSelection(evA);
    const titleB = summarizeEventSelection(evB);

    document.getElementById('evCompareCard').style.display = 'block';
    document.getElementById('evCompareTitle').textContent = `${titleA} vs ${titleB}`;
    document.getElementById('evCompareSub').textContent = `${CAT_LABEL[cat]||cat} / Group A: ${evA.length}å…¬æ¼”, Group B: ${evB.length}å…¬æ¼”`;

    evCompareChartInst = destroyChart(evCompareChartInst);
    evCompareChartInst = new Chart(resetCanvas('evCompareChart'), {
      type: 'bar',
      data: {
        labels: combined.map(d => d.name.length > 16 ? d.name.slice(0,16)+'â€¦' : d.name),
        datasets: [
          { label: titleA.length > 20 ? titleA.slice(0,20)+'â€¦' : titleA, data: combined.map(d=>d.vA), backgroundColor:'rgba(244,114,182,0.85)', borderRadius:4, borderSkipped:false },
          { label: titleB.length > 20 ? titleB.slice(0,20)+'â€¦' : titleB, data: combined.map(d=>d.vB), backgroundColor:'rgba(212,175,55,0.85)', borderRadius:4, borderSkipped:false }
        ]
      },
      options: {
        indexAxis:'y', responsive:true, maintainAspectRatio:false,
        plugins: {
          legend: { position:'top', labels:{ font:{family:'Zen Maru Gothic',size:11}, padding:12, boxWidth:10 } },
          tooltip: { callbacks: { label: ctx => ` ${ctx.dataset.label}: ${ctx.parsed.x}å›` } },
          datalabels: { anchor:'end', align:'end', color:'#3d2b35', font:{family:'DM Mono',size:9,weight:'bold'}, formatter:v=>v>0?v+'å›':'' },
          zoom: ZoomPluginY,
        },
        scales: {
          x: { grid:{color:'rgba(0,0,0,0.04)'}, ticks:{font:{family:'DM Mono'}} },
          y: { grid:{display:false}, ticks:{font:{family:'Zen Maru Gothic',size:11}} }
        }
      }
    });

  } catch(e) { alert('æ¯”è¼ƒå¤±æ•—: ' + e.message); console.error(e); }
  finally { showLoading(false); }
}

// â”€â”€ ã‚¹ãƒ­ãƒƒãƒˆç®¡ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addToSlot(slot) {
  if (!evSelected.size) { alert('å…ˆã«å…¬æ¼”ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  const target = slot === 'A' ? evSlotA : evSlotB;
  evSelected.forEach(k => target.add(k));
  renderSlot(slot);
}

function clearSlots() {
  evSlotA.clear(); evSlotB.clear();
  renderSlot('A'); renderSlot('B');
  document.getElementById('evCompareCard').style.display = 'none';
}

function renderSlot(slot) {
  const slotSet = slot === 'A' ? evSlotA : evSlotB;
  const tagsEl = document.getElementById('evTags' + slot);
  const slotEl = document.getElementById('evSlot' + slot);
  tagsEl.innerHTML = '';
  slotEl.classList.toggle('has-data', slotSet.size > 0);
  if (!slotSet.size) {
    tagsEl.innerHTML = `<span style="font-size:11px;color:var(--text-muted);">å…¬æ¼”ã‚’é¸æŠã—ã¦ã€Œ${slot}ã«è¿½åŠ ã€</span>`;
    return;
  }
  const color = slot === 'A' ? 'var(--pink)' : 'var(--gold)';
  const events = evAllEvents.filter(e => slotSet.has(e.key));
  // ã‚°ãƒ«ãƒ¼ãƒ—åã§ã¾ã¨ã‚ã¦è¡¨ç¤º
  const groups = {};
  events.forEach(ev => { const g = inferGroup(ev.title); groups[g] = (groups[g]||0)+1; });
  Object.entries(groups).forEach(([g, cnt]) => {
    const tag = document.createElement('div');
    tag.className = 'sel-tag';
    tag.style.background = color;
    const label = g.length > 14 ? g.slice(0,14)+'â€¦' : g;
    tag.innerHTML = `<span>${label} (${cnt})</span>`;
    tagsEl.appendChild(tag);
  });
}

// â”€â”€ ãƒ‡ãƒ¼ã‚¿é›†è¨ˆãƒ˜ãƒ«ãƒ‘ãƒ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function buildEventResults(keySet, cat) {
  // keySetã®å…¬æ¼”ãƒ‡ãƒ¼ã‚¿ã‚’å…¨å¹´ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰æŠ½å‡ºã—ã¦é›†è¨ˆ
  const selectedKeys = new Set(keySet);
  // é¸æŠå…¬æ¼”ã®yearãƒªã‚¹ãƒˆ
  const years = [...new Set(evAllEvents.filter(e=>selectedKeys.has(e.key)).map(e=>e.year))];

  const countMap = {};
  for (const yr of years) {
    const rows = await fetchSheet(yr);
    rows.slice(2).forEach(row => {
      if (!isDataRow(row)) return;
      const d = parseDate(row[C.date]); if (!d) return;
      const ds = d.toISOString().slice(0, 10);
      const k = evKey(yr, row[C.title]||'', ds);
      if (!selectedKeys.has(k)) return;

      // å…¨æ›²é›†è¨ˆ
      if (cat === 'song' || cat === 'combo') {
        const name = row[C.rawSong]; if (!name||!name.trim()) return;
        countMap[name] = (countMap[name]||0) + 1;
      } else if (cat === 'first') {
        // 1æ›²ç›®: isFirståˆ—ãŒâ˜…ã®è¡Œ
        const isFirst = row[C.isFirst];
        if (!isFirst || isFirst.trim() === '') return;
        const name = row[C.rawSong]; if (!name||!name.trim()) return;
        countMap[name] = (countMap[name]||0) + 1;
      } else if (cat === 'last') {
        const isLast = row[C.isLast];
        if (!isLast || isLast.trim() === '') return;
        const name = row[C.rawSong]; if (!name||!name.trim()) return;
        countMap[name] = (countMap[name]||0) + 1;
      }
    });
  }
  return Object.entries(countMap).sort((a,b)=>b[1]-a[1]);
}

function summarizeEventSelection(events) {
  if (!events.length) return 'ï¼ˆæœªé¸æŠï¼‰';
  if (events.length === 1) return events[0].title;
  // æœ€ã‚‚å¤šã„ã‚°ãƒ«ãƒ¼ãƒ—åã‚’ä»£è¡¨ã«
  const groups = {};
  events.forEach(ev => { const g=inferGroup(ev.title); groups[g]=(groups[g]||0)+1; });
  const top = Object.entries(groups).sort((a,b)=>b[1]-a[1])[0];
  if (top[1] === events.length) return top[0];
  if (top[1] > 1) return `${top[0]} ä»–`;
  return `${events.length}å…¬æ¼”`;
}

// å…¬æ¼”åˆ¥ãƒ‰ãƒªãƒ«ãƒ€ã‚¦ãƒ³ï¼ˆé¸æŠå…¬æ¼”ã«çµã£ã¦æœˆåˆ¥è¡¨ç¤ºï¼‰
function openDrillForEvents(songName, rowsMap, total, selectedEvents) {
  // æ—¥ä»˜â†’æœˆã®ãƒãƒƒãƒ”ãƒ³ã‚°
  const monthly = {}; for(let m=1;m<=12;m++) monthly[m]=0;
  const evList = [];
  selectedEvents.forEach(ev => {
    const rows = sheetCache[ev.year] || [];
    rows.slice(2).forEach(row => {
      if (!isDataRow(row)) return;
      if (row[C.rawSong] !== songName) return;
      const d = parseDate(row[C.date]); if (!d) return;
      const ds = d.toISOString().slice(0,10);
      const k = evKey(ev.year, row[C.title]||'', ds);
      if (!evSelected.has(k) && !evSlotA.has(k) && !evSlotB.has(k)) return;
      monthly[d.getMonth()+1]++;
      evList.push({ date:d, title:row[C.title]||'ä¸æ˜', venue:row[C.venue]||'', pref:row[C.pref]||'', year:ev.year });
    });
  });
  evList.sort((a,b)=>b.date-a.date);

  // openDrillMultiã®ä»£ã‚ã‚Šã«ç›´æ¥ãƒ¢ãƒ¼ãƒ€ãƒ«æç”»
  document.getElementById('drillSongName').textContent = songName;
  document.getElementById('drillSongSub').textContent = `é¸æŠå…¬æ¼”å†… åˆè¨ˆ: ${total}å›`;
  const yrGrid = document.getElementById('drillYearGrid');
  yrGrid.innerHTML = `<div class="stat-badge"><div style="font-size:10px;color:var(--text-muted);margin-bottom:3px;">é¸æŠå…¬æ¼”å†…</div><div style="font-size:28px;font-weight:700;color:var(--pink);">${total}å›</div></div>`;

  drillInst = destroyChart(drillInst);
  const mths=['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
  drillInst = new Chart(resetCanvas('drillMonthChart'), {
    type:'bar',
    data:{labels:mths,datasets:[{label:'æ­Œå”±å›æ•°',data:mths.map((_,i)=>monthly[i+1]),backgroundColor:'rgba(244,114,182,0.8)',borderRadius:5}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>` ${ctx.parsed.y}å›`}},datalabels:{anchor:'end',align:'end',color:'#3d2b35',font:{family:'DM Mono',size:9,weight:'bold'},formatter:v=>v>0?v+'å›':''}},scales:{x:{grid:{display:false},ticks:{font:{family:'Zen Maru Gothic',size:10}}},y:{grid:{color:'rgba(0,0,0,0.04)'},ticks:{font:{family:'DM Mono',size:10}},beginAtZero:true}}}
  });

  const evHtml = evList.slice(0,20).map(e => {
    const ds=`${e.date.getFullYear()}/${String(e.date.getMonth()+1).padStart(2,'0')}/${String(e.date.getDate()).padStart(2,'0')}`;
    const yc=YEAR_COLORS[e.year]||{border:'#888'};
    return `<div style="display:flex;gap:7px;align-items:flex-start;padding:6px 10px;background:var(--bg);border-radius:9px;">
      <span style="font-size:9px;font-weight:700;color:#fff;background:${yc.border};padding:2px 6px;border-radius:20px;flex-shrink:0;margin-top:2px;">${e.year}</span>
      <div style="flex:1;overflow:hidden;"><div style="font-size:12px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${e.title}</div>
      <div style="font-size:10px;color:var(--text-muted);">${ds}${e.venue?' Â· '+e.venue:''}${e.pref?' ğŸ“'+e.pref:''}</div></div></div>`;
  }).join('');
  document.getElementById('drillEventList').innerHTML = evHtml || '<div style="color:var(--text-muted);font-size:13px;">ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ãªã—</div>';
  document.getElementById('drillModal').style.display = 'block';
  document.body.style.overflow = 'hidden';
}

function buildFakeRowsMap(keySet) {
  const years = [...new Set(evAllEvents.filter(e=>keySet.has(e.key)).map(e=>e.year))];
  const m = {};
  years.forEach(yr => { if(sheetCache[yr]) m[yr] = sheetCache[yr]; });
  return m;
}

function resetEvZoom() { if(evChartInst2) evChartInst2.resetZoom(); }
function resetEvCompareZoom() { if(evCompareChartInst) evCompareChartInst.resetZoom(); }

// ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œï¼šã‚°ãƒªãƒƒãƒ‰ã‚’ã‚¹ã‚¿ãƒƒã‚¯
function applyEventGridLayout() {
  const grid = document.getElementById('evMainGrid');
  if (!grid) return;
  grid.style.gridTemplateColumns = window.innerWidth <= 900 ? '1fr' : '320px 1fr';
}
window.addEventListener('resize', applyEventGridLayout);
applyEventGridLayout();


// ============================================================
// æ¥½æ›²åˆ†æã‚¿ãƒ– â€” ãƒ¢ãƒ¼ãƒ‰ç®¡ç†
// ============================================================
let currentAnalyzeMode = 'category';
let allSongNames = [];  // å…¨å¹´ã‹ã‚‰åé›†ã—ãŸæ¥½æ›²åãƒªã‚¹ãƒˆ
let songChartTrend = null, songChartMonth = null;

function setAnalyzeMode(mode) {
  currentAnalyzeMode = mode;
  document.getElementById('panelCategory').style.display = mode==='category' ? '' : 'none';
  document.getElementById('panelSong').style.display = mode==='song' ? '' : 'none';
  document.getElementById('modeBtnCategory').classList.toggle('active', mode==='category');
  document.getElementById('modeBtnSong').classList.toggle('active', mode==='song');
  // çµæœãƒªã‚»ãƒƒãƒˆ
  document.getElementById('mainChartCard').style.display = mode==='category' ? '' : 'none';
  document.getElementById('statsRow').style.display = 'none';
  document.getElementById('rankingSection').style.display = 'none';
  document.getElementById('songAnalysisPanel').style.display = mode==='song' ? '' : 'none';
  if(mode==='song') loadSongNameList();
}

function initAnalyzeTab() {
  // Already initialized on page load, nothing to do
}

function onAnalyzeYearChange() {
  // å¹´å¤‰æ›´æ™‚ã«æ¥½æ›²åãƒªã‚¹ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
  allSongNames = [];
  if(currentAnalyzeMode === 'song') loadSongNameList();
}

async function loadSongNameList() {
  const years = [...document.querySelectorAll('.an-year-cb:checked')].map(cb=>cb.value);
  if(!years.length) return;
  const nameSet = new Set();
  showLoading(true);
  try {
    for(const yr of years) {
      const rows = await fetchSheet(yr);
      rows.slice(2).forEach(row => {
        if(!isDataRow(row)) return;
        const n = row[C.rawSong]; if(n && n.trim()) nameSet.add(n.trim());
      });
    }
    allSongNames = [...nameSet].sort();
    // datalistæ›´æ–°
    const dl = document.getElementById('songDatalist');
    dl.innerHTML = allSongNames.map(n=>`<option value="${n.replace(/"/g,'&quot;')}">`).join('');
    // ã‚¯ã‚¤ãƒƒã‚¯ãƒ”ãƒƒã‚¯ï¼ˆã‚ˆãæ­Œã‚ã‚Œã‚‹ä¸Šä½5æ›²ã‚’ã‚µã‚¸ã‚§ã‚¹ãƒˆï¼‰
    renderSongQuickPicks(allSongNames.slice(0, 20));
  } catch(e) { console.error(e); }
  finally { showLoading(false); }
}

function renderSongQuickPicks(names) {
  const qp = document.getElementById('songQuickPicks');
  qp.innerHTML = '<span style="font-size:10px;color:var(--text-muted);align-self:center;flex-shrink:0;">å€™è£œï¼š</span>' +
    names.slice(0,8).map(n=>
      `<button class="btn" style="padding:4px 10px;font-size:11px;background:var(--pink-light);color:var(--pink-dark);border-radius:20px;"
        onclick="document.getElementById('songSearchInput').value='${n.replace(/'/g,"\\'")}';analyzeSong()">${n}</button>`
    ).join('');
}

function onSongInputChange() {
  // å…¥åŠ›ã«åˆã‚ã›ã¦ã‚¯ã‚¤ãƒƒã‚¯ãƒ”ãƒƒã‚¯ã‚’ãƒ•ã‚£ãƒ«ã‚¿
  const q = document.getElementById('songSearchInput').value.toLowerCase();
  if(!q) { renderSongQuickPicks(allSongNames.slice(0,8)); return; }
  const filtered = allSongNames.filter(n => n.toLowerCase().includes(q));
  renderSongQuickPicks(filtered.slice(0,8));
}

async function analyzeSong() {
  const songName = document.getElementById('songSearchInput').value.trim();
  if(!songName) { showToast && showToast('æ›²åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); alert('æ›²åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const years = [...document.querySelectorAll('.an-year-cb:checked')].map(cb=>cb.value);
  if(!years.length) { alert('å¯¾è±¡å¹´ã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„'); return; }

  showLoading(true);
  try {
    const rowsMap = {};
    for(const yr of years) { rowsMap[yr] = await fetchSheet(yr); }

    // å¹´åˆ¥ã‚«ã‚¦ãƒ³ãƒˆ
    const yearCounts = {};
    const monthlyAll = {}; for(let m=1;m<=12;m++) monthlyAll[m]=0;
    const allEvents = [];

    for(const yr of years) {
      let cnt = 0;
      const monthly = {}; for(let m=1;m<=12;m++) monthly[m]=0;
      const seen = new Set();
      rowsMap[yr].slice(2).forEach(row => {
        if(!isDataRow(row)) return;
        if(row[C.rawSong] !== songName) return;
        const d = parseDate(row[C.date]); if(!d) return;
        cnt++;
        monthly[d.getMonth()+1]++;
        monthlyAll[d.getMonth()+1]++;
        const key = row[C.date]+'_'+(row[C.title]||'');
        if(!seen.has(key)){
          seen.add(key);
          allEvents.push({date:d, title:row[C.title]||'ä¸æ˜', venue:row[C.venue]||'', pref:row[C.pref]||'', year:yr, isFirst:!!row[C.isFirst]?.trim(), isLast:!!row[C.isLast]?.trim()});
        }
      });
      yearCounts[yr] = cnt;
    }

    const totalCount = Object.values(yearCounts).reduce((a,b)=>a+b, 0);
    if(!totalCount) { alert(`ã€Œ${songName}ã€ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`); return; }

    allEvents.sort((a,b) => b.date - a.date);
    const lastEvent = allEvents[0];
    const firstEvent = allEvents[allEvents.length-1];
    const firstCount = allEvents.filter(e=>e.isFirst).length;
    const lastCount = allEvents.filter(e=>e.isLast).length;

    // ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰
    const sgrid = document.getElementById('songSummaryGrid');
    const lastDs = lastEvent ? `${lastEvent.date.getFullYear()}/${String(lastEvent.date.getMonth()+1).padStart(2,'0')}/${String(lastEvent.date.getDate()).padStart(2,'0')}` : 'â€”';
    const firstDs = firstEvent ? `${firstEvent.date.getFullYear()}/${String(firstEvent.date.getMonth()+1).padStart(2,'0')}/${String(firstEvent.date.getDate()).padStart(2,'0')}` : 'â€”';
    sgrid.innerHTML = `
      <div class="song-sum-card"><div class="song-sum-label">ç·æ­Œå”±å›æ•°</div><div class="song-sum-val">${totalCount}å›</div><div class="song-sum-sub">${years.join('ãƒ»')}å¹´åˆè¨ˆ</div></div>
      <div class="song-sum-card"><div class="song-sum-label">æœ€çµ‚æ­Œå”±æ—¥</div><div class="song-sum-val" style="font-size:15px;">${lastDs}</div><div class="song-sum-sub">${lastEvent?.title||'â€”'}</div></div>
      <div class="song-sum-card"><div class="song-sum-label">åˆæ­Œå”±æ—¥</div><div class="song-sum-val" style="font-size:15px;">${firstDs}</div><div class="song-sum-sub">${firstEvent?.title||'â€”'}</div></div>
      <div class="song-sum-card"><div class="song-sum-label">1æ›²ç›®èµ·ç”¨</div><div class="song-sum-val">${firstCount}å›</div><div class="song-sum-sub">ãƒˆãƒªèµ·ç”¨: ${lastCount}å›</div></div>
    `;

    // å¹´åˆ¥æ¨ç§»ã‚°ãƒ©ãƒ•
    document.getElementById('songTrendTitle').textContent = `ã€Œ${songName}ã€å¹´åˆ¥ æ­Œå”±å›æ•°`;
    document.getElementById('songTrendSub').textContent = `å…¨${years.length}å¹´é–“ã®æ¨ç§»`;
    songChartTrend = destroyChart(songChartTrend);
    songChartTrend = new Chart(resetCanvas('songTrendChart'), {
      type:'bar',
      data:{
        labels: years.map(yr=>yr+'å¹´'),
        datasets:[{
          label:'æ­Œå”±å›æ•°', data:years.map(yr=>yearCounts[yr]||0),
          backgroundColor: years.map(yr=>(YEAR_COLORS[yr]||{bg:'#f472b6'}).bg),
          borderRadius:8, borderSkipped:false
        }]
      },
      options:{responsive:true,maintainAspectRatio:false,
        plugins:{legend:{display:false},
          tooltip:{callbacks:{label:ctx=>` ${ctx.parsed.y}å›`}},
          datalabels:{anchor:'end',align:'end',color:'#3d2b35',font:{family:'DM Mono',size:12,weight:'bold'},formatter:v=>v>0?v+'å›':''}
        },
        scales:{x:{grid:{display:false},ticks:{font:{family:'Zen Maru Gothic',size:12}}},y:{grid:{color:'rgba(0,0,0,0.04)'},ticks:{font:{family:'DM Mono'}},beginAtZero:true}}
      }
    });

    // æœˆåˆ¥åˆ†å¸ƒã‚°ãƒ©ãƒ•
    const mths=['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
    document.getElementById('songMonthSub').textContent = `å…¨å¹´åˆè¨ˆ / æœˆåˆ¥åˆ†å¸ƒ`;
    songChartMonth = destroyChart(songChartMonth);
    songChartMonth = new Chart(resetCanvas('songMonthChart'), {
      type:'bar',
      data:{labels:mths,datasets:[{label:'æ­Œå”±å›æ•°',data:mths.map((_,i)=>monthlyAll[i+1]),backgroundColor:'rgba(244,114,182,0.8)',borderRadius:6,borderSkipped:false}]},
      options:{responsive:true,maintainAspectRatio:false,
        plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>` ${ctx.parsed.y}å›`}},
          datalabels:{anchor:'end',align:'end',color:'#3d2b35',font:{family:'DM Mono',size:10,weight:'bold'},formatter:v=>v>0?v+'å›':''}
        },
        scales:{x:{grid:{display:false},ticks:{font:{family:'Zen Maru Gothic',size:10}}},y:{grid:{color:'rgba(0,0,0,0.04)'},ticks:{font:{family:'DM Mono',size:10}},beginAtZero:true}}
      }
    });

    // ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§
    document.getElementById('songEventListTitle').textContent = `ğŸ“‹ å‡ºæ¼”ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ï¼ˆ${allEvents.length}ä»¶ï¼‰`;
    document.getElementById('songEventList').innerHTML = allEvents.slice(0,30).map(e => {
      const ds = `${e.date.getFullYear()}/${String(e.date.getMonth()+1).padStart(2,'0')}/${String(e.date.getDate()).padStart(2,'0')}`;
      const yc = YEAR_COLORS[e.year]||{border:'#888'};
      return `<div style="display:flex;gap:7px;align-items:flex-start;padding:6px 10px;background:var(--bg);border-radius:9px;">
        <span style="font-size:9px;font-weight:700;color:#fff;background:${yc.border};padding:2px 6px;border-radius:20px;flex-shrink:0;margin-top:2px;">${e.year}</span>
        <div style="flex:1;overflow:hidden;">
          <div style="font-size:12px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${e.title}</div>
          <div style="font-size:10px;color:var(--text-muted);">${ds}${e.venue?' Â· '+e.venue:''}${e.pref?' ğŸ“'+e.pref:''}</div>
        </div>
        ${e.isFirst ? '<span style="font-size:9px;font-weight:700;padding:1px 6px;border-radius:10px;background:var(--gold-light);color:var(--gold);flex-shrink:0;">1æ›²ç›®</span>' : ''}
        ${e.isLast ? '<span style="font-size:9px;font-weight:700;padding:1px 6px;border-radius:10px;background:var(--pink-light);color:var(--pink-dark);flex-shrink:0;">ãƒˆãƒª</span>' : ''}
      </div>`;
    }).join('') || '<div style="color:var(--text-muted);font-size:13px;padding:12px;">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';

    document.getElementById('songAnalysisPanel').style.display = '';
    document.getElementById('mainChartCard').style.display = 'none';

  } catch(e) { alert('åˆ†æå¤±æ•—: '+e.message); console.error(e); }
  finally { showLoading(false); }
}

function clearSongAnalysis() {
  document.getElementById('songSearchInput').value = '';
  document.getElementById('songAnalysisPanel').style.display = 'none';
  songChartTrend = destroyChart(songChartTrend);
  songChartMonth = destroyChart(songChartMonth);
}

// ============================================================
// å…¬æ¼”åˆ¥ã‚¿ãƒ– â€” ãƒ¢ãƒ¼ãƒ‰ç®¡ç†
// ============================================================
let currentEventMode = 'setlist';

function setEventMode(mode) {
  currentEventMode = mode;
  ['setlist','analyze','compare'].forEach(m => {
    document.getElementById('evModeBtn'+m.charAt(0).toUpperCase()+m.slice(1)).classList.toggle('active', m===mode);
    document.getElementById('evPanel'+m.charAt(0).toUpperCase()+m.slice(1)).style.display = m===mode ? '' : 'none';
  });
  const descs = {setlist:'å…¬æ¼”ã‚’é¸ã‚“ã§ã‚»ãƒˆãƒªã‚’ç¢ºèªã—ã¾ã™', analyze:'é¸æŠã—ãŸå…¬æ¼”ã®æ¥½æ›²å‚¾å‘ã‚’åˆ†æã—ã¾ã™', compare:'2ã‚°ãƒ«ãƒ¼ãƒ—ã«åˆ†ã‘ã¦æ¥½æ›²å‚¾å‘ã‚’æ¯”è¼ƒã—ã¾ã™'};
  document.getElementById('evModeDesc').textContent = descs[mode];
}

// ã‚»ãƒˆãƒªè¡¨ç¤ºï¼ˆ1å…¬æ¼”é¸æŠæ™‚ã«è‡ªå‹•è¡¨ç¤ºï¼‰
async function showSetlist(evKey_) {
  const ev = evAllEvents.find(e => e.key === evKey_);
  if(!ev) return;
  showLoading(true);
  try {
    const rows = await fetchSheet(ev.year);
    // åŒæ—¥ãƒ»åŒã‚¿ã‚¤ãƒˆãƒ«ã®è¡Œã‚’æŠ½å‡º
    const songs = [];
    rows.slice(2).forEach(row => {
      if(!isDataRow(row)) return;
      const d = parseDate(row[C.date]); if(!d) return;
      const ds = d.toISOString().slice(0,10);
      const k = evKey(ev.year, row[C.title]||'', ds);
      if(k !== evKey_) return;
      if(!row[C.rawSong]?.trim()) return;
      songs.push({
        name: row[C.rawSong].trim(),
        isFirst: !!(row[C.isFirst]?.trim()),
        isLast: !!(row[C.isLast]?.trim())
      });
    });

    document.getElementById('setlistEmpty').style.display = 'none';
    document.getElementById('setlistDisplay').style.display = '';
    document.getElementById('setlistTitle').textContent = ev.title;
    document.getElementById('setlistMeta').textContent = `${ev.dateStr}${ev.venue ? ' Â· '+ev.venue : ''}${ev.pref ? ' ğŸ“'+ev.pref : ''}`;

    if(songs.length) {
      document.getElementById('setlistSongs').innerHTML = songs.map((s,i) => `
        <div class="setlist-item ${s.isFirst?'is-first':''} ${s.isLast?'is-last':''}">
          <span class="setlist-num">${i+1}</span>
          <span class="setlist-name">${s.name}</span>
          ${s.isFirst ? '<span class="setlist-tag opener">1æ›²ç›®</span>' : ''}
          ${s.isLast ? '<span class="setlist-tag closer">ãƒˆãƒª</span>' : ''}
        </div>`).join('');
    } else {
      document.getElementById('setlistSongs').innerHTML = '<div style="color:var(--text-muted);font-size:12px;padding:8px;">ã‚»ãƒˆãƒªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
    }
  } catch(e) { console.error(e); }
  finally { showLoading(false); }
}

// å…¬æ¼”é¸æŠæ™‚ã«ã‚»ãƒˆãƒªã‚’è‡ªå‹•è¡¨ç¤ºï¼ˆã‚»ãƒˆãƒªãƒ¢ãƒ¼ãƒ‰é™å®šï¼‰
function onEvSelectionChange() {
  if(currentEventMode === 'setlist' && evSelected.size === 1) {
    showSetlist([...evSelected][0]);
  } else if(currentEventMode === 'setlist' && evSelected.size !== 1) {
    document.getElementById('setlistDisplay').style.display = 'none';
    document.getElementById('setlistEmpty').style.display = '';
    document.getElementById('setlistEmpty').innerHTML = evSelected.size === 0
      ? '<div style="font-size:32px;margin-bottom:8px;">ğŸµ</div>å…¬æ¼”ã‚’1ã¤é¸æŠã—ã¦ãã ã•ã„'
      : `<div style="font-size:32px;margin-bottom:8px;">ğŸµ</div>${evSelected.size}ä»¶é¸æŠä¸­ã€‚ã‚»ãƒˆãƒªç¢ºèªã¯1ä»¶ãšã¤é¸æŠã—ã¦ãã ã•ã„`;
  }
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
document.getElementById('drillModal').addEventListener('click',e=>{if(e.target===document.getElementById('drillModal')) closeDrill();});
</script>
</body>
</html>
